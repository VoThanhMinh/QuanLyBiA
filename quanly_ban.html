<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý bàn - PHẦN MỀM QUẢN LÝ QUÁN BI-A</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
    // Nếu trong sessionStorage không có mục 'isLoggedIn' với giá trị 'true'
    // Lập tức chuyển hướng người dùng về trang đăng nhập
    if (sessionStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'login.html';
    }
    </script>
    <style>
        /* ===================== BẮT ĐẦU: CSS CHO KHU VỰC ĐẦU TRANG (TAB + DASHBOARD) ===================== */

/* Wrapper mới để chứa tab và dashboard */
.panel-top-section {
    display: flex;
    justify-content: space-between; /* Đẩy 2 phần tử ra 2 bên */
    align-items: center; /* Căn giữa theo chiều dọc */
    margin-bottom: 20px;
    border-bottom: 2px solid #e0e0e0; /* Chuyển đường viền từ tab-nav ra ngoài */
}

/* Sửa lại thanh Tab */
.tab-nav {
    border-bottom: none; /* Bỏ đường viền cũ */
    margin-bottom: 0; /* Bỏ margin cũ */
}

/* Sửa lại Quick Dashboard để hiển thị trên một hàng */
.quick-dashboard {
    display: flex; /* Chuyển sang flex để hiển thị trên một hàng */
    gap: 15px;
    margin-bottom: 0; /* Bỏ margin cũ */
}

.dashboard-card {
    background-color: #fff;
    padding: 10px 15px; /* Điều chỉnh lại padding cho gọn hơn nữa */
    border-radius: 8px;
    box-shadow: none; /* Bỏ shadow để trông phẳng và hợp với thanh tab */
    border: 1px solid #e0e0e0; /* Thêm viền nhẹ */
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 150px; /* Đặt chiều rộng tối thiểu */
}

.dashboard-card .icon {
    font-size: 20px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    flex-shrink: 0;
}

.dashboard-card .info h4 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.dashboard-card .info p {
    margin: 0;
    font-size: 12px;
    color: #666;
}

/* Màu sắc icon giữ nguyên */
.dashboard-card .icon.total { background-color: var(--primary-color); }
.dashboard-card .icon.playing { background-color: var(--danger-color, #ef5350); }
.dashboard-card .icon.empty { background-color: var(--success-color, #4CAF50); }
.dashboard-card .icon.reserved { background-color: var(--warning-color, #fb8c00); }

/* ===================== KẾT THÚC: CSS CHO KHU VỰC ĐẦU TRANG ===================== */
        /* ===================== BIẾN FONT VÀ MÀU SẮC ===================== */
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #1976d2;
            --text-color: #333;
            --light-text-color: #f0f4f8;
            --background-color: #eef2f6;
            --card-background: #ffffff;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-dark: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        /* ===================== GLOBAL STYLES ===================== */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden; /* Ngăn chặn thanh cuộn ngang */
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .content-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
             overflow-x: hidden;
            display: flex;
            
        }
        /* Thêm đoạn mã mới này */
.main-content.sidebar-active {
    gap: 20px;
}

        .main-panel {
            flex-grow: 1;
            background-color: var(--card-background);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            transition: margin-right 0.35s ease-in-out;
        }

        /* ===================== THANH ĐIỀU HƯỚNG TAB ===================== */
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab-nav button {
            background-color: transparent;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #999;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-nav button.active {
            color: var(--primary-color);
            font-weight: 600;
        }

        .tab-nav button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary-color);
        }

        .tab-content {
            flex-grow: 1;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===================== KHU VỰC BÀN ===================== */
        .table-area h2 {
            color: var(--primary-color);
            margin-top: 0;
            font-size: 28px;
            font-weight: 600;
        }

        .table-area p {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }

      .table-grid {
    display: grid; /* << THAY ĐỔI QUAN TRỌNG */
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* << THAY ĐỔI QUAN TRỌNG */
    gap: 20px;
    flex-grow: 1; /* Giữ nguyên */
}

        .table-card {
    background-color: var(--card-background);
    border-radius: 12px;
    box-shadow: var(--shadow-dark);
    padding: 15px;
    text-align: center;
    transition: transform 0.2s ease, border-color 0.2s ease;
    cursor: pointer;
    border: 2px solid transparent;
    position: relative;
    
    /* THAY ĐỔI: Chuyển từ min-height sang height để khóa cứng chiều cao */
    display: flex;
    flex-direction: column;
    justify-content: center;
}
        
        .table-card:hover, .table-card.selected {
            transform: translateY(-5px);
            border-color: var(--primary-color);
        }
        /* Thêm vào khu vực CSS của .table-card */
.table-card.status-co-khach-sap-toi { 
    background-color: #fff8e1; /* Màu vàng nhạt */
    border-color: #fb8c00; /* Màu vàng đậm */
}

        /* Cập nhật các lớp trạng thái để đồng bộ với JS */
        .table-card.status-trống { background-color: #e8f5e9; }
        .table-card.status-đang-chơi {
            background-color: #ef5350;
            color: white;
        }
        .table-card.status-đã-đặt { background-color: #ffebee; }
        
        .table-number {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        /* Cập nhật lớp cho số bàn */
        .table-card.status-đang-chơi .table-number {
            color: white;
        }
        .table-card.status-đang-chơi .table-info,
        .table-card.status-đang-chơi .table-time,
        .table-card.status-đang-chơi .table-price {
            color: #fff;
            font-weight: 500;
        }

        .table-time {
            font-size: 14px;
            color: #666;
        }

        .table-info {
            font-size: 14px;
            color: #666;
        }
        
        .table-card.status-đang-chơi .table-time {
            font-weight: 600;
            font-size: 14px;
            margin-top: 5px;
        }

        .table-card.status-đang-chơi .table-price {
            font-size: 16px;
            font-weight: 700;
            margin-top: 10px;
        }

        /* === MỚI: CSS QUẢN LÝ BÀN === */
        .table-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .table-card-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px;
            border-radius: 8px;
        }
        .table-card-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #555;
            transition: color 0.2s;
        }
        .table-card-actions button:hover {
            color: var(--primary-color);
        }
        .table-card.status-đang-chơi .table-card-actions,
        .table-card.status-đã-đặt .table-card-actions {
            display: none; /* Ẩn nút sửa/xóa khi bàn đang bận */
        }

        /* ===================== KHU VỰC THỰC ĐƠN ===================== */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .menu-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-dark);
        }

        .menu-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .menu-item .item-name {
            font-size: 14px;
            font-weight: 500;
        }

        .menu-item .item-price {
            font-size: 12px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        /* === MỚI: CSS CHO SẢN PHẨM HẾT HÀNG === */
        .menu-item.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f0f0f0;
        }
        .menu-item.out-of-stock:hover {
            transform: none;
            box-shadow: none;
        }
        /* ========================================= */

        /* === MỚI: CSS CHO KHU VỰC THÔNG TIN KHÁCH HÀNG TRÊN HÓA ĐƠN === */
.customer-info-area {
    background-color: #f0f4f8;
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.customer-info-area p {
    margin: 0;
    font-size: 14px;
}
.customer-info-area p .name {
    font-weight: 600;
    color: var(--primary-color);
}
.customer-info-area .btn-link {
    background: none;
    border: none;
    color: var(--secondary-color);
    text-decoration: underline;
    cursor: pointer;
    font-size: 14px;
}


       /* ===================== SIDEBAR HÓA ĐƠN (ĐÃ THIẾT KẾ LẠI) ===================== */
        /* TÌM VÀ THAY THẾ TOÀN BỘ KHỐI CSS NÀY */

/* THAY THẾ TOÀN BỘ .bill-sidebar và .bill-sidebar.show BẰNG KHỐI NÀY */
.bill-sidebar {
    width: 0;
    min-width: 0;
    background-color: var(--card-background);
    border-radius: 12px;
    box-shadow: 0 0 25px rgba(0,0,0,0.15);
    padding: 0;
    z-index: 999;
    overflow: hidden;
    opacity: 0;
    white-space: nowrap;
    transition: all 0.35s ease-in-out;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.main-content.sidebar-active .bill-sidebar {
    width: 400px;
    min-width: 400px;
    padding: 20px;
    opacity: 1;
}

       .bill-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
}

        .bill-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-weight: 600;
        }

        .bill-header span {
            font-size: 14px;
            color: #666;
        }

        .bill-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        #bill-details-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }


        .bill-details h4 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .bill-item-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }

        .bill-item {
            display: grid;
            grid-template-columns: 1fr 50px 70px 30px;
            gap: 10px;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .bill-item:last-child {
            border-bottom: none;
        }

        .bill-item .item-name {
            font-weight: 500;
        }

        .bill-item .item-qty input {
            width: 40px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .bill-item .item-total {
            text-align: right;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .bill-item .delete-btn {
            background-color: transparent;
            border: none;
            color: #e57373;
            cursor: pointer;
            padding: 0;
            height: 100%;
        }

        .bill-item .delete-btn i {
            font-size: 16px;
        }

        .bill-summary {
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px; /* SỬA LỖI KHOẢNG TRẮNG TRÊN KHUNG TỔNG CỘNG */
        }


        .bill-summary p {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 15px;
        }

        .bill-summary p.total {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
        }

        .bill-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .bill-actions.has-print {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .bill-actions.has-print button:last-child {
            grid-column: span 2;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--light-text-color);
        }

        .btn-primary:hover {
            background-color: #0b3a82;
        }

        .btn-secondary {
            background-color: var(--background-color);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: #d1d8df;
        }

        .btn-danger {
            background-color: #ef5350;
            color: #fff;
        }
        .btn-danger:hover {
            background-color: #d32f2f;
        }

        /* === SỬA ĐỔI: CSS MODAL CHUNG === */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-dark);
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .modal-header h4 {
            margin: 0;
            color: var(--primary-color);
        }

        .modal-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-table-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .modal-table-list .table-card {
            padding: 15px;
        }

        /* === MỚI: CSS NHÓM FORM CHO MODAL === */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-family: 'Poppins', sans-serif;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Hộp thông báo */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
        }

        /* Danh sách hóa đơn đã lưu */
        .saved-bills-area {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: var(--shadow-light);
        }

        .saved-bills-area h4 {
            color: var(--primary-color);
        }

        .saved-bills-list {
            list-style: none;
            padding: 0;
        }

        .saved-bills-list li {
            padding: 10px;
            border-bottom: 1px dashed #ddd;
            font-size: 14px;
        }
        
        .saved-bills-list li a {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 600;
        }
        .saved-bills-list li a:hover {
            text-decoration: underline;
        }

        /* Phân trang */
        .pagination-container {
            margin-top: 20px;
            text-align: center;
        }
        .pagination-btn {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 12px;
            margin: 0 4px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .pagination-btn:hover {
            background-color: var(--primary-color);
            color: var(--light-text-color);
        }
        .pagination-btn.active {
            background-color: var(--primary-color);
            color: var(--light-text-color);
        }

        /* ===================== HEADER & FOOTER ===================== */
        .main-header {
            background-color: var(--card-background);
            box-shadow: var(--shadow-light);
            height: 70px;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
        }

        .main-header .app-name {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .main-header .app-name i {
            color: var(--secondary-color);
        }

        .main-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
        }

        .main-nav li {
            position: relative;
            margin: 0 5px;
        }

        .main-nav a {
            text-decoration: none;
            color: var(--text-color);
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .main-nav a i {
            font-size: 18px;
            color: var(--secondary-color);
        }

        .main-nav a:hover,
        .main-nav li.active a {
            background-color: var(--background-color);
            color: var(--primary-color);
        }

        .main-nav li.active a i {
            color: var(--primary-color);
        }

        /* Dropdown Menu */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: var(--shadow-dark);
            min-width: 220px;
            z-index: 99;
            list-style: none;
            padding: 10px 0;
            margin-top: 10px;
            transform: translateY(10px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .has-dropdown:hover .dropdown-menu {
            display: block;
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .dropdown-menu a {
            padding: 12px 20px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-color);
            border-radius: 0;
            font-size: 14px;
        }

        .dropdown-menu a:hover,
        .dropdown-menu a.active {
            background-color: var(--background-color);
            color: var(--primary-color);
        }

        .dropdown-menu a i {
            font-size: 16px;
            color: var(--secondary-color);
        }

        .dropdown-menu a.active i {
            color: var(--primary-color);
        }

        .main-footer {
            background-color: var(--primary-color);
            color: var(--light-text-color);
            padding: 20px 30px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        }

        .footer-info, .user-info {
            display: flex;
            gap: 25px;
        }

        .main-footer i {
            color: var(--light-text-color);
            margin-right: 5px;
        }

        /* CSS cho bản in */
        @media print {
            body * {
                visibility: hidden;
            }
            .bill-to-print, .bill-to-print * {
                visibility: visible;
            }
            .bill-to-print {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }
            .bill-to-print .bill-summary {
                background-color: #f0f4f8 !important;
                -webkit-print-color-adjust: exact;
            }
            .bill-to-print h3, .bill-to-print h4 {
                color: var(--primary-color) !important;
                -webkit-print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

<script>
    // *** BẮT ĐẦU: ĐOẠN MÃ KIỂM TRA QUYỀN TRUY CẬP TRANG (ĐÃ NÂNG CẤP) ***
    (function() {
        const PAGE_FEATURE_ID = 'quanly_ban';
        const userRole = sessionStorage.getItem('userRole');
        
        if (userRole === 'user') {
            const permissions = JSON.parse(localStorage.getItem('biaOxuUserPermissions')) || {};
            // Kiểm tra quyền truy cập chi tiết
            const hasPermission = permissions[PAGE_FEATURE_ID] && permissions[PAGE_FEATURE_ID].access === true;

            if (!hasPermission) {
                document.body.style.display = 'none';
                alert('Bạn không có quyền truy cập chức năng này.');
                window.location.href = 'index.html';
            }
        }
    })();
    // *** KẾT THÚC: ĐOẠN MÃ KIỂM TRA QUYỀN TRUY CẬP TRANG ***
</script>
    
    <div class="app-container">
        <header class="main-header">
            <a href="index.html" style="text-decoration: none;">
                <h1 class="app-name"><i class="fa-solid fa-gem"></i> BI-A OXU</h1>
            </a>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class="fa-solid fa-chart-line"></i> Trang chủ</a></li>
                    <li class="has-dropdown active">
                        <a href="#"><i class="fa-solid fa-boxes-stacked"></i> Quản lý</a>
                        <ul class="dropdown-menu">
    <li><a href="quanly_ban.html"><i class="fa-solid fa-table-tennis-paddle-ball"></i> Quản lý bàn</a></li>
    <li><a href="quanly_khachhang.html"><i class="fa-solid fa-address-book"></i> Quản lý Khách hàng</a></li>
    <li><a href="quanly_datban.html"><i class="fa-solid fa-calendar-check"></i> Quản lý Đặt bàn</a></li>
    <li><a href="quanly_thuchi.html"><i class="fa-solid fa-cash-register"></i> Quản lý thu chi</a></li>
    <li><a href="quanly_kho.html"><i class="fa-solid fa-box-open"></i> Quản lý kho</a></li>
    <li><a href="quanly_nhanvien.html"><i class="fa-solid fa-users"></i> Quản lý nhân viên</a></li>
</ul>
                    </li>
                    <li class="has-dropdown">
                        <a href="#"><i class="fa-solid fa-chart-pie"></i> Báo cáo</a>
                        <ul class="dropdown-menu">
                            <li><a href="baocao_doanhthu.html"><i class="fa-solid fa-file-invoice"></i> Doanh thu ngày</a></li>
                            <li><a href="baocao_thongke.html"><i class="fa-solid fa-chart-bar"></i> Thống kê tuần</a></li>
                            <li><a href="baocao_loinhuan.html"><i class="fa-solid fa-file-contract"></i> Báo cáo nhân viên</a></li>
                             <li><a href="baocao_khachhang.html"><i class="fa-solid fa-user-tag"></i> Phân tích Khách hàng</a></li>
                        </ul>
                    </li>
                    <li><a href="cai_dat.html"><i class="fa-solid fa-gear"></i> Cài đặt</a></li>
                    <li><a href="tro_giup.html"><i class="fa-solid fa-circle-question"></i> Trợ giúp</a></li>
                    <li><a href="#" id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a></li>
                </ul>
            </nav>
        </header>

        <div class="content-wrapper">
            <main class="main-content">
                <div class="main-panel">
    <div class="panel-top-section">
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="table-tab"><i class="fa-solid fa-table"></i> Bàn / Phòng</button>
            <button class="tab-btn" data-tab="menu-tab"><i class="fa-solid fa-utensils"></i> Thực đơn</button>
            <button class="tab-btn" data-tab="saved-bills-tab"><i class="fa-solid fa-receipt"></i> Hóa đơn đã lưu</button>
        </div>

        <div class="quick-dashboard">
            <div class="dashboard-card">
                <div class="icon total"><i class="fa-solid fa-table-tennis-paddle-ball"></i></div>
                <div class="info">
                    <h4 id="db-total-tables">0</h4>
                    <p>Tổng số bàn</p>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="icon playing"><i class="fa-solid fa-person-running"></i></div>
                <div class="info">
                    <h4 id="db-playing-tables">0</h4>
                    <p>Đang chơi</p>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="icon empty"><i class="fa-solid fa-check"></i></div>
                <div class="info">
                    <h4 id="db-empty-tables">0</h4>
                    <p>Còn trống</p>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="icon reserved"><i class="fa-solid fa-calendar-check"></i></div>
                <div class="info">
                    <h4 id="db-reserved-tables">0</h4>
                    <p>Đã đặt</p>
                </div>
            </div>
        </div>
    </div>

                    <div id="table-tab" class="tab-content active">
                        <div class="table-area">
                            <div class="table-management-header">
                                <div>
                                    <h2>Quản lý Bàn</h2>
                                    <p style="margin-bottom: 0;">Chọn một bàn để xem và quản lý hóa đơn.</p>
                                </div>
                                <button id="add-new-table-btn" class="btn btn-primary" onclick="openTableModal()"><i class="fa-solid fa-plus"></i> Thêm Bàn Mới</button>
                            </div>
                            
                            <div id="zone-tabs-container" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
    </div>
                            <hr>
                            <div class="table-grid" id="table-grid"></div>
                        </div>
                    </div>

                    <div id="menu-tab" class="tab-content">
                        <div class="menu-area">
                            <h2>Thực đơn</h2>
                            <p>Chọn món để thêm vào hóa đơn của bàn đã chọn.</p>
                            <hr>
                            <div class="menu-grid" id="menu-grid"></div>
                        </div>
                    </div>

                    <div id="saved-bills-tab" class="tab-content">
                         <div class="saved-bills-area">
                            <h2>Hóa đơn đã lưu</h2>
                            <p>Đây là danh sách các hóa đơn đã được thanh toán và lưu lại.</p>
                             
                            <div class="bill-filters" style="display: flex; gap: 15px; margin: 20px 0; align-items: center; flex-wrap: wrap;">
                                <input type="text" id="bill-search-input" placeholder="Tìm theo mã HĐ hoặc tên bàn..." style="flex-grow: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; min-width: 250px;">
                                <select id="bill-sort-select" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
                                    <option value="newest">Sắp xếp: Mới nhất</option>
                                    <option value="oldest">Sắp xếp: Cũ nhất</option>
                                    <option value="total-desc">Tổng tiền: Cao nhất</option>
                                    <option value="total-asc">Tổng tiền: Thấp nhất</option>
                                </select>
                            </div>
                            <hr style="margin-top: 0;">
                            <ul id="saved-bills-list" class="saved-bills-list" style="list-style: none; padding: 0;"></ul>
                            <div id="saved-bills-pagination" class="pagination-container"></div>
                        </div>
                    </div>
                </div>

                <div id="bill-sidebar" class="bill-sidebar">
                    <div id="bill-header" class="bill-header">
                        <h3>Vui lòng chọn bàn</h3>
                    </div>
                    <div class="bill-details" id="bill-details-content"></div>
                </div>
            </main>
        </div>
        
        <div id="table-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 id="table-modal-title">Thêm Bàn Mới</h4>
                    <span class="modal-close" onclick="closeTableModal()">&times;</span>
                </div>
                <form id="table-form" onsubmit="event.preventDefault(); saveTableData();">
                    <input type="hidden" id="table-id-input">
                    <div class="form-group">
                        <label for="table-name-input">Tên bàn</label>
                        <input type="text" id="table-name-input" required placeholder="Ví dụ: Bàn 7">
                    </div>
                    <div class="form-group">
                        <label for="table-price-list-select">Loại bàn (Bảng giá)</label>
                        <select id="table-price-list-select" required></select>
                    </div>
                    <div class="form-group">
    <label for="table-zone-select">Khu vực / Tầng</label>
    <select id="table-zone-select" required>
        </select>
</div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeTableModal()">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="transfer-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Chuyển bàn <span id="current-table-transfer"></span></h4>
                    <span class="modal-close" onclick="document.getElementById('transfer-modal').style.display='none'">&times;</span>
                </div>
                <p>Chọn một bàn trống để chuyển khách.</p>
                <div id="free-tables-list" class="modal-table-list"></div>
            </div>
        </div>

        <div id="adjustment-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="adjustment-modal-title">Thêm Giảm Trừ / Phụ Thu</h4>
            <span class="modal-close" onclick="closeAdjustmentModal()">&times;</span>
        </div>
        <form id="adjustment-form-modal" onsubmit="event.preventDefault(); saveAdjustment();">
            <div class="form-group">
                <label>Loại</label>
                <div style="display: flex; gap: 20px;">
                    <label><input type="radio" name="adj_type" value="discount" checked> Giảm Trừ</label>
                    <label><input type="radio" name="adj_type" value="surcharge"> Phụ Thu</label>
                </div>
            </div>
            <div class="form-group">
                <label>Áp dụng cho</label>
                <div style="display: flex; gap: 20px;">
                    <label><input type="radio" name="adj_apply_to" value="playingCost" checked> Chỉ tiền giờ</label>
                    <label><input type="radio" name="adj_apply_to" value="total"> Toàn bộ hóa đơn</label>
                </div>
            </div>
            <div class="form-group">
                <label>Hình thức</label>
                <div style="display: flex; gap: 20px;">
                    <label><input type="radio" name="adj_method" value="fixed" checked> Số tiền (VNĐ)</label>
                    <label><input type="radio" name="adj_method" value="percentage"> Phần trăm (%)</label>
                </div>
            </div>
            <div class="form-group">
                <label for="adj-value-input">Giá trị</label>
                <input type="number" id="adj-value-input" required placeholder="Nhập số tiền hoặc %">
            </div>
            <div class="form-group">
                <label for="adj-description-input">Nội dung (Lý do)</label>
                <input type="text" id="adj-description-input" required placeholder="Ví dụ: Voucher, Phụ thu lễ...">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAdjustmentModal()">Hủy</button>
                <button type="submit" class="btn btn-primary">Áp dụng</button>
            </div>
        </form>
    </div>
</div>

        <div id="message-box" class="message-box"></div>

        <footer class="main-footer">
            <div class="footer-info">
                <span class="copyright-info"><i class="fa-solid fa-copyright"></i> 2025 BI-A OXU. All rights reserved.</span>
                <span class="phone-info"><i class="fa-solid fa-phone"></i> Hotline: 0902.022.665</span>
            </div>
            <div class="user-info">
                <span id="footer-username"><i class="fa-solid fa-user"></i> Người dùng: </span>
                <span><i class="fa-solid fa-circle-check"></i> Trạng thái: OK</span>
            </div>
        </footer>
    </div>
    <div id="customer-selection-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>Chọn Khách Hàng cho Bàn</h4>
           <span class="modal-close js-close-customer-modal">&times;</span>
        </div>
        <div class="form-group">
            <input type="text" id="customer-search-modal-input" placeholder="Tìm theo tên hoặc SĐT..." style="width: 100%; padding: 10px;">
        </div>
        <div id="customer-selection-list" style="max-height: 300px; overflow-y: auto; border-top: 1px solid #eee; margin-top: 15px;">
            </div>
    </div>
</div>

    <script>
/**
 * Tự động kiểm tra và cập nhật hạng thành viên cho khách hàng dựa trên tổng chi tiêu.
 * @param {object} customer - Đối tượng khách hàng cần kiểm tra.
 * @returns {object|null} - Trả về thông tin hạng mới nếu có nâng hạng, ngược lại trả về null.
 */
function updateCustomerTier(customer) {
    const MEMBERSHIP_TIERS_KEY = 'biaOxuMembershipTiers';
    const storedTiers = localStorage.getItem(MEMBERSHIP_TIERS_KEY);
    if (!storedTiers) return null;

    // Hạng "Thường" là mặc định
    const defaultTier = { id: 'default', name: 'Thường', threshold: 0 };
    const allTiers = [defaultTier, ...JSON.parse(storedTiers)];
    
    // Sắp xếp lại để chắc chắn thứ tự là giảm dần theo ngưỡng
    allTiers.sort((a, b) => b.threshold - a.threshold);

    let newTier = defaultTier;
    // Tìm hạng cao nhất mà khách hàng đạt được
    for (const tier of allTiers) {
        if (customer.totalSpent >= tier.threshold) {
            newTier = tier;
            break; // Vì đã sắp xếp giảm dần, hạng đầu tiên thỏa mãn là hạng cao nhất
        }
    }

    // Kiểm tra xem có sự thay đổi hạng không
    if (newTier.id !== customer.membershipTierId) {
        const oldTierName = (allTiers.find(t => t.id === customer.membershipTierId) || defaultTier).name;
        customer.membershipTierId = newTier.id;
        // Trả về thông tin để hiển thị thông báo
        return { newTierName: newTier.name, oldTierName: oldTierName };
    }

    return null; // Không có sự thay đổi
}
        
      document.addEventListener('DOMContentLoaded', () => {
    // Lấy tên người dùng từ sessionStorage
    const loggedInUser = sessionStorage.getItem('loggedInUser');

    // Nếu có tên người dùng, cập nhật nó vào footer
    if (loggedInUser) {
        const usernameElement = document.getElementById('footer-username');
        if (usernameElement) {
            usernameElement.innerHTML = `<i class="fa-solid fa-user"></i> Người dùng: ${loggedInUser}`;
        }
    }
    // ===============================================
    // ===== PHÂN QUYỀN NÂNG CAO: BẮT ĐẦU =====
    // ===============================================
    const userRole = sessionStorage.getItem('userRole');
    if (userRole === 'user') {
        const permissions = JSON.parse(localStorage.getItem('biaOxuUserPermissions')) || {};
        const tablePermissions = permissions.quanly_ban || {};

        // 1. Ẩn nút "Thêm Bàn Mới"
        const addNewTableBtn = document.getElementById('add-new-table-btn');
        if (addNewTableBtn && tablePermissions.can_add !== true) {
            addNewTableBtn.style.display = 'none';
        }

        // 2. Ẩn tab "Thực đơn"
        const menuTabBtn = document.querySelector('.tab-btn[data-tab="menu-tab"]');
        if (menuTabBtn && tablePermissions.view_tab_menu !== true) {
            menuTabBtn.style.display = 'none';
        }

        // 3. Ẩn tab "Hóa đơn đã lưu"
        const savedBillsTabBtn = document.querySelector('.tab-btn[data-tab="saved-bills-tab"]');
        if (savedBillsTabBtn && tablePermissions.view_tab_saved_bills !== true) {
            savedBillsTabBtn.style.display = 'none';
        }
    }
    // ===============================================
    // ===== PHÂN QUYỀN NÂNG CAO: KẾT THÚC =====
    // ===============================================

    const TABLES_STORAGE_KEY = 'biaOxuTables';
    const SAVED_BILLS_STORAGE_KEY = 'biaOxuSavedBills';
    const INVENTORY_STORAGE_KEY = 'biaOxuMenuItems';
    const PRICE_LIST_STORAGE_KEY = 'biaOxuPriceLists';
    const HOLIDAY_STORAGE_KEY = 'biaOxuHolidays';
    const ZONES_STORAGE_KEY = 'biaOxuZones'; // MỚI
    // === BẮT ĐẦU NÂNG CẤP ===
const CUSTOMERS_STORAGE_KEY = 'biaOxuCustomers'; 
// === KẾT THÚC NÂNG CẤP ===

    let tables = {};
    let savedBills = [];
    let menuItems = JSON.parse(localStorage.getItem(INVENTORY_STORAGE_KEY)) || [];
    let priceLists = {};
    let holidays = [];

    let selectedTableId = null;
    let globalTableTimer = null;
    let selectedZone = 'all'; // MỚI: Mặc định hiển thị tất cả

    // =======================================================
// ===== BẮT ĐẦU: CODE TỰ ĐỘNG CẬP NHẬT GIỮA CÁC TAB =====
// =======================================================

window.addEventListener('storage', function(event) {
    // Sự kiện này được kích hoạt khi localStorage thay đổi ở một tab khác.
    
    console.log('Phát hiện thay đổi từ tab khác:', event.key);

    // Kiểm tra xem dữ liệu bị thay đổi có phải là dữ liệu bàn hoặc lịch đặt không
    if (event.key === TABLES_STORAGE_KEY || event.key === BOOKINGS_STORAGE_KEY) {
        
        // 1. Tải lại dữ liệu mới nhất từ localStorage
        // Dùng try-catch để phòng trường hợp dữ liệu bị lỗi khi đang ghi/xóa
        try {
            const updatedTables = JSON.parse(localStorage.getItem(TABLES_STORAGE_KEY));
            if (updatedTables) {
                tables = updatedTables;
            }
        } catch (e) {
            console.error('Lỗi khi đọc lại dữ liệu bàn:', e);
        }

        // 2. Vẽ lại giao diện các bàn với dữ liệu mới
        // Hàm renderTableCards() sẽ tự động đọc lại cả dữ liệu booking
        showMessage('Dữ liệu bàn đã được cập nhật từ một tab khác!', 'success');
        renderTableCards();
        
        // 3. Cập nhật lại hóa đơn nếu bàn đang được chọn bị thay đổi
        if(selectedTableId && tables[selectedTableId]) {
            populateSidebar(tables[selectedTableId]);
        } else {
            // Nếu bàn đang chọn bị xóa ở tab khác, hãy ẩn sidebar đi
            billSidebar.classList.remove('show');
            selectedTableId = null;
        }
    }
});

// ===================================================
// ===== KẾT THÚC: CODE TỰ ĐỘNG CẬP NHẬT =====
// ===================================================

    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const tableGrid = document.getElementById('table-grid');
    const billSidebar = document.getElementById('bill-sidebar');
    const billHeader = document.getElementById('bill-header');
    const billDetailsContent = document.getElementById('bill-details-content');
    // =========================================================
    // ===== BẮT ĐẦU: CODE LẮNG NGHE SỰ KIỆN CHO NÚT CHỌN KHÁCH HÀNG =====
    // =========================================================
    billDetailsContent.addEventListener('click', function(event) {
        // Kiểm tra xem phần tử được nhấp có phải là nút "Chọn" hoặc "Thay đổi" không
        if (event.target.matches('.js-open-customer-modal')) {
            // Nếu đúng là nút đó và đã có một bàn đang được chọn
            if (selectedTableId) {
                openCustomerSelectionModal(selectedTableId);
            }
        }
    });
    // =========================================================
    // ===== KẾT THÚC: CODE LẮNG NGHE SỰ KIỆN =====
    // =========================================================
    const customerModal = document.getElementById('customer-selection-modal');
    if (customerModal) {
        customerModal.addEventListener('click', function(event) {
            // Kiểm tra xem có phải người dùng nhấn vào nút X không
            if (event.target.matches('.js-close-customer-modal')) {
                closeCustomerSelectionModal();
            }
        });
    }
    const menuGrid = document.getElementById('menu-grid');
    const transferModal = document.getElementById('transfer-modal');
    const tableModal = document.getElementById('table-modal');
    const freeTablesList = document.getElementById('free-tables-list');
    const messageBox = document.getElementById('message-box');
    const savedBillsList = document.getElementById('saved-bills-list');
    
    // === MỚI: Lấy phần tử modal giảm trừ/phụ thu
    const adjustmentModal = document.getElementById('adjustment-modal');
    
    let currentPage = 1;
    const billsPerPage = 10;
    
    function renderPaginationButtons(totalBills) {
        const totalPages = Math.ceil(totalBills / billsPerPage);
        const paginationContainer = document.getElementById('saved-bills-pagination');
        paginationContainer.innerHTML = '';

        if (totalPages > 1) {
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = 'pagination-btn';
                if (i === currentPage) {
                    button.classList.add('active');
                }
                button.addEventListener('click', () => {
                    currentPage = i;
                    renderSavedBills();
                });
                paginationContainer.appendChild(button);
            }
        }
    }
    
    function saveDataToLocalStorage() {
        localStorage.setItem(TABLES_STORAGE_KEY, JSON.stringify(tables));
        localStorage.setItem(SAVED_BILLS_STORAGE_KEY, JSON.stringify(savedBills));
    }
    // === BẮT ĐẦU: HÀM MỚI ĐỂ RENDER CÁC TAB KHU VỰC ===
/**
 * Render các tab (nút bấm) để lọc bàn theo khu vực. (PHIÊN BẢN NÂNG CẤP)
 */
function renderZoneTabs() {
    const zones = JSON.parse(localStorage.getItem(ZONES_STORAGE_KEY)) || [];
    const container = document.getElementById('zone-tabs-container');
    container.innerHTML = ''; // Xóa các tab cũ

    // Luôn có nút "Tất cả"
    const allBtn = document.createElement('button');
    allBtn.textContent = 'Tất cả';
    allBtn.className = 'btn btn-secondary';
    if (selectedZone === 'all') {
        allBtn.classList.replace('btn-secondary', 'btn-primary');
    }
    allBtn.onclick = () => {
        selectedZone = 'all';
        renderZoneTabs();
        renderTableCards();
    };
    container.appendChild(allBtn);

    // Render các nút cho từng khu vực
    zones.forEach(zone => {
        const zoneBtn = document.createElement('button');
        zoneBtn.textContent = zone;
        zoneBtn.className = 'btn btn-secondary';
        if (selectedZone === zone) {
            zoneBtn.classList.replace('btn-secondary', 'btn-primary');
        }
        zoneBtn.onclick = () => {
            selectedZone = zone;
            renderZoneTabs();
            renderTableCards();
        };
        container.appendChild(zoneBtn);
    });

    // === BẮT ĐẦU: THÊM NÚT QUẢN LÝ KHU VỰC MỚI ===
    const manageBtn = document.createElement('button');
    manageBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Quản lý';
    manageBtn.className = 'btn btn-secondary';
    manageBtn.style.borderStyle = 'dashed'; // Làm cho nó khác biệt
    manageBtn.onclick = openZoneManagementModal; // Gọi hàm mở modal
    container.appendChild(manageBtn);
    // === KẾT THÚC: THÊM NÚT QUẢN LÝ KHU VỰC MỚI ===
}

// === BẮT ĐẦU: CÁC HÀM MỚI CHO VIỆC QUẢN LÝ KHU VỰC ĐỘNG (ĐÃ SỬA LỖI) ===

/**
 * Mở cửa sổ quản lý khu vực
 */
window.openZoneManagementModal = function() {
    document.getElementById('zone-management-modal').style.display = 'flex';
    document.getElementById('zone-form').reset(); // Xóa form
    document.getElementById('zone-edit-index-input').value = ''; // Reset trạng thái sửa
    renderExistingZones(); // Vẽ lại danh sách khu vực
}

/**
 * Đóng cửa sổ quản lý khu vực
 */
window.closeZoneManagementModal = function() {
    document.getElementById('zone-management-modal').style.display = 'none';
}

/**
 * Hiển thị danh sách các khu vực hiện có trong modal
 */
function renderExistingZones() {
    const zones = JSON.parse(localStorage.getItem(ZONES_STORAGE_KEY)) || [];
    const listContainer = document.getElementById('existing-zones-list');
    listContainer.innerHTML = '';

    if (zones.length === 0) {
        listContainer.innerHTML = '<p style="text-align: center; color: #888;">Chưa có khu vực nào.</p>';
        return;
    }

    zones.forEach((zone, index) => {
        const item = document.createElement('div');
        item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;';
        item.innerHTML = `
            <span>${zone}</span>
            <div>
                <button class="btn-link" onclick="editZone(${index})" style="margin-right: 15px; font-size: 14px;">Sửa</button>
                <button class="btn-link" onclick="deleteZone(${index})" style="color: #d32f2f; font-size: 14px;">Xóa</button>
            </div>
        `;
        listContainer.appendChild(item);
    });
}

/**
 * Lưu một khu vực (cả thêm mới và chỉnh sửa)
 */
window.saveZone = function() {
    const zoneNameInput = document.getElementById('zone-name-input');
    const editIndexInput = document.getElementById('zone-edit-index-input');
    const newName = zoneNameInput.value.trim();
    const editIndex = editIndexInput.value;

    if (!newName) {
        showMessage('Tên khu vực không được để trống!', 'error');
        return;
    }

    let zones = JSON.parse(localStorage.getItem(ZONES_STORAGE_KEY)) || [];

    // Kiểm tra tên trùng lặp
    const isDuplicate = zones.some((zone, index) => zone.toLowerCase() === newName.toLowerCase() && index != editIndex);
    if (isDuplicate) {
        showMessage('Tên khu vực này đã tồn tại!', 'error');
        return;
    }

    if (editIndex !== '') {
        // Chế độ sửa
        zones[editIndex] = newName;
        showMessage('Cập nhật khu vực thành công!');
    } else {
        // Chế độ thêm mới
        zones.push(newName);
        showMessage('Thêm khu vực mới thành công!');
    }

    localStorage.setItem(ZONES_STORAGE_KEY, JSON.stringify(zones));

    // Dọn dẹp và cập nhật lại giao diện
    zoneNameInput.value = '';
    editIndexInput.value = '';
    zoneNameInput.focus();
    renderExistingZones(); // Cập nhật danh sách trong modal
    renderZoneTabs();     // Cập nhật các nút lọc ở màn hình chính
}

/**
 * Chuẩn bị form để sửa tên một khu vực
 * @param {number} index - Vị trí của khu vực trong mảng
 */
window.editZone = function(index) {
    let zones = JSON.parse(localStorage.getItem(ZONES_STORAGE_KEY)) || [];
    document.getElementById('zone-name-input').value = zones[index];
    document.getElementById('zone-edit-index-input').value = index;
    document.getElementById('zone-name-input').focus();
}

/**
 * Xóa một khu vực
 * @param {number} index - Vị trí của khu vực trong mảng
 */
window.deleteZone = function(index) {
    let zones = JSON.parse(localStorage.getItem(ZONES_STORAGE_KEY)) || [];
    const zoneToDelete = zones[index];

    if (confirm(`Bạn có chắc chắn muốn xóa khu vực "${zoneToDelete}"?\nHÀNH ĐỘNG NÀY KHÔNG THỂ HOÀN TÁC!`)) {
        // Kiểm tra xem có bàn nào đang thuộc khu vực này không
        const isZoneInUse = Object.values(tables).some(table => table.zone === zoneToDelete);

        if (isZoneInUse) {
            showMessage(`Không thể xóa khu vực "${zoneToDelete}" vì vẫn còn bàn thuộc khu vực này.`, 'error');
            return;
        }

        zones.splice(index, 1); // Xóa phần tử khỏi mảng
        localStorage.setItem(ZONES_STORAGE_KEY, JSON.stringify(zones));

        // Nếu khu vực đang được chọn bị xóa, thì chuyển về "Tất cả"
        if (selectedZone === zoneToDelete) {
            selectedZone = 'all';
        }

        showMessage(`Đã xóa khu vực "${zoneToDelete}"!`);
        renderExistingZones(); // Cập nhật danh sách trong modal
        renderZoneTabs();     // Cập nhật các nút lọc
        renderTableCards();   // Cập nhật lưới bàn
    }
}

// === KẾT THÚC: CÁC HÀM MỚI CHO VIỆC QUẢN LÝ KHU VỰC ĐỘNG (ĐÃ SỬA LỖI) ===

    function initializeData() {
        const storedTables = localStorage.getItem(TABLES_STORAGE_KEY);
        const storedSavedBills = localStorage.getItem(SAVED_BILLS_STORAGE_KEY);
        
        menuItems = JSON.parse(localStorage.getItem(INVENTORY_STORAGE_KEY)) || [];
        priceLists = JSON.parse(localStorage.getItem(PRICE_LIST_STORAGE_KEY)) || {};
        holidays = JSON.parse(localStorage.getItem(HOLIDAY_STORAGE_KEY)) || [];

        if (storedTables && Object.keys(JSON.parse(storedTables)).length > 0) {
            tables = JSON.parse(storedTables);
            for (const tableId in tables) {
                if (tables[tableId].startTime) {
                    tables[tableId].startTime = new Date(tables[tableId].startTime).getTime();
                }
            }
        } else {
            if (Object.keys(priceLists).length === 0) {
                priceLists['default'] = {
                    name: 'Tiêu chuẩn',
                    basePrice: 50000,
                    timeSlots: [],
                    weekendMultiplier: 1.0,
                    holidayMultiplier: 1.2
                };
                localStorage.setItem(PRICE_LIST_STORAGE_KEY, JSON.stringify(priceLists));
            }
            const defaultPriceListId = Object.keys(priceLists)[0];

            for (let i = 1; i <= 6; i++) {
                tables[i] = {
                    name: `Bàn ${i}`,
                    status: 'Trống',
                    startTime: null,
                    products: [],
                    priceListId: defaultPriceListId,
                    accumulatedCost: 0,
                    accumulatedTime: 0,
                    adjustments: []
                };
            }
            tables[2].status = 'Đang chơi';
            tables[2].startTime = Date.now() - 1530000;
            tables[4].status = 'Đang chơi';
            tables[4].startTime = Date.now() - 4200000;
            tables[5].status = 'Đang chơi';
            tables[5].startTime = Date.now() - 2700000;
            tables[6].status = 'Đã đặt';
            saveDataToLocalStorage();
        }
        // === BẮT ĐẦU: KHỞI TẠO DỮ LIỆU KHU VỰC MỚI ===
const storedZones = localStorage.getItem(ZONES_STORAGE_KEY);
if (!storedZones) {
    const defaultZones = ['Tầng 1', 'Tầng 2', 'Khu VIP'];
    localStorage.setItem(ZONES_STORAGE_KEY, JSON.stringify(defaultZones));
}

// Gán khu vực mặc định cho các bàn chưa có
Object.values(tables).forEach(table => {
    if (!table.zone) {
        table.zone = 'Tầng 1'; // Gán mặc định cho bàn cũ là 'Tầng 1'
    }
});
// === KẾT THÚC: KHỞI TẠO DỮ LIỆU KHU VỰC MỚI ===

        if (storedSavedBills) {
            savedBills = JSON.parse(storedSavedBills);
        } else {
            savedBills = [];
            saveDataToLocalStorage();
        }
    }

    // --- CÁC HÀM TIỆN ÍCH ---
    function generateInvoiceId(tableName) {
        const prefix = 'HD';
        const tableNumberMatch = tableName.match(/\d+/);
        const tableIdentifier = tableNumberMatch ? tableNumberMatch[0] : 'X';
        const uniquePart = String(Math.floor(Math.random() * 100000000)).padStart(8, '0');
        return `${prefix}-${tableIdentifier}-${uniquePart}`;
    }

    function showMessage(msg, type = 'success') {
        messageBox.textContent = msg;
        messageBox.style.backgroundColor = type === 'error' ? '#f44336' : '#4caf50';
        messageBox.style.display = 'block';
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 3000);
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(Math.round(amount));
    }

    // ======================================================
// ===== BẮT ĐẦU: CODE HỖ TRỢ CHỨC NĂNG ĐẶT BÀN =====
// ======================================================

/**
 * Xử lý tự động check-in khi được chuyển hướng từ trang đặt bàn.
 * Hàm này sẽ đọc tham số trên URL để biết cần check-in cho bàn nào.
 */
// THAY THẾ HOẶC THÊM MỚI HÀM NÀY
function handleAutoCheckinFromBooking() {
    // 1. Lấy tham số từ URL
    const params = new URLSearchParams(window.location.search);
    const action = params.get('action');
    const bookingId = params.get('bookingId');

    // 2. Kiểm tra nếu đúng là hành động check-in
    if (action === 'checkin' && bookingId) {
        const BOOKINGS_STORAGE_KEY = 'biaOxuBookings';
        let bookings = JSON.parse(localStorage.getItem(BOOKINGS_STORAGE_KEY)) || [];
        const bookingIndex = bookings.findIndex(b => b.id === bookingId);

        if (bookingIndex === -1) {
            showMessage('Không tìm thấy lịch đặt bàn!', 'error');
            return;
        }

        const booking = bookings[bookingIndex];
        const table = tables[booking.tableId];

        // 3. Kiểm tra xem bàn có sẵn sàng để check-in không (Trống hoặc Đã đặt)
        if (!table || (table.status !== 'Trống' && table.status !== 'Đã đặt')) {
            showMessage(`Không thể check-in. ${table.name} hiện đang ${table.status}.`, 'error');
            return;
        }

        // 4. Bắt đầu tính giờ cho bàn
        table.status = 'Đang chơi';
        table.startTime = Date.now();
        table.products = [];
        table.accumulatedCost = 0;
        table.accumulatedTime = 0;
        table.adjustments = [];
        table.customerId = booking.customerId || null; 

        // 5. Cập nhật trạng thái của lịch đặt thành 'Completed'
        bookings[bookingIndex].status = 'Completed';
        localStorage.setItem(BOOKINGS_STORAGE_KEY, JSON.stringify(bookings));

        // 6. Lưu lại trạng thái mới của các bàn và hiển thị
        saveDataToLocalStorage();
        showMessage(`Check-in thành công! Bàn ${table.name} đã bắt đầu tính giờ.`);
        renderTableCards();
        selectAndShowBill(booking.tableId); // Tự động chọn bàn vừa check-in

        // 7. Xóa tham số trên URL để tránh check-in lại khi tải lại trang
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}
// ======================================================
// ===== BẮT ĐẦU: HÀM CẬP NHẬT BẢNG ĐIỀU KHIỂN NHANH =====
// ======================================================
function updateQuickDashboard() {
    const totalTables = Object.keys(tables).length;
    let playingTables = 0;
    let emptyTables = 0;
    let reservedTables = 0;

    for (const tableId in tables) {
        switch (tables[tableId].status) {
            case 'Đang chơi':
                playingTables++;
                break;
            case 'Trống':
                emptyTables++;
                break;
            case 'Đã đặt':
                reservedTables++;
                break;
        }
    }

    document.getElementById('db-total-tables').innerText = totalTables;
    document.getElementById('db-playing-tables').innerText = playingTables;
    document.getElementById('db-empty-tables').innerText = emptyTables;
    document.getElementById('db-reserved-tables').innerText = reservedTables;
}
// ====================================================
// ===== KẾT THÚC: HÀM CẬP NHẬT BẢNG ĐIỀU KHIỂN =====
// ====================================================

function renderTableCards() {
    tableGrid.innerHTML = '';
    const sortedTableIds = Object.keys(tables).sort((a, b) => {
        const nameA = tables[a].name.toUpperCase();
        const nameB = tables[b].name.toUpperCase();
        const numA = parseInt(nameA.match(/\d+/g));
        const numB = parseInt(nameB.match(/\d+/g));
        if (numA && numB) return numA - numB;
        return nameA.localeCompare(nameB);
    });

    const BOOKINGS_STORAGE_KEY = 'biaOxuBookings';
    const bookings = JSON.parse(localStorage.getItem(BOOKINGS_STORAGE_KEY)) || [];
    const now = new Date();
    const upcomingBookings = bookings.filter(b => b.status === 'Confirmed' && new Date(b.bookingTime) > now);

    const permissions = JSON.parse(localStorage.getItem('biaOxuUserPermissions')) || {};
    const tablePermissions = permissions.quanly_ban || {};
    const userCanEdit = userRole === 'admin' || tablePermissions.can_edit === true;
    const userCanDelete = userRole === 'admin' || tablePermissions.can_delete === true;

    sortedTableIds
    .filter(tableId => selectedZone === 'all' || tables[tableId].zone === selectedZone) // DÒNG LỌC MỚI
    .forEach(tableId => {
        const table = tables[tableId];
        const card = document.createElement('div');
        card.className = `table-card status-${table.status.toLowerCase().replace(/ /g, '-')}`;
        card.dataset.tableId = tableId;
        if (tableId === selectedTableId) {
            card.classList.add('selected');
        }

        const tableBooking = upcomingBookings.find(b => b.tableId === tableId);
        if (table.status === 'Trống' && tableBooking) {
            card.classList.add('status-co-khach-sap-toi');
        }

        let content = '';
        if (table.status === 'Đang chơi') {
            const bill = calculateBill(table);
            const startTimeFormatted = new Date(table.startTime).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            content = `
                <div class="table-number">${table.name}</div>
                <div class="table-info">Giờ vào: ${startTimeFormatted}</div>
                <div class="table-time">Thời gian: <span id="time-${tableId}">${getPlayingTime(table.startTime, table.accumulatedTime)}</span></div>
                <div class="table-price" style="font-size: 14px; font-weight: 500;">(${formatCurrency(bill.pricePerHour)}đ/giờ)</div>
                <div class="table-price" id="cost-${tableId}">Tiền giờ: ${formatCurrency(bill.playingCost)}đ</div>`;
        } else {
            const priceListName = priceLists[table.priceListId] ? priceLists[table.priceListId].name : 'N/A';
            content = `
                <div class="table-number">${table.name}</div>
                <div class="table-info">Loại: ${priceListName}</div>
                <div class="table-time">Trạng thái: ${table.status}</div>`;
            
            if (table.status === 'Trống' && tableBooking) {
                const bookingTime = new Date(tableBooking.bookingTime).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
                content += `<div class="table-info" style="color: var(--warning-color); font-weight: 600; margin-top: 5px;">Đặt lúc: ${bookingTime}</div>`;
            }
        }
        
        let actions = '<div class="table-card-actions">';
        let hasActions = false;
        if (userCanEdit) {
            actions += `<button onclick="openTableModal('${tableId}', event)"><i class="fas fa-pencil-alt"></i></button>`;
            hasActions = true;
        }
        if (userCanDelete) {
            actions += `<button onclick="deleteTable('${tableId}', event)"><i class="fas fa-trash-alt"></i></button>`;
            hasActions = true;
        }
        actions += '</div>';

        card.innerHTML = content + (hasActions ? actions : '');
        
        // ================== BẮT ĐẦU THAY ĐỔI ==================
        card.addEventListener('click', () => {
            if (selectedTableId === tableId) {
                // Nếu nhấn vào bàn đang được chọn, hãy bỏ chọn nó (ẩn hóa đơn)
                selectAndShowBill(null);
            } else {
                // Nếu nhấn vào bàn mới, hãy chọn nó
                selectAndShowBill(tableId);
            }
        });
        // =================== KẾT THÚC THAY ĐỔI ===================
        
        tableGrid.appendChild(card);
    });
     updateQuickDashboard(); // <--- THÊM DÒNG NÀY
}
// ============================================
// ===== KẾT THÚC: CODE HỖ TRỢ ĐẶT BÀN =====
// ============================================

    // =================================================================
    // ===== START: CÁC HÀM LOGIC TÍNH TOÁN NÂNG CAO (ĐÃ CẬP NHẬT) =====
    // =================================================================

    function getPlayingTime(startTime, accumulatedTime = 0) {
        if (!startTime) return '00:00:00';
        
        const elapsedMilliseconds = (Date.now() - startTime) + accumulatedTime;
        const totalSeconds = Math.floor(elapsedMilliseconds / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
    
    function getCurrentPricePerHour(priceListId) {
        const priceList = priceLists[priceListId];
        if (!priceList) return 0;

        const now = new Date();
        const dayOfWeek = now.getDay();
        const currentDate = now.toISOString().split('T')[0];
        const currentTime = now.toTimeString().split(' ')[0].substring(0, 5);

        let currentPrice = priceList.basePrice;

        for (const slot of priceList.timeSlots) {
            if (currentTime >= slot.from && currentTime < slot.to) {
                currentPrice = slot.price;
                break;
            }
        }

        if (holidays.includes(currentDate)) {
            currentPrice *= (priceList.holidayMultiplier || 1.0);
        } else if (dayOfWeek === 0 || dayOfWeek === 6) {
            currentPrice *= (priceList.weekendMultiplier || 1.0);
        }

        return currentPrice;
    }

    // === CẬP NHẬT: HÀM TÍNH HÓA ĐƠN ĐƯỢC VIẾT LẠI HOÀN TOÀN ===
    function calculateBill(table) {
        // 1. Tính toán chi phí gốc
        const playingCostRaw = (() => {
            const accumulatedCost = table.accumulatedCost || 0;
            const currentPlayingTime = table.startTime ? Date.now() - table.startTime : 0;
            // THAY THẾ BẰNG ĐOẠN MÃ ĐÚNG NÀY
const pricePerHour = getCurrentPricePerHour(table.priceListId);
const pricePerMillisecond = pricePerHour / (3600 * 1000); // Sửa lại thứ tự
const currentPlayingCost = currentPlayingTime * pricePerMillisecond;
            return accumulatedCost + currentPlayingCost;
        })();
        const productsCost = table.products.reduce((sum, product) => sum + product.price * product.quantity, 0);

        const adjustments = table.adjustments || [];
        let adjustmentDetails = []; // Mảng để lưu chi tiết các khoản đã tính
        let finalPlayingCost = playingCostRaw;

        // 2. Áp dụng các khoản liên quan đến "Tiền giờ" trước
        adjustments.filter(adj => adj.applyTo === 'playingCost').forEach(adj => {
            let calculatedAmount = 0;
            if (adj.method === 'fixed') {
                calculatedAmount = adj.value;
            } else { // percentage
                calculatedAmount = playingCostRaw * (adj.value / 100);
            }
            
            if (adj.type === 'discount') {
                finalPlayingCost -= calculatedAmount;
                calculatedAmount = -calculatedAmount; // Gán số âm cho giảm trừ
            } else { // surcharge
                finalPlayingCost += calculatedAmount;
            }
            adjustmentDetails.push({ ...adj, calculatedAmount });
        });

        // 3. Tính tổng phụ (Subtotal)
        const subtotal = finalPlayingCost + productsCost;
        let finalTotal = subtotal;

        // 4. Áp dụng các khoản liên quan đến "Toàn bộ hóa đơn"
        adjustments.filter(adj => adj.applyTo === 'total').forEach(adj => {
            let calculatedAmount = 0;
            if (adj.method === 'fixed') {
                calculatedAmount = adj.value;
            } else { // percentage
                calculatedAmount = subtotal * (adj.value / 100);
            }
            
            if (adj.type === 'discount') {
                finalTotal -= calculatedAmount;
                calculatedAmount = -calculatedAmount;
            } else { // surcharge
                finalTotal += calculatedAmount;
            }
            adjustmentDetails.push({ ...adj, calculatedAmount });
        });

        // Tổng tiền của tất cả các khoản điều chỉnh
        const adjustmentsTotal = adjustmentDetails.reduce((sum, adj) => sum + adj.calculatedAmount, 0);

        return {
            playingCost: playingCostRaw,
            productsCost,
            total: finalTotal,
            pricePerHour: getCurrentPricePerHour(table.priceListId),
            adjustmentsTotal,
            adjustmentDetails // Trả về chi tiết để hiển thị
        };
    }

    // ======================================================
    // ===== END: CÁC HÀM LOGIC TÍNH TOÁN (ĐÃ CẬP NHẬT) =====
    // ======================================================

    // --- CÁC HÀM TIMER & RENDER ---
    
    // === CẬP NHẬT: FIX LỖI TIỀN GIỜ KHÔNG NHẢY THEO THỜI GIAN ===
    function updateTableCards() {
        for (const tableId in tables) {
            const table = tables[tableId];
            if (table.status === 'Đang chơi') {
                const timeElement = document.getElementById(`time-${tableId}`);
                if (timeElement) {
                    timeElement.textContent = getPlayingTime(table.startTime, table.accumulatedTime);
                }

                const bill = calculateBill(table);
                const costElement = document.getElementById(`cost-${tableId}`);
                if (costElement) {
                    costElement.textContent = `Tiền giờ: ${formatCurrency(bill.playingCost)}đ`;
                }
            }
        }
        
        if (selectedTableId && tables[selectedTableId] && tables[selectedTableId].status === 'Đang chơi' && billSidebar.classList.contains('show')) {
            const table = tables[selectedTableId];
            const bill = calculateBill(table);
            const playingCostEl = document.getElementById('playing-cost');
            const summaryPlayingCostEl = document.getElementById('summary-playing-cost');
            const summaryTotalEl = document.getElementById('summary-total');
            const summaryProductsCostEl = document.getElementById('summary-products-cost');
            
            if (playingCostEl) playingCostEl.textContent = formatCurrency(bill.playingCost);
            if (summaryPlayingCostEl) summaryPlayingCostEl.textContent = `${formatCurrency(bill.playingCost)}đ`;
            if(summaryProductsCostEl) summaryProductsCostEl.textContent = `${formatCurrency(bill.productsCost)}đ`;
            if (summaryTotalEl) summaryTotalEl.textContent = `${formatCurrency(bill.total)}đ`;
            
            // Cập nhật lại list giảm giá/phụ thu
            renderAdjustments(table, bill);
        }
    }
    
    function startGlobalTimer() {
        if (globalTableTimer) clearInterval(globalTableTimer);
        globalTableTimer = setInterval(updateTableCards, 1000);
    }


  function renderMenu() {
    menuGrid.innerHTML = '';
    menuItems = JSON.parse(localStorage.getItem(INVENTORY_STORAGE_KEY)) || [];

    if (menuItems.length === 0) {
        menuGrid.innerHTML = '<p style="text-align: center; color: #666;">Thực đơn đang trống. Vui lòng thêm mặt hàng ở trang Quản lý Kho.</p>';
    } else {
        menuItems.forEach(item => {
            const menuItem = document.createElement('div');
            menuItem.className = 'menu-item';

            if (item.quantity <= 0) {
                menuItem.classList.add('out-of-stock');
            }
            
            menuItem.dataset.id = item.id;
            // ================== BẮT ĐẦU THAY ĐỔI ==================
            // Thêm một dòng span để hiển thị số lượng tồn kho
            menuItem.innerHTML = `
                <img src="${item.image || 'https://placehold.co/100x100?text=No+Img'}" alt="${item.name}">
                <span class="item-name">${item.name}</span>
                <span class="item-stock" style="font-size: 12px; color: #666;">(Còn: ${item.quantity})</span>
                <span class="item-price">${formatCurrency(item.price)}đ</span>`;
            // =================== KẾT THÚC THAY ĐỔI ===================

            menuItem.addEventListener('click', () => {
                if (item.quantity > 0) { 
                    if (selectedTableId && tables[selectedTableId]) {
                        addProductToTable(selectedTableId, item);
                    } else {
                        showMessage('Vui lòng chọn một bàn trước!', 'error');
                    }
                } else {
                    showMessage('Mặt hàng này đã hết!', 'error');
                }
            });
            menuGrid.appendChild(menuItem);
        });
    }
}
    
    // ===============================================================
    // ===== HÀM RENDER HÓA ĐƠN ĐÃ LƯU (ĐƯỢC NÂNG CẤP HOÀN TOÀN) =====
    // ===============================================================
    function renderSavedBills() {
        const searchInput = document.getElementById('bill-search-input');
        const sortSelect = document.getElementById('bill-sort-select');
        
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const sortMethod = sortSelect ? sortSelect.value : 'newest';

        let filteredBills = [...savedBills];

        // 1. Lọc theo từ khóa tìm kiếm
        if (searchTerm) {
            filteredBills = filteredBills.filter(bill =>
                (bill.id && bill.id.toLowerCase().includes(searchTerm)) ||
                (bill.tableName && bill.tableName.toLowerCase().includes(searchTerm))
            );
        }

        // 2. Sắp xếp danh sách đã lọc
        switch (sortMethod) {
            case 'oldest':
                filteredBills.sort((a, b) => a.endTime - b.endTime);
                break;
            case 'total-desc':
                filteredBills.sort((a, b) => b.totalAmount - a.totalAmount);
                break;
            case 'total-asc':
                filteredBills.sort((a, b) => a.totalAmount - b.totalAmount);
                break;
            case 'newest':
            default:
                filteredBills.sort((a, b) => b.endTime - a.endTime); // Mặc định là mới nhất
                break;
        }

        // 3. Áp dụng phân trang và render ra HTML
        savedBillsList.innerHTML = '';
        const startIndex = (currentPage - 1) * billsPerPage;
        const endIndex = startIndex + billsPerPage;
        const billsToShow = filteredBills.slice(startIndex, endIndex);

        if (billsToShow.length === 0) {
            savedBillsList.innerHTML = '<li>Không tìm thấy hóa đơn nào phù hợp.</li>';
        } else {
            billsToShow.forEach(bill => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="chitiet_hoadon.html?id=${bill.id}"><b>${bill.id || 'N/A'}</b></a> - Bàn ${bill.tableName} - Tổng: <b>${formatCurrency(bill.totalAmount)}đ</b> - ${new Date(bill.endTime).toLocaleString('vi-VN')}`;
                savedBillsList.appendChild(li);
            });
        }
        
        // 4. Cập nhật lại các nút phân trang
        renderPaginationButtons(filteredBills.length);
    }


  // TÌM VÀ THAY THẾ TOÀN BỘ HÀM NÀY TRONG file quanly_ban.html

// TÌM VÀ THAY THẾ TOÀN BỘ HÀM NÀY

// TÌM VÀ THAY THẾ TOÀN BỘ HÀM NÀY BẰNG PHIÊN BẢN CUỐI CÙNG

function selectAndShowBill(tableId) {
    const mainContent = document.querySelector('.main-content');

    // Logic khi không có bàn nào được chọn hoặc bỏ chọn bàn hiện tại
    if (!tableId || !tables[tableId] || selectedTableId === tableId) {
        if (selectedTableId) {
            mainContent.classList.remove('sidebar-active');
        }
        
        if (selectedTableId === tableId) {
            selectedTableId = null;
        }
        
        renderTableCards();
        
        setTimeout(() => {
            if (!mainContent.classList.contains('sidebar-active')) {
                 billHeader.innerHTML = `<h3>Vui lòng chọn bàn</h3>`;
                 billDetailsContent.innerHTML = '';
            }
        }, 350);
        
        return;
    }
    
    // Logic khi một bàn mới được chọn
    selectedTableId = tableId;
    renderTableCards();
    populateSidebar(tables[tableId]);
    
    // Thêm class vào thẻ cha để CSS tự động xử lý toàn bộ giao diện
    mainContent.classList.add('sidebar-active');
}

  function populateSidebar(table) {
    if (!table) return;
    billHeader.innerHTML = `<h3>${table.name}</h3><span>${table.status}</span>`;

    let contentHTML = '<hr style="margin-top: 0; margin-bottom: 15px;">';

    if (table.status === 'Trống' || table.status === 'Đã đặt') {
        contentHTML += `
            <p>Bàn này đang ${table.status.toLowerCase()}.</p>
            <div class="bill-actions">
                <button class="btn btn-primary" onclick="startTable('${selectedTableId}')">Bắt đầu tính giờ</button>
            </div>`;
        billDetailsContent.innerHTML = contentHTML;
    } else { // Bàn đang chơi
        // === BẮT ĐẦU NÂNG CẤP: HIỂN THỊ THÔNG TIN KHÁCH HÀNG ===
        let customerDisplayHTML = '';
        if (table.customerId) {
            const customers = JSON.parse(localStorage.getItem(CUSTOMERS_STORAGE_KEY)) || [];
            const customer = customers.find(c => c.id === table.customerId);
            if (customer) {
                customerDisplayHTML = `
                    <div class="customer-info-area">
                        <p><i class="fa-solid fa-user"></i> Khách hàng: <span class="name">${customer.name}</span></p>
                       <button class="btn-link js-open-customer-modal">Thay đổi</button>
                    </div>`;
            }
        } else {
            customerDisplayHTML = `
                <div class="customer-info-area">
                    <p>Chưa chọn khách hàng</p>
                    <button class="btn btn-link js-open-customer-modal">Chọn</button>
                </div>`;
        }
        // === KẾT THÚC NÂNG CẤP ===

        const bill = calculateBill(table);
        const productsList = table.products.length > 0 ? table.products.map(p => `
            <div class="bill-item">
                <span class="item-name">${p.name}</span>
                <div class="item-qty">
                    <input type="number" min="1" value="${p.quantity}" data-item-id="${p.id}" onchange="updateBillItemQuantity('${selectedTableId}', '${p.id}', this.value)">
                </div>
                <span class="item-total">${formatCurrency(p.price * p.quantity)}</span>
                <button class="delete-btn" onclick="removeBillItem('${selectedTableId}', '${p.id}')"><i class="fa-solid fa-trash-can"></i></button>
            </div>`).join('') : '<p>Chưa có món nào được gọi.</p>';

        contentHTML += `
            ${customerDisplayHTML} 
            <div style="display: flex; flex-direction: column;">
                <h4>Tiền giờ (${formatCurrency(bill.pricePerHour)}đ/giờ)</h4>
                <div class="bill-item-list" style="max-height: 100px;">
                    <div class="bill-item">
                        <span class="item-name">Tiền giờ</span>
                        <span></span>
                        <span class="item-total" id="playing-cost">${formatCurrency(bill.playingCost)}</span>
                        <button class="delete-btn" style="visibility: hidden;"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
                <hr>
                <h4>Thực đơn đã gọi</h4>
                <div class="bill-item-list">${productsList}</div>
                 <hr>
                <h4>Giảm trừ / Phụ thu</h4>
                <div id="adjustments-list" style="max-height: 80px; overflow-y: auto; margin-bottom: 10px;"></div>
                <button class="btn btn-secondary" style="width: 100%; padding: 8px;" onclick="openAdjustmentModal()">
                    <i class="fa-solid fa-tags"></i> Thêm Giảm Trừ / Phụ Thu
                </button>
            </div>

            <div class="bill-summary">
                <p><span>Tiền giờ:</span> <span id="summary-playing-cost">${formatCurrency(bill.playingCost)}đ</span></p>
                <p><span>Tiền đồ ăn, uống:</span> <span id="summary-products-cost">${formatCurrency(bill.productsCost)}đ</span></p>
                ${bill.adjustmentsTotal !== 0 ? `<p><span>Giảm trừ/Phụ thu:</span> <span style="font-weight: 600; color: ${bill.adjustmentsTotal < 0 ? '#d32f2f' : '#388e3c'};">${formatCurrency(bill.adjustmentsTotal)}đ</span></p>` : ''}
                <p class="total"><span>Tổng cộng:</span> <span id="summary-total">${formatCurrency(bill.total)}đ</span></p>
            </div>
            <div class="bill-actions has-print">
                <button class="btn btn-secondary" onclick="openTransferModal('${selectedTableId}')"><i class="fa-solid fa-arrows-left-right"></i> Chuyển bàn</button>
                <button class="btn btn-secondary" onclick="printTemporaryBill('${selectedTableId}')"><i class="fa-solid fa-print"></i> In hóa đơn</button>
                <button class="btn btn-primary" onclick="handlePayment('${selectedTableId}')"><i class="fa-solid fa-money-bill-wave"></i> Thanh toán</button>
            </div>`;
        
        billDetailsContent.innerHTML = contentHTML;
        renderAdjustments(table, bill);
    }
}

    // --- CÁC HÀM HÀNH ĐỘNG (gọi từ HTML) ---
   // THAY THẾ HÀM startTable() CŨ BẰNG HÀM NÀY
// THAY THẾ HÀM startTable() CŨ BẰNG HÀM NÀY
window.startTable = function(tableId) {
    const table = tables[tableId];
    if (table && (table.status === 'Trống' || table.status === 'Đã đặt')) {
        const BOOKINGS_STORAGE_KEY = 'biaOxuBookings';
        let bookings = JSON.parse(localStorage.getItem(BOOKINGS_STORAGE_KEY)) || [];
        const relevantBookingIndex = bookings.findIndex(b => b.tableId === tableId && b.status === 'Confirmed');

        // === BẮT ĐẦU NÂNG CẤP ===
        let customerIdFromBooking = null;
        if (relevantBookingIndex > -1) {
            bookings[relevantBookingIndex].status = 'Completed';
            customerIdFromBooking = bookings[relevantBookingIndex].customerId || null;
            localStorage.setItem(BOOKINGS_STORAGE_KEY, JSON.stringify(bookings));
        }

        // Bắt đầu phiên chơi
        table.status = 'Đang chơi';
        table.startTime = Date.now();
        table.accumulatedCost = 0;
        table.accumulatedTime = 0;
        table.adjustments = [];
        table.products = [];
        table.customerId = customerIdFromBooking; // Gán khách hàng từ lịch đặt (nếu có)
        // === KẾT THÚC NÂNG CẤP ===
        
        renderTableCards();
        populateSidebar(table);
        saveDataToLocalStorage();
        showMessage(`Bàn ${table.name} đã bắt đầu tính giờ!`);
    }
}

   window.addProductToTable = function(tableId, item) {
    const table = tables[tableId];
    if (!table) return;

    if (table.status !== 'Đang chơi') {
        showMessage('Không thể thêm món vào bàn chưa bắt đầu chơi!', 'error');
        return;
    }

    // Lấy thông tin tồn kho mới nhất
    const currentInventoryItem = menuItems.find(i => i.id === item.id);
    if (!currentInventoryItem) {
        showMessage('Lỗi: Không tìm thấy sản phẩm trong kho.', 'error');
        return;
    }

    // Kiểm tra nếu sản phẩm đã hết hàng
    if (currentInventoryItem.quantity <= 0) {
        showMessage('Không thể thêm, mặt hàng đã hết!', 'error');
        renderMenu(); // Cập nhật lại giao diện thực đơn
        return;
    }

    const existingProduct = table.products.find(p => p.id === item.id);
    const quantityInBill = existingProduct ? existingProduct.quantity : 0;

    // ================== BẮT ĐẦU THAY ĐỔI ==================
    // So sánh số lượng trong hóa đơn với số lượng tồn kho
    if (quantityInBill >= currentInventoryItem.quantity) {
        showMessage(`Đã đạt số lượng tồn kho tối đa (${currentInventoryItem.quantity}) cho món này.`, 'error');
        return; // Dừng không cho thêm nữa
    }
    // =================== KẾT THÚC THAY ĐỔI ===================

    // Logic thêm sản phẩm vào hóa đơn (giữ nguyên)
    if (existingProduct) {
        existingProduct.quantity++;
    } else {
        // Lấy thông tin giá và tên mới nhất từ kho để thêm vào hóa đơn
        const itemToAdd = { ...currentInventoryItem, quantity: 1 };
        table.products.push(itemToAdd);
    }
    
    populateSidebar(table);
    saveDataToLocalStorage();
    showMessage(`Đã thêm ${item.name} vào hóa đơn của ${table.name}!`);
}

    window.updateBillItemQuantity = function(tableId, itemId, quantity) {
    const table = tables[tableId];
    if (!table) return;

    const productInBill = table.products.find(p => String(p.id) === String(itemId));
    if (!productInBill) return;

    // ================== BẮT ĐẦU THAY ĐỔI ==================
    // Lấy thông tin tồn kho của sản phẩm
    const inventoryItem = menuItems.find(i => String(i.id) === String(itemId));
    const stockQuantity = inventoryItem ? inventoryItem.quantity : 0;
    
    let newQuantity = parseInt(quantity);

    // Xử lý nếu người dùng nhập số không hợp lệ
    if (isNaN(newQuantity)) {
        newQuantity = 1;
    }

    // Nếu số lượng mới lớn hơn tồn kho, thông báo và đặt lại bằng mức tối đa
    if (newQuantity > stockQuantity) {
        showMessage(`Số lượng tồn kho của "${inventoryItem.name}" chỉ còn ${stockQuantity}.`, 'error');
        productInBill.quantity = stockQuantity; // Tự động sửa thành số lượng tối đa
    } 
    // Nếu số lượng nhỏ hơn hoặc bằng 0, xóa sản phẩm khỏi hóa đơn
    else if (newQuantity <= 0) {
        table.products = table.products.filter(p => String(p.id) !== String(itemId));
    } 
    // Nếu hợp lệ, cập nhật số lượng
    else {
        productInBill.quantity = newQuantity;
    }
    // =================== KẾT THÚC THAY ĐỔI ===================

    populateSidebar(table); // Cập nhật lại giao diện hóa đơn (quan trọng để reset ô input nếu sai)
    saveDataToLocalStorage();
}

    window.removeBillItem = function(tableId, itemId) {
        const table = tables[tableId];
        if (!table) return;
        table.products = table.products.filter(p => String(p.id) !== String(itemId));
        populateSidebar(table);
        saveDataToLocalStorage();
        showMessage('Đã xóa món khỏi hóa đơn!');
    }
    
    // TÌM VÀ THAY THẾ TOÀN BỘ HÀM NÀY
window.handlePayment = function(tableId) {
    const table = tables[tableId];
    if (table && table.status === 'Đang chơi') {
        const finalBill = calculateBill(table);
        
        let customerNameForMessage = '';
        let tierUpdateInfo = null; 

        if (table.customerId) {
            let customers = JSON.parse(localStorage.getItem(CUSTOMERS_STORAGE_KEY)) || [];
            const customerIndex = customers.findIndex(c => c.id === table.customerId);
            if (customerIndex > -1) {
                customers[customerIndex].totalSpent = (customers[customerIndex].totalSpent || 0) + finalBill.total;
                customers[customerIndex].visitCount = (customers[customerIndex].visitCount || 0) + 1;
                tierUpdateInfo = updateCustomerTier(customers[customerIndex]);
                localStorage.setItem(CUSTOMERS_STORAGE_KEY, JSON.stringify(customers));
                customerNameForMessage = customers[customerIndex].name;
            }
        }

        const newInvoiceId = generateInvoiceId(table.name);
        const bill = {
            id: newInvoiceId,
            tableId: tableId,
            tableName: table.name,
            startTime: table.startTime,
            endTime: Date.now(),
            products: [...table.products],
            totalAmount: finalBill.total,
            playingCost: finalBill.playingCost,
            productsCost: finalBill.productsCost,
            priceListId: table.priceListId,
            pricePerHourApplied: finalBill.pricePerHour,
            adjustments: [...(table.adjustments || [])],
            adjustmentDetails: finalBill.adjustmentDetails,
            customerId: table.customerId || null
        };
        savedBills.push(bill);

        bill.products.forEach(soldProduct => {
            let latestInventory = JSON.parse(localStorage.getItem(INVENTORY_STORAGE_KEY)) || [];
            const productInInventory = latestInventory.find(p => p.id === soldProduct.id);
            if (productInInventory) {
                productInInventory.quantity -= soldProduct.quantity;
            }
            localStorage.setItem(INVENTORY_STORAGE_KEY, JSON.stringify(latestInventory));
        });
        
        const transactionId = newInvoiceId.replace('HD', 'PT');
        addTransactionToLedger({
            id: transactionId,
            type: 'income',
            description: `Thu tiền hóa đơn ${newInvoiceId}`,
            amount: finalBill.total,
            date: new Date().toLocaleString('vi-VN'),
        });
        
        // Reset bàn
        table.status = 'Trống';
        table.startTime = null;
        table.products = [];
        table.accumulatedCost = 0;
        table.accumulatedTime = 0;
        table.adjustments = [];
        table.customerId = null;
        
        saveDataToLocalStorage();

        // === BẮT ĐẦU THAY ĐỔI: LOGIC HIỂN THỊ THÔNG BÁO ===
        // 1. In hóa đơn và chờ nó thực hiện xong
        printBill(bill).then(() => {
            // 2. Sau khi lệnh in được gọi, hiển thị màn hình hoàn tất
            const overlay = document.getElementById('payment-success-overlay');
            overlay.style.display = 'flex';

            // 3. Tự động ẩn màn hình này sau 2.5 giây
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 2500);
        });

        // Hiển thị các thông báo phụ (như nâng hạng) bằng cơ chế cũ
        if (tierUpdateInfo) {
            const upgradeMessage = `🎉 CHÚC MỪNG! Khách hàng ${customerNameForMessage} đã được thăng hạng từ ${tierUpdateInfo.oldTierName} lên ${tierUpdateInfo.newTierName}!`;
            setTimeout(() => showMessage(upgradeMessage), 500); // Hiện sau 0.5s để không bị chồng chéo
        }
        // === KẾT THÚC THAY ĐỔI ===
        
        // Cập nhật giao diện
        renderTableCards();
        selectAndShowBill(tableId);
        renderSavedBills();
        renderMenu();
    }
}

    function addTransactionToLedger(newTransaction) {
        const TRANSACTIONS_STORAGE_KEY = 'biaOxuTransactions';
        let transactions = JSON.parse(localStorage.getItem(TRANSACTIONS_STORAGE_KEY)) || [];
        transactions.push(newTransaction);
        localStorage.setItem(TRANSACTIONS_STORAGE_KEY, JSON.stringify(transactions));
    }

   // TÌM VÀ THAY THẾ TOÀN BỘ HÀM NÀY
window.printBill = function(bill) {
    // 1. Tải cài đặt động từ localStorage
    const settings = loadInvoiceSettings();
    const cashierName = sessionStorage.getItem('loggedInUser') || 'N/A';

    // 2. Xây dựng HTML cho logo nếu có
    let logoHTML = '';
    if (settings.showLogo && settings.logoDataUrl) {
        logoHTML = `<div style="text-align: center; margin-bottom: 10px;">
                        <img src="${settings.logoDataUrl}" alt="Logo" style="max-width: 150px; max-height: 80px; object-fit: contain;">
                    </div>`;
    }

    // 3. Xây dựng các phần của hóa đơn (giữ nguyên logic cũ)
    let storeInfoHTML = '';
    if (settings.showStoreName) {
        storeInfoHTML += `<h2>${settings.storeName}</h2>`;
    }
    if (settings.showAddress && settings.address) {
        storeInfoHTML += `<div style="text-align: center; font-size: 12px;">${settings.address}</div>`;
    }
    if (settings.showPhone && settings.phone) {
        storeInfoHTML += `<div style="text-align: center; font-size: 12px;">ĐT: ${settings.phone}</div>`;
    }
    if (settings.showTaxCode && settings.taxCode) {
        storeInfoHTML += `<div style="text-align: center; font-size: 12px;">MST: ${settings.taxCode}</div>`;
    }

    const productsList = bill.products.map(p => `
        <tr>
            <td>${p.name}</td>
            <td>${p.quantity}</td>
            <td style="text-align: right;">${formatCurrency(p.price)}</td>
            <td style="text-align: right;">${formatCurrency(p.price * p.quantity)}</td>
        </tr>`).join('');
    
    const adjustmentsList = (bill.adjustmentDetails || []).map(adj => `
        <div class="info-row">
            <span>${adj.description} ${adj.method === 'percentage' ? `(${adj.value}%)` : ''}</span>
            <span>${formatCurrency(adj.calculatedAmount)}đ</span>
        </div>
    `).join('');
    
    // === BẮT ĐẦU THAY ĐỔI LOGIC IN ===
    // 4. Lấy iframe ẩn đã tạo trong HTML
    const printFrame = document.getElementById('print-frame');
    const printDocument = printFrame.contentWindow.document;

    // 5. Ghi toàn bộ nội dung hóa đơn vào iframe
    printDocument.open();
    printDocument.write(`
        <html>
        <head>
            <title>Hóa đơn ${bill.id}</title>
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 14px; color: #000; }
                .bill-print-container { width: 300px; margin: 0 auto; padding: 10px; }
                h2, h3 { text-align: center; margin: 5px 0; }
                h2 { font-size: 1.2em; }
                h3 { font-size: 1.1em; }
                .divider { border-top: 1px dashed #000; margin: 10px 0; }
                .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px;}
                table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
                th, td { text-align: left; padding: 4px 0; border-bottom: 1px dotted #555; }
                th { font-weight: 600; }
                .summary-row { font-weight: 600; }
                .total-row { font-weight: 700; font-size: 16px; margin-top: 10px; }
                .thank-you { text-align: center; margin-top: 20px; white-space: pre-wrap; font-style: italic; font-size: 13px; }
            </style>
        </head>
        <body>
            <div class="bill-print-container">
                ${logoHTML}
                ${storeInfoHTML}
                <h3>${settings.mainTitle}</h3>
                <div class="divider"></div>
                <div class="info-row"><span>Mã HĐ:</span><span>${bill.id}</span></div>
                <div class="info-row"><span>Bàn:</span><span>${bill.tableName}</span></div>
                ${settings.showCashier ? `<div class="info-row"><span>Thu ngân:</span><span>${cashierName}</span></div>` : ''}
                <div class="info-row"><span>Giờ vào:</span><span>${new Date(bill.startTime).toLocaleString('vi-VN')}</span></div>
                <div class="info-row"><span>Giờ ra:</span><span>${new Date(bill.endTime).toLocaleString('vi-VN')}</span></div>
                <div class="divider"></div>
                <table>
                    <thead><tr><th>Món</th><th>SL</th><th style="text-align: right;">Đ.Giá</th><th style="text-align: right;">T.Tiền</th></tr></thead>
                    <tbody>
                        <tr><td>Tiền giờ</td><td>-</td><td style="text-align: right;">-</td><td style="text-align: right;">${formatCurrency(bill.playingCost)}</td></tr>
                        ${productsList}
                    </tbody>
                </table>
                <div class="divider"></div>
                <div class="info-row summary-row"><span>Tổng tiền giờ:</span><span>${formatCurrency(bill.playingCost)}đ</span></div>
                <div class="info-row summary-row"><span>Tổng tiền dịch vụ:</span><span>${formatCurrency(bill.productsCost)}đ</span></div>
                ${adjustmentsList}
                <div class="info-row total-row"><span>TỔNG CỘNG:</span><span>${formatCurrency(bill.totalAmount)}đ</span></div>
                <div class="thank-you">${settings.footerText.replace(/\n/g, '<br>')}</div>
            </div>
        </body>
        </html>`);
    printDocument.close();

    // 6. Gọi lệnh in trên iframe và trả về một Promise để xử lý tiếp
    return new Promise(resolve => {
        // Thêm độ trễ nhỏ để đảm bảo nội dung được render đầy đủ trước khi in
        setTimeout(() => {
            printFrame.contentWindow.focus();
            printFrame.contentWindow.print();
            resolve(); // Báo hiệu đã gửi lệnh in
        }, 250);
    });
    // === KẾT THÚC THAY ĐỔI LOGIC IN ===
};

// Thay thế hàm printTemporaryBill cũ bằng hàm này
// Tìm và thay thế toàn bộ hàm này trong file quanly_ban.html
// Tìm và thay thế toàn bộ hàm này trong file quanly_ban.html

window.printTemporaryBill = function(tableId) {
    const table = tables[tableId];
    if (!table || table.status !== 'Đang chơi') {
        showMessage('Không thể in hóa đơn cho bàn trống!', 'error');
        return;
    }
    const bill = calculateBill(table);

    // 1. Tải cài đặt
    const settings = loadInvoiceSettings();
    const cashierName = sessionStorage.getItem('loggedInUser') || 'N/A';

    // 2. Xây dựng HTML cho logo
    let logoHTML = '';
    if (settings.showLogo && settings.logoDataUrl) {
        logoHTML = `<div style="text-align: center; margin-bottom: 10px;">
                        <img src="${settings.logoDataUrl}" alt="Logo" style="max-width: 150px; max-height: 80px; object-fit: contain;">
                    </div>`;
    }

    // 3. Xây dựng HTML cho thông tin quán
    let storeInfoHTML = '';
    if (settings.showStoreName) {
        storeInfoHTML += `<h2>${settings.storeName}</h2>`;
    }
    
    const productsList = table.products.map(p => `
        <tr>
            <td>${p.name}</td>
            <td>${p.quantity}</td>
            <td style="text-align: right;">${formatCurrency(p.price)}</td>
            <td style="text-align: right;">${formatCurrency(p.price * p.quantity)}</td>
        </tr>`).join('');
        
    const adjustmentsList = (bill.adjustmentDetails || []).map(adj => `
        <div class="info-row">
            <span>${adj.description} ${adj.method === 'percentage' ? `(${adj.value}%)` : ''}</span>
            <span>${formatCurrency(adj.calculatedAmount)}đ</span>
        </div>
    `).join('');

    // 4. Tạo nội dung HTML hoàn chỉnh, đã xóa các ký tự thừa
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Hóa đơn tạm tính - ${table.name}</title>
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 14px; color: #000; }
                .bill-print-container { width: 300px; margin: 0 auto; padding: 10px; }
                h2, h3 { text-align: center; margin: 5px 0; }
                h2 { font-size: 1.2em; }
                h3 { font-size: 1.1em; }
                .divider { border-top: 1px dashed #000; margin: 10px 0; }
                .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px;}
                table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
                th, td { text-align: left; padding: 4px 0; border-bottom: 1px dotted #555; }
                th { font-weight: 600; }
                .summary-row { font-weight: 600; }
                .total-row { font-weight: 700; font-size: 16px; margin-top: 10px; }
                .thank-you { text-align: center; margin-top: 20px; white-space: pre-wrap; font-style: italic; font-size: 13px; }
            </style>
        </head>
        <body>
            <div class="bill-print-container">
                
                ${logoHTML}

                ${storeInfoHTML}
                <h3>HÓA ĐƠN TẠM TÍNH</h3>
                <div class="divider"></div>
                <div class="info-row"><span>Bàn:</span><span>${table.name}</span></div>
                ${settings.showCashier ? `<div class="info-row"><span>Thu ngân:</span><span>${cashierName}</span></div>` : ''}
                <div class="info-row"><span>Thời gian chơi:</span><span>${getPlayingTime(table.startTime, table.accumulatedTime)}</span></div>
                <div class="divider"></div>
                <table>
                    <thead><tr><th>Món</th><th>SL</th><th style="text-align: right;">Đ.Giá</th><th style="text-align: right;">T.Tiền</th></tr></thead>
                    <tbody>
                        <tr><td>Tiền giờ</td><td>-</td><td style="text-align: right;">-</td><td style="text-align: right;">${formatCurrency(bill.playingCost)}</td></tr>
                        ${productsList}
                    </tbody>
                </table>
                <div class="divider"></div>
                <div class="info-row summary-row"><span>Tổng tiền giờ:</span><span>${formatCurrency(bill.playingCost)}đ</span></div>
                <div class="info-row summary-row"><span>Tổng tiền dịch vụ:</span><span>${formatCurrency(bill.productsCost)}đ</span></div>
                ${adjustmentsList}
                <div class="info-row total-row"><span>TẠM TÍNH:</span><span>${formatCurrency(bill.total)}đ</span></div>
                <div class="thank-you">${settings.footerText.replace(/\n/g, '<br>')}</div>
            </div>
        </body>
        </html>`);
   printWindow.document.close();

    // *** BẮT ĐẦU SỬA LỖI ***
    // Xóa lệnh print() bên ngoài và chỉ giữ lại lệnh bên trong setTimeout
    setTimeout(() => {
        printWindow.focus();
        printWindow.print();
    }, 250);
    // *** KẾT THÚC SỬA LỖI ***
};

    window.openTransferModal = function(tableId) {
        const table = tables[tableId];
        if (!table || table.status !== 'Đang chơi') {
            showMessage('Chỉ có thể chuyển bàn đang chơi!', 'error');
            return;
        }
        document.getElementById('current-table-transfer').textContent = table.name;
        freeTablesList.innerHTML = '';
        const freeTables = Object.keys(tables).filter(id => tables[id].status === 'Trống' && id !== tableId);
        
        if (freeTables.length > 0) {
            freeTables.forEach(id => {
                const tableCard = document.createElement('div');
                tableCard.className = 'table-card status-trống';
                tableCard.textContent = tables[id].name;
                tableCard.onclick = () => transferTable(tableId, id);
                freeTablesList.appendChild(tableCard);
            });
        } else {
            freeTablesList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #666;">Hiện không có bàn trống nào.</p>';
        }
        transferModal.style.display = 'flex';
    }
    
    function transferTable(fromTableId, toTableId) {
        const fromTable = tables[fromTableId];
        const toTable = tables[toTableId];
        if (!fromTable || !toTable) return;

        const elapsedTime = Date.now() - fromTable.startTime;
        const elapsedHours = elapsedTime / (1000 * 60 * 60);
        const pricePerHourAtFromTable = getCurrentPricePerHour(fromTable.priceListId);
        const costSoFar = Math.ceil(elapsedHours * pricePerHourAtFromTable / 1000) * 1000;

        if (!toTable.accumulatedCost) toTable.accumulatedCost = 0;
        if (!toTable.accumulatedTime) toTable.accumulatedTime = 0;
        
        const previousAccumulatedCost = fromTable.accumulatedCost || 0;
        const previousAccumulatedTime = fromTable.accumulatedTime || 0;

        toTable.accumulatedCost = previousAccumulatedCost + costSoFar;
        toTable.accumulatedTime = previousAccumulatedTime + elapsedTime;
        
        toTable.status = 'Đang chơi';
        toTable.startTime = Date.now();
        toTable.products = [...fromTable.products];
        toTable.adjustments = [...fromTable.adjustments]; // Chuyển cả các khoản giảm trừ
        toTable.priceListId = toTable.priceListId; // Giữ nguyên loại bàn của bàn mới

        fromTable.status = 'Trống';
        fromTable.startTime = null;
        fromTable.products = [];
        fromTable.accumulatedCost = 0;
        fromTable.accumulatedTime = 0;
        fromTable.adjustments = [];

        transferModal.style.display = 'none';
        selectAndShowBill(toTableId);
        saveDataToLocalStorage();
        showMessage(`Đã chuyển ${fromTable.name} sang ${toTable.name} thành công!`);
    }
    
    // === BẮT ĐẦU: PHIÊN BẢN ĐÚNG CỦA HÀM openTableModal ===
window.openTableModal = function(tableId = null, event) {
    if (event) event.stopPropagation();
    
    const permissions = JSON.parse(localStorage.getItem('biaOxuUserPermissions')) || {};
    const tablePermissions = permissions.quanly_ban || {};
    const userRole = sessionStorage.getItem('userRole');
    const canProceed = userRole === 'admin' || (tableId ? tablePermissions.can_edit : tablePermissions.can_add);

    if (!canProceed) {
        showMessage('Bạn không có quyền thực hiện chức năng này!', 'error');
        return;
    }
    
    const priceListSelect = document.getElementById('table-price-list-select');
    priceListSelect.innerHTML = '';
    const priceLists = JSON.parse(localStorage.getItem(PRICE_LIST_STORAGE_KEY)) || {};
    if (Object.keys(priceLists).length === 0) {
        priceListSelect.innerHTML = '<option value="">--Không tìm thấy Bảng giá--</option>';
        showMessage('Vui lòng tạo ít nhất một Bảng giá trong Cài đặt trước!', 'error');
    } else {
        for(const id in priceLists) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = priceLists[id].name;
            priceListSelect.appendChild(option);
        }
    }

    const zoneSelect = document.getElementById('table-zone-select');
    const zones = JSON.parse(localStorage.getItem(ZONES_STORAGE_KEY)) || [];
    zoneSelect.innerHTML = '';
    zones.forEach(zone => {
        const option = document.createElement('option');
        option.value = zone;
        option.textContent = zone;
        zoneSelect.appendChild(option);
    });

    const modalTitle = document.getElementById('table-modal-title');
    const form = document.getElementById('table-form');
    const tableIdInput = document.getElementById('table-id-input');
    
    if (tableId) {
        // Chế độ SỬA BÀN
        const table = tables[tableId];
        if (table.status !== 'Trống') {
            showMessage('Chỉ có thể sửa bàn đang ở trạng thái "Trống"!', 'error');
            return;
        }
        modalTitle.textContent = 'Chỉnh sửa Bàn';
        tableIdInput.value = tableId;
        document.getElementById('table-name-input').value = table.name;
        priceListSelect.value = table.priceListId;
        zoneSelect.value = table.zone || zones[0];
    } else {
        // Chế độ THÊM MỚI BÀN
        form.reset(); // <<== SỬA LỖI: Di chuyển dòng reset() vào đây
        modalTitle.textContent = 'Thêm Bàn Mới';
        tableIdInput.value = '';
    }
    tableModal.style.display = 'flex';
}
// === KẾT THÚC: PHIÊN BẢN ĐÚNG CỦA HÀM openTableModal ===

    window.closeTableModal = function() {
        tableModal.style.display = 'none';
    }

    window.saveTableData = function() {
        const tableId = document.getElementById('table-id-input').value;
        const name = document.getElementById('table-name-input').value.trim();
        const priceListId = document.getElementById('table-price-list-select').value;
        const zone = document.getElementById('table-zone-select').value; // MỚI

        if (!name || !priceListId) {
            showMessage('Vui lòng điền đầy đủ thông tin!', 'error');
            return;
        }

        if (tableId) {
            tables[tableId].name = name;
            tables[tableId].priceListId = priceListId;
            tables[tableId].zone = zone; // MỚI
            showMessage('Cập nhật thông tin bàn thành công!');
        } else {
            const newId = `ban-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
            tables[newId] = {
                name: name,
                status: 'Trống',
                zone: zone, // <-- THÊM DÒNG NÀY
                startTime: null,
                products: [],
                priceListId: priceListId,
                accumulatedCost: 0,
                accumulatedTime: 0,
                adjustments: []
            };
            showMessage('Thêm bàn mới thành công!');
        }
        
        saveDataToLocalStorage();
        renderTableCards();
        closeTableModal();
    }

    window.deleteTable = function(tableId, event) {
        if (event) event.stopPropagation();

        const permissions = JSON.parse(localStorage.getItem('biaOxuUserPermissions')) || {};
        const tablePermissions = permissions.quanly_ban || {};

        if (userRole !== 'admin' && tablePermissions.can_delete !== true) {
            showMessage('Bạn không có quyền thực hiện chức năng này!', 'error');
            return;
        }
        
        const table = tables[tableId];
        if (table.status !== 'Trống') {
            showMessage('Chỉ có thể xóa bàn đang ở trạng thái "Trống"!', 'error');
            return;
        }
        if (confirm(`Bạn có chắc chắn muốn xóa "${table.name}" không?`)) {
            delete tables[tableId];
            saveDataToLocalStorage();
            showMessage(`Đã xóa "${table.name}" thành công!`);
            
            if (selectedTableId === tableId) {
               selectAndShowBill(null);
            }
            renderTableCards();
        }
    }

    // --- CẬP NHẬT: HỆ THỐNG GIẢM TRỪ / PHỤ THU MỚI ---
    window.openAdjustmentModal = function() {
    if (!selectedTableId) {
        showMessage('Vui lòng chọn bàn trước khi thao tác!', 'error');
        return;
    }
    document.getElementById('adjustment-form-modal').reset();
    // Dòng này đảm bảo ô nhập liệu luôn được làm trống
    document.getElementById('adj-value-input').value = ''; 
    adjustmentModal.style.display = 'flex';
}

    window.closeAdjustmentModal = function() {
        adjustmentModal.style.display = 'none';
    }

    window.saveAdjustment = function() {
        const table = tables[selectedTableId];
        if (!table) return;

        const type = document.querySelector('input[name="adj_type"]:checked').value;
        const applyTo = document.querySelector('input[name="adj_apply_to"]:checked').value;
        const method = document.querySelector('input[name="adj_method"]:checked').value;
        const value = parseFloat(document.getElementById('adj-value-input').value);
        const description = document.getElementById('adj-description-input').value.trim();

        if (!description || isNaN(value) || value < 0) {
            showMessage('Vui lòng nhập đầy đủ và chính xác thông tin!', 'error');
            return;
        }

        if (!table.adjustments) table.adjustments = [];
        
        table.adjustments.push({
            id: `adj-${Date.now()}`,
            type,
            applyTo,
            method,
            value,
            description
        });
        
        populateSidebar(table);
        saveDataToLocalStorage();
        closeAdjustmentModal();
        showMessage('Đã áp dụng thành công!', 'success');
    }

    window.removeAdjustment = function(tableId, adjustmentId) {
        const table = tables[tableId];
        if (table && table.adjustments) {
            table.adjustments = table.adjustments.filter(adj => adj.id !== adjustmentId);
            populateSidebar(table);
            saveDataToLocalStorage();
        }
    }

    function renderAdjustments(table, bill) {
        const container = document.getElementById('adjustments-list');
        if (!container) return;
        container.innerHTML = '';
        const adjustmentDetails = bill.adjustmentDetails || [];

/* if (adjustmentDetails.length === 0) {
            container.innerHTML = '<p style="font-size: 13px; color: #888; text-align: center; margin: 0;">Chưa có</p>';
            return;
        } */
        
        adjustmentDetails.forEach(adj => {
            const item = document.createElement('div');
            item.style.cssText = 'display: flex; justify-content: space-between; font-size: 14px; padding: 4px 0;';
            
            let detailText = adj.description;
            if (adj.method === 'percentage') {
                detailText += ` (${adj.value}%)`;
            }

            const amountColor = adj.calculatedAmount < 0 ? '#d32f2f' : '#388e3c';
            
            item.innerHTML = `
                <span>${detailText}</span>
                <span style="font-weight: 600; color: ${amountColor};">
                    ${formatCurrency(adj.calculatedAmount)}đ 
                    <button onclick="removeAdjustment('${selectedTableId}', '${adj.id}')" style="background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px;">&times;</button>
                </span>`;
            container.appendChild(item);
        });
    }

    // --- EVENT LISTENERS ---
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            tabContents.forEach(content => content.classList.remove('active'));
            document.getElementById(button.dataset.tab).classList.add('active');
            if (button.dataset.tab === 'menu-tab') {
                renderMenu();
            }
        });
    });

    window.addEventListener('click', (event) => {
        if (event.target === transferModal) transferModal.style.display = 'none';
        if (event.target === tableModal) closeTableModal();
        if (event.target === adjustmentModal) closeAdjustmentModal();
        if (event.target === document.getElementById('zone-management-modal')) closeZoneManagementModal(); // MỚI
    });
    
    // ===============================================================
    // ===== GẮN SỰ KIỆN CHO CÁC NÚT TÌM KIẾM VÀ LỌC MỚI =====
    // ===============================================================
    const billSearchInput = document.getElementById('bill-search-input');
    const billSortSelect = document.getElementById('bill-sort-select');

    billSearchInput.addEventListener('input', () => {
        currentPage = 1; // Reset về trang 1 mỗi khi tìm kiếm
        renderSavedBills();
    });

    billSortSelect.addEventListener('change', () => {
        currentPage = 1; // Reset về trang 1 mỗi khi đổi bộ lọc
        renderSavedBills();
    });

  // =======================================================================
// ===== BẮT ĐẦU: KHỐI CODE HOÀN CHỈNH CHO CHỨC NĂNG CHỌN KHÁCH HÀNG (PHIÊN BẢN ĐÃ SỬA LỖI) =====
// =======================================================================

// Biến toàn cục để lưu ID của bàn đang được chọn để gán khách
let currentTableIdForCustomerSelection = null;

/**
 * Mở cửa sổ (modal) để người dùng chọn khách hàng.
 * @param {string} tableId - ID của bàn cần gán khách.
 */
function openCustomerSelectionModal(tableId) {
    currentTableIdForCustomerSelection = tableId;
    const modal = document.getElementById('customer-selection-modal');
    const searchInput = document.getElementById('customer-search-modal-input');
    const listContainer = document.getElementById('customer-selection-list');
    
    let customers = [];
    try {
        const storedData = localStorage.getItem(CUSTOMERS_STORAGE_KEY);
        if (storedData) {
            customers = JSON.parse(storedData);
        }
    } catch (e) {
        console.error("Lỗi nghiêm trọng khi đọc dữ liệu khách hàng:", e);
        alert('Dữ liệu khách hàng bị lỗi, không thể tải danh sách. Vui lòng kiểm tra lại ở trang Quản lý Khách hàng.');
        return; // Dừng hàm nếu có lỗi nghiêm trọng
    }

    // Hàm dùng để render (vẽ) danh sách khách hàng ra màn hình
    const renderCustomerList = (filteredCustomers = customers) => {
        listContainer.innerHTML = ''; // Xóa danh sách cũ
        if (!filteredCustomers || filteredCustomers.length === 0) {
            listContainer.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">Không tìm thấy hoặc chưa có khách hàng.</p>';
            return;
        }

        filteredCustomers.forEach(customer => {
            const item = document.createElement('div');
            // Gán ID của khách hàng vào một thuộc tính data-* để dễ dàng truy xuất
            item.dataset.customerId = customer.id;
            item.innerHTML = `<strong>${customer.name}</strong> - SĐT: ${customer.phone}`;
            // CSS để làm cho danh sách trông đẹp hơn
            item.style.cssText = "padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color 0.2s;";
            item.onmouseover = () => { item.style.backgroundColor = '#f9f9f9'; };
            item.onmouseout = () => { item.style.backgroundColor = 'transparent'; };
            listContainer.appendChild(item);
        });
    };

    // Reset ô tìm kiếm và hiển thị danh sách ban đầu
    searchInput.value = '';
    renderCustomerList();

    // Gán sự kiện cho ô tìm kiếm
    searchInput.oninput = () => {
        const query = searchInput.value.toLowerCase().trim();
        const filtered = customers.filter(c =>
            c.name.toLowerCase().includes(query) ||
            c.phone.includes(query)
        );
        renderCustomerList(filtered);
    };

    // Hiển thị cửa sổ
    modal.style.display = 'flex';
}

/**
 * Gán khách hàng đã chọn cho bàn và đóng cửa sổ.
 * @param {string} customerId - ID của khách hàng được chọn.
 */
function assignCustomerToTable(customerId) {
    if (currentTableIdForCustomerSelection && tables[currentTableIdForCustomerSelection]) {
        const table = tables[currentTableIdForCustomerSelection];
        table.customerId = customerId;

        saveDataToLocalStorage();
        populateSidebar(table); // Cập nhật lại sidebar để hiển thị tên khách
        
        // Lấy tên khách hàng để hiển thị thông báo
        const allCustomers = JSON.parse(localStorage.getItem(CUSTOMERS_STORAGE_KEY)) || [];
        const selectedCustomer = allCustomers.find(c => c.id === customerId);
        if (selectedCustomer) {
            showMessage(`Đã gán khách hàng "${selectedCustomer.name}" cho bàn ${table.name}.`);
        }
        
        closeCustomerSelectionModal();
    }
}

/**
 * Đóng cửa sổ chọn khách hàng và reset biến tạm.
 */
function closeCustomerSelectionModal() {
    const modal = document.getElementById('customer-selection-modal');
    if (modal) {
        modal.style.display = 'none';
    }
    currentTableIdForCustomerSelection = null;
}

// Gắn sự kiện click tập trung cho toàn bộ danh sách khách hàng
// Kỹ thuật này hiệu quả hơn là gắn sự kiện cho từng dòng
const customerListContainer = document.getElementById('customer-selection-list');
if (customerListContainer) {
    customerListContainer.addEventListener('click', (event) => {
        // Tìm phần tử cha gần nhất có thuộc tính data-customer-id
        const clickedItem = event.target.closest('[data-customer-id]');
        if (clickedItem) {
            const customerId = clickedItem.dataset.customerId;
            assignCustomerToTable(customerId);
        }
    });
}
// ===================================================================
// ===== KẾT THÚC: KHỐI CODE HOÀN CHỈNH CHO CHỨC NĂNG CHỌN KHÁCH HÀNG (PHIÊN BẢN ĐÃ SỬA LỖI) =====
// ===================================================================

    // --- KHỞI TẠO ---
    initializeData();
    renderZoneTabs(); 
    renderTableCards();
    updateQuickDashboard(); // <--- THÊM DÒNG NÀY VÀO ĐÂY
    renderMenu();
    renderSavedBills();
    startGlobalTimer();

    handleAutoCheckinFromBooking(); 
});

// TÌM VÀ THAY THẾ TOÀN BỘ HÀM NÀY Ở CUỐI file quanly_ban.html

function loadInvoiceSettings() {
    // Biến tạm để lưu trữ logo, phòng trường hợp đọc lỗi
    let lastKnownLogo = sessionStorage.getItem('lastKnownLogoUrl'); 

    try {
        const settingsJSON = localStorage.getItem('invoice-form');
        const generalSettingsJSON = localStorage.getItem('general-form');

        const invoiceSettings = settingsJSON ? JSON.parse(settingsJSON) : {};
        const generalSettings = generalSettingsJSON ? JSON.parse(generalSettingsJSON) : {};
        
        // Nếu đọc được logo mới, lưu nó vào biến tạm
        if (invoiceSettings['logo-data-url']) {
            sessionStorage.setItem('lastKnownLogoUrl', invoiceSettings['logo-data-url']);
            lastKnownLogo = invoiceSettings['logo-data-url'];
        }

        return {
            mainTitle: invoiceSettings['invoice-main-title'] || 'HÓA ĐƠN THANH TOÁN',
            showStoreName: invoiceSettings['show-store-name'] !== false,
            showAddress: invoiceSettings['show-address'] !== false,
            showPhone: invoiceSettings['show-phone'] !== false,
            showTaxCode: invoiceSettings['show-tax-code'] === true,
            showCashier: invoiceSettings['show-cashier'] === 'yes',
            footerText: invoiceSettings['invoice-footer-text'] || 'Cảm ơn quý khách và hẹn gặp lại!',
            storeName: generalSettings['store-name'] || 'BI-A OXU',
            address: generalSettings['address'] || '',
            phone: generalSettings['phone'] || '',
            taxCode: generalSettings['tax-code'] || '',
            showLogo: invoiceSettings['show-logo'] === 'yes',
            // Dùng logo mới đọc được, hoặc logo cũ nếu đọc lỗi
            logoDataUrl: invoiceSettings['logo-data-url'] || lastKnownLogo 
        };
    } catch (e) {
        console.error("Lỗi khi tải cài đặt hóa đơn, đang sử dụng cài đặt dự phòng:", e);
        // Nếu xảy ra lỗi nghiêm trọng, trả về giá trị mặc định nhưng vẫn cố gắng dùng logo đã lưu
        return {
            mainTitle: 'HÓA ĐƠN THANH TOÁN',
            showStoreName: true, showAddress: true, showPhone: true, showTaxCode: false,
            showCashier: true,
            footerText: 'Cảm ơn quý khách và hẹn gặp lại!',
            storeName: 'BI-A OXU', address: '', phone: '', taxCode: '',
            showLogo: true, // Mặc định là có hiển thị
            logoDataUrl: lastKnownLogo // Dùng logo cuối cùng được biết đến
        };
    }
}

// === LOGIC CẬP NHẬT TÊN QUÁN VÀ HOTLINE TỪ CÀI ĐẶT ===
function updateStoreInfo() {
    const savedData = localStorage.getItem('general-form');
    if (savedData) {
        try {
            const settings = JSON.parse(savedData);
            const storeNameElement = document.querySelector('.main-header .app-name');
            if (storeNameElement && settings['store-name']) {
                storeNameElement.innerHTML = `<i class="fa-solid fa-gem"></i> ${settings['store-name']}`;
            }
            const phoneElement = document.querySelector('.main-footer .phone-info');
            if (phoneElement && settings.phone) {
                phoneElement.innerHTML = `<i class="fa-solid fa-phone"></i> Hotline: ${settings.phone}`;
            }
            const copyrightElement = document.querySelector('.main-footer .copyright-info');
            if (copyrightElement && settings['store-name']) {
                copyrightElement.innerHTML = `<i class="fa-solid fa-copyright"></i> 2025 ${settings['store-name']}. All rights reserved.`;
            }
        } catch(e) { console.error("Lỗi khi cập nhật thông tin quán:", e); }
    }
}
document.addEventListener('DOMContentLoaded', updateStoreInfo);

// === LOGIC NÚT ĐĂNG XUẤT ===
document.addEventListener('DOMContentLoaded', () => {
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            sessionStorage.clear();
            window.location.href = 'login.html';
        });
    }
});
    </script>
    <iframe id="print-frame" style="display: none;"></iframe>

    <div id="payment-success-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 10001; justify-content: center; align-items: center; color: white; text-align: center;">
        <div style="background-color: #28a745; padding: 40px 60px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);">
            <i class="fa-solid fa-circle-check" style="font-size: 80px; margin-bottom: 20px;"></i>
            <h2 style="margin: 0; font-size: 28px; font-weight: 600;">Thanh toán hoàn tất!</h2>
            <p style="font-size: 16px; opacity: 0.9;">Hóa đơn đang được in...</p>
        </div>
    </div>
    <div id="zone-management-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>Quản lý Khu vực / Tầng</h4>
            <span class="modal-close" onclick="closeZoneManagementModal()">&times;</span>
        </div>

        <form id="zone-form" onsubmit="event.preventDefault(); saveZone();">
            <input type="hidden" id="zone-edit-index-input"> <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex-grow: 1;">
                    <label for="zone-name-input">Tên khu vực</label>
                    <input type="text" id="zone-name-input" placeholder="Ví dụ: Sân Thượng" required>
                </div>
                <button type="submit" class="btn btn-primary">Lưu</button>
            </div>
        </form>

        <hr>

        <h4>Các khu vực hiện có:</h4>
        <div id="existing-zones-list" style="max-height: 250px; overflow-y: auto;">
            </div>

        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeZoneManagementModal()">Đóng</button>
        </div>
    </div>
</div>
</body>
</html>