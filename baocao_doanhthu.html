<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo Doanh thu & Phân tích - PHẦN MỀM QUẢN LÝ QUÁN BI-A</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <style>
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #1976d2;
            --text-color: #333;
            --light-text-color: #f0f4f8;
            --background-color: #eef2f6;
            --card-background: #ffffff;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-dark: 0 2px 10px rgba(0, 0, 0, 0.15);
            --profit-color: #2e7d32;
            --zero-cost-warning-bg: #fffde7;
        }
        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--background-color); color: var(--text-color); }
        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        .content-wrapper { flex: 1; padding: 20px; }
        .main-panel { background-color: var(--card-background); padding: 40px; border-radius: 12px; box-shadow: var(--shadow-light); }
        h2 { color: var(--primary-color); margin-top: 0; }
        
        /* === TAB NAVIGATION === */
        .tab-nav { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .tab-nav button { background-color: transparent; border: none; padding: 15px 25px; cursor: pointer; font-size: 16px; font-weight: 500; color: #999; transition: all 0.3s ease; position: relative; display: flex; align-items: center; gap: 8px; }
        .tab-nav button.active { color: var(--primary-color); font-weight: 600; }
        .tab-nav button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .report-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; background-color: var(--background-color); padding: 15px; border-radius: 8px; }
        .report-controls label { font-weight: 500; }
        .report-controls input[type="date"] { padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-family: 'Poppins', sans-serif; }
        .report-controls .btn { padding: 8px 15px; border: 1px solid #ccc; background-color: white; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; }
        .report-controls .btn:hover, .report-controls .btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .report-controls .btn-export { margin-left: auto; background-color: #1a237e; color: white; border: none; }
        .report-controls .btn-export:hover { background-color: #0d47a1; }
        
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .summary-card { background-color: var(--background-color); padding: 20px; border-radius: 8px; }
        .summary-card.revenue { border-left: 5px solid var(--primary-color); }
        .summary-card.profit { border-left: 5px solid var(--profit-color); }
        .summary-card.bills { border-left: 5px solid #ffa000; }
        .summary-card.items { border-left: 5px solid #d32f2f; }
        .summary-card h3 { margin: 0 0 10px 0; font-size: 16px; color: #555; display: flex; align-items: center; gap: 8px; }
        .summary-card .value { font-size: 28px; font-weight: 600; }
        .summary-card.revenue .value { color: var(--primary-color); }
        .summary-card.profit .value { color: var(--profit-color); }

        .report-body { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-top: 30px; }
        .sales-table { width: 100%; border-collapse: collapse; }
        .sales-table th, .sales-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .sales-table th { background-color: var(--background-color); font-weight: 600; }
        .sales-table tr:hover { background-color: #f9f9f9; }
        .sales-table tr.zero-cost-warning { background-color: var(--zero-cost-warning-bg) !important; }
        .sales-table tr.zero-cost-warning:hover { background-color: #fff9c4 !important; }

        .chart-container { padding: 20px; background-color: var(--background-color); border-radius: 8px; }
        .full-width-container { grid-column: 1 / -1; }

        .tooltip-container { position: relative; display: inline-block; cursor: pointer; }
        .tooltip-container .tooltip-text { visibility: hidden; width: 220px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 12px; font-weight: 400; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        .header-with-controls { display: flex; justify-content: space-between; align-items: center; }
        /* THÊM ĐOẠN CSS NÀY VÀO TRONG THẺ <style> */

/* TÌM VÀ THAY THẾ BẰNG KHỐI CSS HOÀN CHỈNH NÀY */

.report-filters {
    background: var(--background-color);
    padding: 15px;
    border-radius: 8px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
}
.report-filters label {
    font-weight: 500;
}
.report-filters input[type="date"] {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-family: 'Poppins', sans-serif;
}
.date-quick-filters { 
    display: flex; 
    gap: 10px; 
    margin-left: 15px; 
}
.quick-filter-btn { 
    padding: 6px 14px; 
    font-size: 13px; 
    border: 1px solid #ccc; 
    background-color: #fff; 
    color: var(--text-color); 
    border-radius: 20px; 
    cursor: pointer; 
    transition: all 0.2s ease; 
    font-family: 'Poppins', sans-serif; 
}
.quick-filter-btn:hover { 
    background-color: #f0f0f0; 
    border-color: var(--secondary-color); 
}
.quick-filter-btn.active { 
    background-color: var(--primary-color); 
    color: var(--light-text-color); 
    border-color: var(--primary-color); 
}

        /* === HEADER, NAV & FOOTER === */
        .main-header { background-color: var(--card-background); box-shadow: var(--shadow-light); height: 70px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; z-index: 100; }
        .main-header .app-name { font-size: 24px; font-weight: 600; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .main-header .app-name i { color: var(--secondary-color); }
        .main-nav ul { list-style: none; margin: 0; padding: 0; display: flex; align-items: center; }
        .main-nav li { position: relative; margin: 0 5px; }
        .main-nav a { text-decoration: none; color: var(--text-color); padding: 12px 18px; display: flex; align-items: center; gap: 10px; font-size: 15px; font-weight: 500; border-radius: 8px; transition: all 0.3s ease; }
        .main-nav a i { font-size: 18px; color: var(--secondary-color); }
        .main-nav a:hover, .main-nav li.active a { background-color: var(--background-color); color: var(--primary-color); }
        .main-nav li.active a i { color: var(--primary-color); }
        .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; background-color: var(--card-background); border-radius: 8px; box-shadow: var(--shadow-dark); min-width: 220px; z-index: 99; list-style: none; padding: 10px 0; margin-top: 10px; transform: translateY(10px); opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .has-dropdown:hover .dropdown-menu { display: block; transform: translateY(0); opacity: 1; visibility: visible; }
        .dropdown-menu a { padding: 12px 20px; white-space: nowrap; display: flex; align-items: center; gap: 12px; color: var(--text-color); border-radius: 0; font-size: 14px; }
        .dropdown-menu a i { font-size: 16px; color: var(--secondary-color); }
        .dropdown-menu a:hover, .dropdown-menu a.active { background-color: var(--background-color); color: var(--primary-color); }
        .main-footer { background-color: var(--primary-color); color: var(--light-text-color); padding: 20px 30px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        .footer-info, .user-info { display: flex; gap: 25px; }
        .main-footer i { margin-right: 5px; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="main-header">
            <a href="index.html" style="text-decoration: none;"><h1 class="app-name"><i class="fa-solid fa-gem"></i> BI-A OXU</h1></a>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class="fa-solid fa-chart-line"></i> Trang chủ</a></li>
                    
                    <li class="has-dropdown">
                        <a href="#"><i class="fa-solid fa-boxes-stacked"></i> Quản lý</a>
                        <ul class="dropdown-menu">
                            <li><a href="quanly_ban.html"><i class="fa-solid fa-table-tennis-paddle-ball"></i> Quản lý bàn</a></li>
                            <li><a href="quanly_khachhang.html"><i class="fa-solid fa-address-book"></i> Quản lý Khách hàng</a></li>
                            <li><a href="quanly_datban.html"><i class="fa-solid fa-calendar-check"></i> Quản lý Đặt bàn</a></li>
                            <li><a href="quanly_thuchi.html"><i class="fa-solid fa-cash-register"></i> Quản lý thu chi</a></li>
                            <li><a href="quanly_kho.html"><i class="fa-solid fa-box-open"></i> Quản lý kho</a></li>
                            <li><a href="quanly_nhanvien.html"><i class="fa-solid fa-users"></i> Quản lý nhân viên</a></li>
                        </ul>
                    </li>
            
                    <li class="has-dropdown active">
                        <a href="#"><i class="fa-solid fa-chart-pie"></i> Báo cáo</a>
                        <ul class="dropdown-menu">
                            <li><a href="baocao_doanhthu.html" class="active"><i class="fa-solid fa-file-invoice"></i> Doanh thu ngày</a></li>
                            <li><a href="baocao_thongke.html"><i class="fa-solid fa-chart-bar"></i> Thống kê tuần</a></li>
                            <li><a href="baocao_loinhuan.html"><i class="fa-solid fa-file-contract"></i> Báo cáo nhân viên</a></li>
                             <li><a href="baocao_khachhang.html"><i class="fa-solid fa-user-tag"></i> Phân tích Khách hàng</a></li>
                        </ul>
                    </li>
            
                    <li><a href="cai_dat.html"><i class="fa-solid fa-gear"></i> Cài đặt</a></li>
                    <li><a href="tro_giup.html"><i class="fa-solid fa-circle-question"></i> Trợ giúp</a></li>
                    <li><a href="#" id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a></li>
                </ul>
            </nav>
        </header>

        <div class="content-wrapper">
            <main class="main-panel">
                <h2>Báo cáo Bán hàng & Phân tích</h2>
                <div class="report-filters">
    <label for="date-start">Từ ngày:</label>
    <input type="date" id="date-start">
    <label for="date-end">Đến ngày:</label>
    <input type="date" id="date-end">
    <div class="date-quick-filters">
        <button class="quick-filter-btn" data-range="today">Hôm nay</button>
        <button class="quick-filter-btn" data-range="yesterday">Hôm qua</button>
        <button class="quick-filter-btn" data-range="last7days">7 ngày qua</button>
        <button class="quick-filter-btn" data-range="lastmonth">Tháng qua</button>
    </div>
    <button id="export-btn" style="margin-left: auto;" class="quick-filter-btn active"><i class="fa-solid fa-file-excel"></i> Xuất Excel</button>
</div>
                <hr>
                
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="overview-tab"><i class="fa-solid fa-tachograph-digital"></i> Tổng quan</button>
                    <button class="tab-btn" data-tab="top-items-tab"><i class="fa-solid fa-trophy"></i> Món Bán Chạy</button>
                    <button class="tab-btn" data-tab="peak-hours-tab"><i class="fa-solid fa-clock"></i> Giờ Cao Điểm</button>
                </div>

                <div id="overview-tab" class="tab-content active">
                    <div class="summary-cards">
                        <div class="summary-card revenue">
                            <h3><i class="fa-solid fa-sack-dollar"></i> Tổng Doanh Thu</h3>
                            <p class="value" id="total-revenue">0đ</p>
                        </div>
                        <div class="summary-card profit">
                             <h3><i class="fa-solid fa-money-bill-trend-up"></i> Lợi Nhuận Gộp 
                                <div class="tooltip-container">
                                    <i class="fa-solid fa-circle-info"></i>
                                    <span class="tooltip-text">Lợi nhuận được ước tính dựa trên giá vốn của lần nhập hàng gần đây nhất.</span>
                                </div>
                            </h3>
                            <p class="value" id="total-profit">0đ</p>
                        </div>
                        <div class="summary-card bills">
                            <h3><i class="fa-solid fa-receipt"></i> Số Hóa Đơn</h3>
                            <p class="value" id="total-bills">0</p>
                        </div>
                        <div class="summary-card items">
                            <h3><i class="fa-solid fa-boxes-stacked"></i> Sản Phẩm Bán Ra</h3>
                            <p class="value" id="total-items-sold">0</p>
                        </div>
                    </div>

                    <div class="report-body">
                        <div class="table-container">
                            <table class="sales-table">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>Tên Mặt Hàng</th>
                                        <th>SL Bán</th>
                                        <th>Doanh Thu</th>
                                        <th>Lợi Nhuận Ước Tính</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-summary-table-body"></tbody>
                            </table>
                        </div>
                        <div class="chart-container">
                             <h3 style="text-align: center; color: var(--text-color);">Tỉ trọng Doanh thu (Top 5)</h3>
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="top-items-tab" class="tab-content">
                    <div class="header-with-controls">
                        <h3>Xếp hạng các mặt hàng bán chạy nhất</h3>
                        <div>
                            <label>Sắp xếp theo:</label>
                            <button class="btn active" id="sort-by-quantity">Số lượng</button>
                            <button class="btn" id="sort-by-revenue">Doanh thu</button>
                        </div>
                    </div>
                    <div class="table-container full-width-container" style="margin-top: 15px;">
                        <table class="sales-table">
                            <thead>
                                <tr>
                                    <th>Hạng</th>
                                    <th>Tên Mặt Hàng</th>
                                    <th>Số Lượng Bán</th>
                                    <th>Tổng Doanh Thu</th>
                                    <th>Lợi Nhuận Ước Tính</th>
                                </tr>
                            </thead>
                            <tbody id="top-items-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="peak-hours-tab" class="tab-content">
                     <h3>Phân tích Giờ Cao Điểm</h3>
                     <div class="report-body" style="grid-template-columns: 1fr;">
                        <div class="chart-container full-width-container">
                            <h4 style="text-align: center;">Doanh thu theo Giờ trong ngày</h4>
                            <canvas id="peak-hours-chart"></canvas>
                        </div>
                        <div class="table-container full-width-container">
                             <table class="sales-table">
                                <thead>
                                    <tr>
                                        <th>Khung Giờ</th>
                                        <th>Số Hóa Đơn</th>
                                        <th>Tổng Doanh Thu</th>
                                    </tr>
                                </thead>
                                <tbody id="peak-hours-table-body"></tbody>
                            </table>
                        </div>
                     </div>
                </div>

            </main>
        </div>

        <footer class="main-footer">
            <div class="footer-info">
                <span class="copyright-info"><i class="fa-solid fa-copyright"></i> 2025 BI-A OXU. All rights reserved.</span>
                <span class="phone-info"><i class="fa-solid fa-phone"></i> Hotline: </span>
            </div>
            <div class="user-info">
                <span id="footer-username"><i class="fa-solid fa-user"></i> Người dùng: </span>
                <span><i class="fa-solid fa-circle-check"></i> Trạng thái: OK</span>
            </div>
        </footer>
    </div>

     <script>
        // *** PERMISSION CHECK ***
        (function() {
            const PAGE_FEATURE_ID = 'baocao_doanhthu';
            const userRole = sessionStorage.getItem('userRole');
            if (userRole === 'user') {
                const permissions = JSON.parse(localStorage.getItem('biaOxuUserPermissions')) || {};
                const hasPermission = permissions[PAGE_FEATURE_ID] && permissions[PAGE_FEATURE_ID].access === true;
                if (!hasPermission) {
                    document.body.style.display = 'none';
                    alert('Bạn không có quyền truy cập chức năng này.');
                    window.location.href = 'index.html';
                }
            }
        })();
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // === DOM ELEMENTS ===
        const dateStartPicker = document.getElementById('date-start');
        const dateEndPicker = document.getElementById('date-end');
        const exportBtn = document.getElementById('export-btn');
        const quickSelectButtons = document.querySelectorAll('#quick-select-buttons .btn');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        const totalRevenueEl = document.getElementById('total-revenue');
        const totalProfitEl = document.getElementById('total-profit');
        const totalBillsEl = document.getElementById('total-bills');
        const totalItemsSoldEl = document.getElementById('total-items-sold');
        const overviewTableBody = document.getElementById('sales-summary-table-body');
        
        const topItemsTableBody = document.getElementById('top-items-table-body');
        const sortByQuantityBtn = document.getElementById('sort-by-quantity');
        const sortByRevenueBtn = document.getElementById('sort-by-revenue');
        
        const peakHoursTableBody = document.getElementById('peak-hours-table-body');

        // === APP STATE ===
        const SAVED_BILLS_STORAGE_KEY = 'biaOxuSavedBills';
        const STOCK_IN_HISTORY_KEY = 'biaOxuStockInHistory';
        let salesChart = null;
        let peakHoursChart = null;
        let topItemsSortBy = 'quantity';
        let currentReportData = [];

        // === DYNAMIC HEADER/FOOTER INFO ===
        (function() {
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            if (loggedInUser) {
                document.getElementById('footer-username').innerHTML = `<i class="fa-solid fa-user"></i> Người dùng: ${loggedInUser}`;
            }
            const savedData = localStorage.getItem('general-form');
            if (savedData) {
                const settings = JSON.parse(savedData);
                if (settings['store-name']) {
                    document.querySelector('.main-header .app-name').innerHTML = `<i class="fa-solid fa-gem"></i> ${settings['store-name']}`;
                    document.querySelector('.main-footer .copyright-info').innerHTML = `<i class="fa-solid fa-copyright"></i> 2025 ${settings['store-name']}. All rights reserved.`;
                }
                if (settings.phone) {
                    document.querySelector('.main-footer .phone-info').innerHTML = `<i class="fa-solid fa-phone"></i> Hotline: ${settings.phone}`;
                }
            }
        })();

        // === UTILITY FUNCTIONS ===
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(Math.round(amount)) + 'đ';
        }

        function getCostPrice(productId, stockInHistory) {
            const productHistory = stockInHistory
                .filter(entry => entry.productId === productId)
                .sort((a, b) => new Date(b.rawTimestamp) - new Date(a.rawTimestamp));
            return productHistory.length > 0 ? productHistory[0].cost : 0;
        }

        // === MASTER REPORT GENERATION LOGIC ===
        function generateAllReports() {
            const startDate = dateStartPicker.value;
            const endDate = dateEndPicker.value;
            
            const allSavedBills = JSON.parse(localStorage.getItem(SAVED_BILLS_STORAGE_KEY)) || [];
            currentReportData = allSavedBills.filter(bill => {
                const billDate = new Date(bill.endTime).toISOString().split('T')[0];
                return billDate >= startDate && billDate <= endDate;
            });

            const stockInHistory = JSON.parse(localStorage.getItem(STOCK_IN_HISTORY_KEY)) || [];
            
            const salesSummary = {};
            currentReportData.forEach(bill => {
                (bill.products || []).forEach(product => {
                    const costPrice = getCostPrice(product.id, stockInHistory);
                    const profit = (product.price - costPrice) * product.quantity;
                    if (salesSummary[product.id]) {
                        salesSummary[product.id].quantity += product.quantity;
                        salesSummary[product.id].revenue += product.price * product.quantity;
                        salesSummary[product.id].profit += profit;
                    } else {
                        salesSummary[product.id] = {
                            id: product.id, name: product.name,
                            quantity: product.quantity,
                            revenue: product.price * product.quantity,
                            profit: profit, costPrice: costPrice
                        };
                    }
                });
            });
            const aggregatedData = Object.values(salesSummary);

            renderOverviewTab(currentReportData, aggregatedData);
            renderTopItemsTab(aggregatedData);
            renderPeakHoursTab(currentReportData);
        }

        // === TAB-SPECIFIC RENDER FUNCTIONS ===
        function renderOverviewTab(bills, summary) {
            let totalRevenue = 0, totalProfit = 0, totalItemsSold = 0;
            bills.forEach(bill => totalRevenue += bill.totalAmount);
            summary.forEach(item => {
                totalProfit += item.profit;
                totalItemsSold += item.quantity;
            });

            totalRevenueEl.textContent = formatCurrency(totalRevenue);
            totalProfitEl.textContent = formatCurrency(totalProfit);
            totalBillsEl.textContent = bills.length;
            totalItemsSoldEl.textContent = totalItemsSold;

            overviewTableBody.innerHTML = '';
            if (summary.length === 0) {
                overviewTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #888;">Không có dữ liệu bán hàng.</td></tr>`;
                if (salesChart) { salesChart.destroy(); salesChart = null; }
                return;
            }

            const sortedItems = [...summary].sort((a, b) => b.revenue - a.revenue);
            sortedItems.forEach((item, index) => {
                const isZeroCost = item.costPrice === 0 && item.revenue > 0;
                const rowClass = isZeroCost ? 'zero-cost-warning' : '';
                const rowTitle = isZeroCost ? 'Cảnh báo: Không tìm thấy giá vốn cho mặt hàng này. Lợi nhuận có thể không chính xác.' : '';
                
                const row = `
                    <tr class="${rowClass}" title="${rowTitle}">
                        <td>${index + 1}</td>
                        <td><b>${item.name}</b></td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.revenue)}</td>
                        <td style="color: ${item.profit >= 0 ? 'var(--profit-color)' : 'red'}">${formatCurrency(item.profit)}</td>
                    </tr>
                `;
                overviewTableBody.innerHTML += row;
            });
            
            renderOverviewChart(sortedItems);
        }
        
        function renderOverviewChart(data) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const topItems = data.slice(0, 5);
            const otherItemsRevenue = data.slice(5).reduce((acc, item) => acc + item.revenue, 0);
            const labels = topItems.map(item => item.name);
            const revenueData = topItems.map(item => item.revenue);
            
            if (otherItemsRevenue > 0) {
                labels.push('Khác');
                revenueData.push(otherItemsRevenue);
            }

            if (salesChart) salesChart.destroy();
            salesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: revenueData,
                        backgroundColor: ['#0d47a1', '#1976d2', '#42a5f5', '#90caf9', '#e3f2fd', '#bbdefb'],
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: c => `${c.label}: ${formatCurrency(c.parsed)}` } } } }
            });
        }

        function renderTopItemsTab(summary) {
            topItemsTableBody.innerHTML = '';
            if (summary.length === 0) {
                topItemsTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #888;">Không có dữ liệu.</td></tr>`;
                return;
            }
            
            const sorted = [...summary].sort((a, b) => b[topItemsSortBy] - a[topItemsSortBy]);
            
            sorted.forEach((item, index) => {
                const row = `
                    <tr>
                        <td><b>#${index + 1}</b></td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.revenue)}</td>
                        <td style="color: ${item.profit >= 0 ? 'var(--profit-color)' : 'red'}">${formatCurrency(item.profit)}</td>
                    </tr>
                `;
                topItemsTableBody.innerHTML += row;
            });
        }

        function renderPeakHoursTab(bills) {
            const hourlyData = Array.from({ length: 24 }, (_, i) => ({ hour: i, bills: 0, revenue: 0 }));
            bills.forEach(bill => {
                const hour = new Date(bill.endTime).getHours();
                hourlyData[hour].bills++;
                hourlyData[hour].revenue += bill.totalAmount;
            });

            peakHoursTableBody.innerHTML = '';
            const sortedHours = [...hourlyData].sort((a,b) => b.revenue - a.revenue);
            sortedHours.forEach(data => {
                const row = `
                    <tr>
                        <td>${String(data.hour).padStart(2, '0')}:00 - ${String(data.hour).padStart(2, '0')}:59</td>
                        <td>${data.bills}</td>
                        <td>${formatCurrency(data.revenue)}</td>
                    </tr>
                `;
                peakHoursTableBody.innerHTML += row;
            });

            const ctx = document.getElementById('peak-hours-chart').getContext('2d');
            if(peakHoursChart) peakHoursChart.destroy();
            peakHoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hourlyData.map(d => `${d.hour}h`),
                    datasets: [{
                        label: 'Doanh thu',
                        data: hourlyData.map(d => d.revenue),
                        backgroundColor: 'rgba(25, 118, 210, 0.6)',
                        borderColor: 'rgba(25, 118, 210, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } } },
                    plugins: { tooltip: { callbacks: { label: c => formatCurrency(c.raw) } } }
                }
            });
        }

       //== BẮT ĐẦU ĐOẠN MỚI ĐỂ DÁN VÀO ==//

// Lấy các nút bấm mới dựa trên class 'quick-filter-btn'
const quickFilterBtns = document.querySelectorAll('.quick-filter-btn');

quickFilterBtns.forEach(btn => {
    // Không áp dụng logic này cho nút "Xuất Excel"
    if (btn.id === 'export-btn') return;

    btn.addEventListener('click', () => {
        // Xóa trạng thái 'active' khỏi tất cả các nút
        quickFilterBtns.forEach(b => b.classList.remove('active'));
        // Thêm trạng thái 'active' cho nút vừa được bấm
        btn.classList.add('active');

        const range = btn.dataset.range;
        const today = new Date();
        let startDate = new Date();
        let endDate = new Date();

        switch (range) {
            case 'today':
                startDate = today;
                endDate = today;
                break;
            case 'yesterday':
                startDate = new Date();
                startDate.setDate(today.getDate() - 1);
                endDate = startDate;
                break;
            case 'last7days': // Cập nhật data-range từ '7days' thành 'last7days'
                startDate = new Date();
                startDate.setDate(today.getDate() - 6);
                endDate = today;
                break;
            case 'lastmonth': // Cập nhật data-range từ 'this_month' thành 'lastmonth'
                startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                break;
        }

        // Dùng valueAsDate để tương thích tốt hơn
        dateStartPicker.valueAsDate = startDate;
        dateEndPicker.valueAsDate = endDate;
        generateAllReports(); // Gọi hàm để cập nhật lại báo cáo
    });
});

// Thêm logic: nếu người dùng tự chọn ngày thì xóa trạng thái 'active' của các nút
dateStartPicker.addEventListener('change', () => quickFilterBtns.forEach(b => b.classList.remove('active')));
dateEndPicker.addEventListener('change', () => quickFilterBtns.forEach(b => b.classList.remove('active')));

//== KẾT THÚC ĐOẠN MỚI ĐỂ DÁN VÀO ==//

        function exportToExcel() {
            const activeTabId = document.querySelector('.tab-btn.active').dataset.tab;
            let tableToExport, fileName;
            if (activeTabId === 'overview-tab') {
                tableToExport = document.querySelector("#overview-tab .sales-table");
                fileName = `BaoCaoTongQuan_${dateStartPicker.value}_den_${dateEndPicker.value}.csv`;
            } else if (activeTabId === 'top-items-tab') {
                tableToExport = document.querySelector("#top-items-tab .sales-table");
                fileName = `MonBanChay_${dateStartPicker.value}_den_${dateEndPicker.value}.csv`;
            } else {
                tableToExport = document.querySelector("#peak-hours-tab .sales-table");
                fileName = `GioCaoDiem_${dateStartPicker.value}_den_${dateEndPicker.value}.csv`;
            }
            if (!tableToExport) return;
            const rows = tableToExport.querySelectorAll("tr");
            if (rows.length <= 1) {
                alert("Không có dữ liệu để xuất.");
                return;
            }
            let csvContent = "\uFEFF";
            rows.forEach(row => {
                let rowData = [];
                row.querySelectorAll("th, td").forEach(cell => {
                    let cellData = cell.innerText.replace(/đ/g, '').replace(/,/g, '');
                    rowData.push(`"${cellData}"`);
                });
                csvContent += rowData.join(",") + "\r\n";
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // === INITIALIZATION & EVENT LISTENERS ===
        dateStartPicker.addEventListener('change', () => {
            quickSelectButtons.forEach(btn => btn.classList.remove('active'));
            generateAllReports();
        });
        dateEndPicker.addEventListener('change', () => {
            quickSelectButtons.forEach(btn => btn.classList.remove('active'));
            generateAllReports();
        });
 //       quickSelectButtons.forEach(btn => btn.addEventListener('click', handleQuickSelect));
        exportBtn.addEventListener('click', exportToExcel);
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });
        sortByQuantityBtn.addEventListener('click', () => {
            topItemsSortBy = 'quantity';
            sortByQuantityBtn.classList.add('active');
            sortByRevenueBtn.classList.remove('active');
            renderTopItemsTab(Object.values(JSON.parse(localStorage.getItem('tempAggData') || '{}')));
        });
        sortByRevenueBtn.addEventListener('click', () => {
            topItemsSortBy = 'revenue';
            sortByRevenueBtn.classList.add('active');
            sortByQuantityBtn.classList.remove('active');
            renderTopItemsTab(Object.values(JSON.parse(localStorage.getItem('tempAggData') || '{}')));
        });
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            sessionStorage.clear();
            window.location.href = 'login.html';
        });

        // Initial load
        const today = new Date().toISOString().split('T')[0];
        dateStartPicker.value = today;
        dateEndPicker.value = today;
        document.querySelector('#quick-select-buttons .btn[data-range="today"]').classList.add('active');
        
        // Caching aggregated data to avoid recalculation on sort
        let aggregatedDataCache = {};
        const originalGenerateAllReports = generateAllReports;
        generateAllReports = function() {
            originalGenerateAllReports();
            const summary = {};
            currentReportData.forEach(bill => {
                (bill.products || []).forEach(product => {
                    if (summary[product.id]) {
                        summary[product.id].quantity += product.quantity;
                        summary[product.id].revenue += product.price * product.quantity;
                    } else {
                        summary[product.id] = { id: product.id, name: product.name, quantity: product.quantity, revenue: product.price * product.quantity };
                    }
                });
            });
            localStorage.setItem('tempAggData', JSON.stringify(summary));
        };
        generateAllReports();
    });
    </script>
</body>
</html>