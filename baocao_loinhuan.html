<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo Nhân sự - PHẦN MỀM QUẢN LÝ QUÁN BI-A</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <script>
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>

    <style>
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #1976d2;
            --text-color: #333;
            --light-text-color: #f0f4f8;
            --background-color: #eef2f6;
            --card-background: #ffffff;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-dark: 0 2px 10px rgba(0, 0, 0, 0.15);
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
        }

        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { margin: 0; padding: 0; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; font-size: 14px; overflow-x: hidden; }
        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        .content-wrapper { display: flex; flex: 1; overflow: hidden; }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; border: none; text-decoration: none; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #0c3e8e; }

        /* HEADER */
        .main-header { background-color: var(--card-background); box-shadow: var(--shadow-light); height: 70px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; z-index: 100; }
        .main-header .app-name { font-size: 24px; font-weight: 600; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .main-header .app-name i { color: var(--secondary-color); }
        .main-nav ul { list-style: none; margin: 0; padding: 0; display: flex; align-items: center; }
        .main-nav li { position: relative; margin: 0 5px; }
        .main-nav a { text-decoration: none; color: var(--text-color); padding: 12px 18px; display: flex; align-items: center; gap: 10px; font-size: 15px; font-weight: 500; border-radius: 8px; transition: all 0.3s ease; }
        .main-nav a i { font-size: 18px; color: var(--secondary-color); }
        .main-nav a:hover, .main-nav li.active a { background-color: var(--background-color); color: var(--primary-color); }
        .main-nav li.active a i { color: var(--primary-color); }
        .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; background-color: var(--card-background); border-radius: 8px; box-shadow: var(--shadow-dark); min-width: 220px; z-index: 99; list-style: none; padding: 10px 0; margin-top: 10px; transform: translateY(10px); opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .has-dropdown:hover .dropdown-menu { display: block; transform: translateY(0); opacity: 1; visibility: visible; }
        .dropdown-menu a { padding: 12px 20px; white-space: nowrap; display: flex; align-items: center; gap: 12px; color: var(--text-color); border-radius: 0; font-size: 14px; }
        .dropdown-menu a:hover, .dropdown-menu a.active { background-color: var(--background-color); color: var(--primary-color); }
        .dropdown-menu a i { font-size: 16px; color: var(--secondary-color); }
        .dropdown-menu a.active i { color: var(--primary-color); }
        
        /* FOOTER */
        .main-footer { background-color: var(--primary-color); color: var(--light-text-color); padding: 20px 30px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1); }
        .footer-info, .user-info { display: flex; gap: 25px; }
        .main-footer i { color: var(--light-text-color); margin-right: 5px; }

        /* MAIN CONTENT */
        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .content-panel { background-color: var(--card-background); padding: 40px; border-radius: 12px; box-shadow: var(--shadow-light); max-width: 100%; margin: 0 auto; }
        .content-panel h2 { color: var(--primary-color); margin-top: 0; font-size: 28px; font-weight: 600; border-bottom: 2px solid var(--background-color); padding-bottom: 15px; margin-bottom: 25px; }
        .report-section { margin-bottom: 40px; }
        .report-section h3 { font-size: 22px; color: var(--secondary-color); margin-bottom: 20px; }
        
        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .dashboard-card { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 20px; border-radius: 10px; box-shadow: var(--shadow-light); }
        .dashboard-card .card-title { font-size: 16px; font-weight: 500; margin: 0 0 10px 0; opacity: 0.9; }
        .dashboard-card .card-value { font-size: 28px; font-weight: 700; margin: 0; }
        .dashboard-card .card-icon { font-size: 24px; float: right; opacity: 0.5; }
        /* THAY THẾ BẰNG KHỐI CSS HOÀN CHỈNH NÀY */
.report-filters {
    background-color: var(--background-color);
    padding: 15px;
    border-radius: 8px;
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 25px;
}
.report-filters label {
    font-weight: 500;
}
.report-filters input[type="date"] {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-family: 'Poppins', sans-serif;
}
.date-quick-filters { 
    display: flex; 
    gap: 10px; 
    margin-left: 15px; 
}
.quick-filter-btn { 
    padding: 6px 14px; 
    font-size: 13px; 
    border: 1px solid #ccc; 
    background-color: #fff; 
    color: var(--text-color); 
    border-radius: 20px; 
    cursor: pointer; 
    transition: all 0.2s ease; 
    font-family: 'Poppins', sans-serif; 
}
.quick-filter-btn:hover { 
    background-color: #f0f0f0; 
    border-color: var(--secondary-color); 
}
.quick-filter-btn.active { 
    background-color: var(--primary-color); 
    color: var(--light-text-color); 
    border-color: var(--primary-color); 
}
        
        /* TABLES */
        .table-wrapper { overflow-x: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .data-table th { background-color: var(--primary-color); color: white; font-weight: 600; text-align: center; }
        .data-table tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* CHARTS */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .chart-container { padding: 20px; border-radius: 10px; box-shadow: var(--shadow-light); background-color: #fff; }
        
        @media (max-width: 992px) {
            .charts-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="main-header">
            <a href="index.html" style="text-decoration: none;">
                <h1 class="app-name"><i class="fa-solid fa-gem"></i> BI-A </h1>
            </a>
            <nav class="main-nav">
     <ul>
        <li><a href="index.html"><i class="fa-solid fa-chart-line"></i> Trang chủ</a></li>
        <li class="has-dropdown"> <a href="#"><i class="fa-solid fa-boxes-stacked"></i> Quản lý</a>
            <ul class="dropdown-menu">
                <li><a href="quanly_ban.html"><i class="fa-solid fa-table-tennis-paddle-ball"></i> Quản lý bàn</a></li>
                <li><a href="quanly_khachhang.html"><i class="fa-solid fa-address-book"></i> Quản lý Khách hàng</a></li>
                <li><a href="quanly_datban.html"><i class="fa-solid fa-calendar-check"></i> Quản lý Đặt bàn</a></li>
                <li><a href="quanly_thuchi.html"><i class="fa-solid fa-cash-register"></i> Quản lý thu chi</a></li>
                <li><a href="quanly_kho.html"><i class="fa-solid fa-box-open"></i> Quản lý kho</a></li>
                <li><a href="quanly_nhanvien.html"><i class="fa-solid fa-users"></i> Quản lý nhân viên</a></li>
            </ul>
        </li>
        <li class="has-dropdown active"> <a href="#"><i class="fa-solid fa-chart-pie"></i> Báo cáo</a>
            <ul class="dropdown-menu">
                <li><a href="baocao_doanhthu.html"><i class="fa-solid fa-file-invoice"></i> Doanh thu ngày</a></li>
                <li><a href="baocao_thongke.html"><i class="fa-solid fa-chart-bar"></i> Thống kê tuần</a></li>
                <li><a href="baocao_loinhuan.html" class="active"><i class="fa-solid fa-file-contract"></i> Báo cáo nhân viên</a></li>
                <li><a href="baocao_khachhang.html"><i class="fa-solid fa-user-tag"></i> Phân tích Khách hàng</a></li>
            </ul>
        </li>
        <li><a href="cai_dat.html"><i class="fa-solid fa-gear"></i> Cài đặt</a></li>
        <li><a href="tro_giup.html"><i class="fa-solid fa-circle-question"></i> Trợ giúp</a></li>
        <li><a href="#" id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a></li>
    </ul>
</nav>
        </header>
        
        <div class="content-wrapper">
            <main class="main-content">
                <div class="content-panel">
                    <h2><i class="fa-solid fa-file-contract"></i> Báo cáo Nhân sự</h2>

                   <div class="report-filters">
    <label for="startDate">Từ ngày:</label>
    <input type="date" id="startDate">
    <label for="endDate">Đến ngày:</label>
    <input type="date" id="endDate">

    <div class="date-quick-filters">
        <button class="quick-filter-btn" data-range="today">Hôm nay</button>
        <button class="quick-filter-btn" data-range="yesterday">Hôm qua</button>
        <button class="quick-filter-btn" data-range="last7days">7 ngày qua</button>
        <button class="quick-filter-btn" data-range="lastmonth">Tháng qua</button>
    </div>

    <div style="margin-left: auto; display: flex; gap: 15px; align-items: center;">
        <select id="employeeFilter" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
            <option value="all">Tất cả nhân viên</option>
        </select>
        <button class="btn btn-primary" id="applyFilterBtn">
            <i class="fa-solid fa-filter"></i> Áp dụng
        </button>
    </div>
</div>

                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <i class="fa-solid fa-user-clock card-icon"></i>
                            <div class="card-title">Tổng giờ làm</div>
                            <div class="card-value" id="totalHoursValue">0</div>
                        </div>
                        <div class="dashboard-card" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                             <i class="fa-solid fa-person-running card-icon"></i>
                            <div class="card-title">Tổng lượt đi trễ</div>
                            <div class="card-value" id="totalLateValue">0</div>
                        </div>
                         <div class="dashboard-card" style="background: linear-gradient(135deg, #f44336, #d32f2f);">
                             <i class="fa-solid fa-calendar-xmark card-icon"></i>
                            <div class="card-title">Tổng lượt vắng</div>
                            <div class="card-value" id="totalAbsentValue">0</div>
                        </div>
                        <div class="dashboard-card" style="background: linear-gradient(135deg, #4caf50, #388e3c);">
                            <i class="fa-solid fa-users card-icon"></i>
                            <div class="card-title">Nhân viên hoạt động</div>
                            <div class="card-value" id="activeEmployeesValue">0</div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3><i class="fa-solid fa-table-list"></i> Báo cáo Chuyên cần & Tính lương</h3>
                        <div class="table-wrapper">
                            <table class="data-table" id="attendanceReportTable">
                                <thead>
                                    <tr>
                                        <th>Mã NV</th>
                                        <th>Tên Nhân viên</th>
                                        <th>Tổng số ca làm</th>
                                        <th>Tổng giờ làm (giờ)</th>
                                        <th>Số lần đi trễ</th>
                                        <th>Số lần vắng</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>

                     <div class="report-section">
                        <h3><i class="fa-solid fa-chart-line"></i> Báo cáo Hiệu suất & So sánh</h3>
                        <div class="charts-grid">
                            <div class="chart-container">
                                 <h4>So sánh tổng giờ làm</h4>
                                <canvas id="workHoursChart"></canvas>
                            </div>
                             <div class="chart-container">
                                <h4>Phân bổ nhân sự theo chức vụ</h4>
                                <canvas id="positionDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>

        <footer class="main-footer">
            <div class="footer-info">
                <span class="copyright-info"><i class="fa-solid fa-copyright"></i> 2025 BI-A OXU. All rights reserved.</span>
                <span class="phone-info"><i class="fa-solid fa-phone"></i> Hotline: 0902.022.665</span>
            </div>
            <div class="user-info">
                <span id="footer-username"><i class="fa-solid fa-user"></i> Người dùng: </span>
                <span><i class="fa-solid fa-circle-check"></i> Trạng thái: OK</span>
            </div>
        </footer>
    </div>

    <script>
    // *** BẢO VỆ TRANG: KIỂM TRA QUYỀN TRUY CẬP ***
    (function() {
        // ID định danh cho chức năng của trang này
        const PAGE_FEATURE_ID = 'baocao_loinhuan'; 

        const userRole = sessionStorage.getItem('userRole');
        if (userRole === 'user') {
            try {
                const permissions = JSON.parse(localStorage.getItem('biaOxuUserPermissions')) || {};
                // Kiểm tra xem người dùng có quyền 'access' (truy cập) vào chức năng này không
                const hasAccess = permissions[PAGE_FEATURE_ID] && permissions[PAGE_FEATURE_ID].access === true;
                
                if (!hasAccess) {
                    document.body.style.display = 'none'; 
                    alert('Bạn không có quyền truy cập chức năng này.');
                    window.location.href = 'index.html';
                }
            } catch (e) { 
                console.error("Lỗi phân tích cú pháp dữ liệu phân quyền:", e);
                window.location.href = 'index.html';
            }
        }
    })();
</script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            if (loggedInUser) {
                document.getElementById('footer-username').innerHTML = `<i class="fa-solid fa-user"></i> Người dùng: ${loggedInUser}`;
            }

            // Load data from localStorage
            const staffData = JSON.parse(localStorage.getItem('staffData')) || [];
            const schedules = JSON.parse(localStorage.getItem('schedules')) || {};

            // Chart instances
            let workHoursChartInstance = null;
            let positionChartInstance = null;

            function populateEmployeeFilter() {
                const select = document.getElementById('employeeFilter');
                staffData.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.name} (ID: ${emp.id})`;
                    select.appendChild(option);
                });
            }

            function generateReport() {
                const startDate = new Date(document.getElementById('startDate').value);
                const endDate = new Date(document.getElementById('endDate').value);
                endDate.setHours(23, 59, 59, 999); // Include the whole end day

                const selectedEmployeeId = document.getElementById('employeeFilter').value;

                let filteredStaff = staffData;
                if (selectedEmployeeId !== 'all') {
                    filteredStaff = staffData.filter(emp => emp.id == selectedEmployeeId);
                }

                const reportData = filteredStaff.map(employee => {
                    let totalHours = 0, lateCount = 0, absentCount = 0, shiftCount = 0;
                    const employeeSchedules = schedules[employee.id] || {};

                    for (const dateKey in employeeSchedules) {
                        const scheduleDate = new Date(dateKey);
                        if (scheduleDate >= startDate && scheduleDate <= endDate) {
                            employeeSchedules[dateKey].forEach(shift => {
                                if (shift.totalHours) {
                                    totalHours += parseFloat(shift.totalHours);
                                }
                                if (shift.status === 'late') lateCount++;
                                if (shift.status === 'absent') absentCount++;
                                if (shift.status === 'present' || shift.status === 'late') {
                                    shiftCount++;
                                }
                            });
                        }
                    }
                    return { ...employee, totalHours, lateCount, absentCount, shiftCount };
                });

                updateDashboard(reportData);
                updateAttendanceTable(reportData);
                updateCharts(reportData);
            }
            
            function updateDashboard(reportData) {
                const totalHours = reportData.reduce((sum, emp) => sum + emp.totalHours, 0);
                const totalLate = reportData.reduce((sum, emp) => sum + emp.lateCount, 0);
                const totalAbsent = reportData.reduce((sum, emp) => sum + emp.absentCount, 0);
                const activeEmployees = reportData.filter(emp => emp.shiftCount > 0).length;

                document.getElementById('totalHoursValue').textContent = totalHours.toFixed(2);
                document.getElementById('totalLateValue').textContent = totalLate;
                document.getElementById('totalAbsentValue').textContent = totalAbsent;
                document.getElementById('activeEmployeesValue').textContent = activeEmployees;
            }

            function updateAttendanceTable(reportData) {
                const tableBody = document.querySelector('#attendanceReportTable tbody');
                tableBody.innerHTML = '';
                if(reportData.length === 0) {
                     tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Không có dữ liệu cho khoảng thời gian đã chọn.</td></tr>`;
                     return;
                }
                reportData.forEach(emp => {
                    const row = `
                        <tr>
                            <td style="text-align: center;">${emp.id}</td>
                            <td>${emp.name}</td>
                            <td style="text-align: center;">${emp.shiftCount}</td>
                            <td style="text-align: center;">${emp.totalHours.toFixed(2)}</td>
                            <td style="text-align: center;">${emp.lateCount}</td>
                            <td style="text-align: center;">${emp.absentCount}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }

            function updateCharts(reportData) {
                // Work Hours Chart
                const workHoursCtx = document.getElementById('workHoursChart').getContext('2d');
                const workHoursLabels = reportData.map(emp => emp.name);
                const workHoursData = reportData.map(emp => emp.totalHours);
                
                if(workHoursChartInstance) workHoursChartInstance.destroy();
                workHoursChartInstance = new Chart(workHoursCtx, {
                    type: 'bar',
                    data: {
                        labels: workHoursLabels,
                        datasets: [{
                            label: 'Tổng giờ làm',
                            data: workHoursData,
                            backgroundColor: 'rgba(13, 71, 161, 0.7)',
                            borderColor: 'rgba(13, 71, 161, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });

                // Position Distribution Chart
                const positionCtx = document.getElementById('positionDistributionChart').getContext('2d');
                const positionCounts = staffData.reduce((acc, emp) => {
                    acc[emp.position] = (acc[emp.position] || 0) + 1;
                    return acc;
                }, {});
                
                if(positionChartInstance) positionChartInstance.destroy();
                positionChartInstance = new Chart(positionCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(positionCounts),
                        datasets: [{
                            data: Object.values(positionCounts),
                            backgroundColor: ['#0d47a1', '#1976d2', '#42a5f5', '#90caf9'],
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true }
                });
            }

            //== DÁN KHỐI MÃ MỚI NÀY VÀO ==//

function initialize() {
    populateEmployeeFilter();

    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const quickFilterBtns = document.querySelectorAll('.quick-filter-btn');

    // 1. Gán sự kiện cho các nút lọc nhanh
    quickFilterBtns.forEach(button => {
        button.addEventListener('click', () => {
            quickFilterBtns.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            const range = button.dataset.range;
            const today = new Date();
            let startDate = new Date();
            let endDate = new Date();

            switch (range) {
                case 'today':
                    break;
                case 'yesterday':
                    startDate.setDate(today.getDate() - 1);
                    endDate.setDate(today.getDate() - 1);
                    break;
                case 'last7days':
                    startDate.setDate(today.getDate() - 6);
                    break;
                case 'lastmonth': // Đã đổi từ 'this_month'
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
            }
            startDateInput.valueAsDate = startDate;
            endDateInput.valueAsDate = endDate;
        });
    });

    // 2. Xử lý khi người dùng chọn ngày thủ công -> bỏ active nút
    const deactivateQuickFilters = () => quickFilterBtns.forEach(b => b.classList.remove('active'));
    startDateInput.addEventListener('input', deactivateQuickFilters);
    endDateInput.addEventListener('input', deactivateQuickFilters);

    // 3. Giữ lại logic cho nút "Áp dụng"
    document.getElementById('applyFilterBtn').addEventListener('click', generateReport);

    // 4. Thiết lập trạng thái ban đầu: tự động bấm vào nút "Tháng qua"
    document.querySelector('.quick-filter-btn[data-range="lastmonth"]').click();
    generateReport(); // Chạy báo cáo lần đầu
}

// Gọi hàm khởi tạo
initialize();

//== KẾT THÚC KHỐI MÃ MỚI ==//
            
            // Logout and Update Store Info
            document.getElementById('logout-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                sessionStorage.clear();
                window.location.href = 'login.html';
            });
            
            function updateStoreInfo() {
                const savedData = localStorage.getItem('general-form');
                if (savedData) {
                    const settings = JSON.parse(savedData);
                    const storeNameElement = document.querySelector('.main-header .app-name');
                    if (storeNameElement && settings['store-name']) {
                        storeNameElement.innerHTML = `<i class="fa-solid fa-gem"></i> ${settings['store-name']}`;
                    }
                    const phoneElement = document.querySelector('.main-footer .phone-info');
                    if (phoneElement && settings.phone) {
                        phoneElement.innerHTML = `<i class="fa-solid fa-phone"></i> Hotline: ${settings.phone}`;
                    }
                    const copyrightElement = document.querySelector('.main-footer .copyright-info');
                    if (copyrightElement && settings['store-name']) {
                        copyrightElement.innerHTML = `<i class="fa-solid fa-copyright"></i> 2025 ${settings['store-name']}. All rights reserved.`;
                    }
                }
            }
            updateStoreInfo();
        });
    </script>
</body>
</html>