<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo Phân tích Kinh doanh - PHẦN MỀM QUẢN LÝ QUÁN BI-A</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>

    <style>
        :root {
            --primary-color: #0d47a1; --secondary-color: #1976d2; --text-color: #333;
            --light-text-color: #f0f4f8; --background-color: #eef2f6; --card-background: #ffffff;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08); --shadow-dark: 0 2px 10px rgba(0, 0, 0, 0.15);
            --border-color: #e0e0e0; --income-color: #4caf50; --expense-color: #f44336; --cogs-color: #ff9800;
        }
        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--background-color); color: var(--text-color); }
        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        .content-wrapper { display: flex; flex: 1; padding: 20px; gap: 20px; }
        
        /* HEADER & NAVIGATION */
        .main-header { background-color: var(--card-background); box-shadow: var(--shadow-light); height: 70px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; z-index: 100; }
        .main-header .app-name { font-size: 24px; font-weight: 600; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .main-header .app-name i { color: var(--secondary-color); }
        .main-nav ul { list-style: none; margin: 0; padding: 0; display: flex; align-items: center; }
        .main-nav li { position: relative; margin: 0 5px; }
        .main-nav a { text-decoration: none; color: var(--text-color); padding: 12px 18px; display: flex; align-items: center; gap: 10px; font-size: 15px; font-weight: 500; border-radius: 8px; transition: all 0.3s ease; }
        .main-nav a i { font-size: 18px; color: var(--secondary-color); }
        .main-nav a:hover, .main-nav li.active a { background-color: var(--background-color); color: var(--primary-color); }
        .main-nav li.active a i { color: var(--primary-color); }
        
        .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; background-color: var(--card-background); border-radius: 8px; box-shadow: var(--shadow-dark); min-width: 220px; z-index: 99; list-style: none; padding: 10px 0; margin-top: 10px; transform: translateY(10px); opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .has-dropdown:hover .dropdown-menu { display: block; transform: translateY(0); opacity: 1; visibility: visible; }
        .dropdown-menu a { padding: 12px 20px; white-space: nowrap; display: flex; align-items: center; gap: 12px; color: var(--text-color); border-radius: 0; font-size: 14px; }
        .dropdown-menu a:hover { background-color: var(--background-color); color: var(--primary-color); }
        .dropdown-menu a i { font-size: 16px; color: var(--secondary-color); }
        
        .main-footer { background-color: var(--primary-color); color: var(--light-text-color); padding: 20px 30px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .footer-info, .user-info { display: flex; gap: 25px; }
        .main-footer i { margin-right: 5px; }

        /* REPORT STYLES */
        .report-container { width: 100%; display: flex; flex-direction: column; gap: 20px; }
        .report-filters { background: var(--card-background); padding: 15px 20px; border-radius: 12px; box-shadow: var(--shadow-light); display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .report-filters label { font-weight: 500; }
        .report-filters input[type="date"] { padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); font-family: 'Poppins', sans-serif; }
        
        /* === CSS CHO CÁC NÚT LỌC NHANH MỚI === */
        .date-quick-filters { display: flex; gap: 10px; margin-left: 15px; }
        .quick-filter-btn { padding: 6px 14px; font-size: 13px; border: 1px solid var(--border-color); background-color: #fff; color: var(--text-color); border-radius: 20px; cursor: pointer; transition: all 0.2s ease; font-family: 'Poppins', sans-serif; }
        .quick-filter-btn:hover { background-color: var(--background-color); border-color: var(--secondary-color); }
        .quick-filter-btn.active { background-color: var(--primary-color); color: var(--light-text-color); border-color: var(--primary-color); }
        /* === KẾT THÚC CSS CHO NÚT LỌC === */
        
        .report-main { background: var(--card-background); padding: 20px; border-radius: 12px; box-shadow: var(--shadow-light); flex-grow: 1; }
        .tab-nav { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
        .tab-nav button { background: none; border: none; padding: 10px 20px; cursor: pointer; font-size: 15px; font-weight: 500; color: #666; position: relative; transition: all 0.3s ease; }
        .tab-nav button.active { color: var(--primary-color); font-weight: 600; }
        .tab-nav button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .kpi-card { background: var(--background-color); padding: 20px; border-radius: 10px; border-left: 5px solid; }
        .kpi-card .value { font-size: 24px; font-weight: 700; }
        .kpi-card .title { font-size: 14px; color: #555; }
        .kpi-card.revenue { border-color: var(--income-color); } .kpi-card.revenue .value { color: var(--income-color); }
        .kpi-card.cogs { border-color: var(--cogs-color); } .kpi-card.cogs .value { color: var(--cogs-color); }
        .kpi-card.gross-profit { border-color: var(--secondary-color); } .kpi-card.gross-profit .value { color: var(--secondary-color); }
        .kpi-card.net-profit { border-color: var(--primary-color); } .kpi-card.net-profit .value { color: var(--primary-color); }

        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .chart-container, .table-container { margin-top: 20px; }
        .chart-container { position: relative; height: 350px; }
        .chart-container h3, .table-container h3 { font-size: 18px; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .report-table th, .report-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .report-table thead th { background: var(--background-color); font-weight: 600; color: var(--primary-color); }
        .report-table tbody tr:hover { background-color: #f9f9f9; }
        .report-table .text-right { text-align: right; }
        .report-table .font-bold { font-weight: 600; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="main-header">
            <a href="index.html" style="text-decoration: none;">
                <h1 class="app-name"><i class="fa-solid fa-gem"></i> BI-A OXU</h1>
            </a>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class="fa-solid fa-chart-line"></i> Trang chủ</a></li>
                    <li class="has-dropdown">
                        <a href="#"><i class="fa-solid fa-boxes-stacked"></i> Quản lý</a>
                        <ul class="dropdown-menu">
                            <li><a href="quanly_ban.html"><i class="fa-solid fa-table-tennis-paddle-ball"></i> Quản lý bàn</a></li>
                            <li><a href="quanly_khachhang.html"><i class="fa-solid fa-address-book"></i> Quản lý Khách hàng</a></li>
                            <li><a href="quanly_datban.html"><i class="fa-solid fa-calendar-check"></i> Quản lý Đặt bàn</a></li>
                            <li><a href="quanly_thuchi.html"><i class="fa-solid fa-cash-register"></i> Quản lý thu chi</a></li>
                            <li><a href="quanly_kho.html"><i class="fa-solid fa-box-open"></i> Quản lý kho</a></li>
                            <li><a href="quanly_nhanvien.html"><i class="fa-solid fa-users"></i> Quản lý nhân viên</a></li>
                        </ul>
                    </li>
                    <li class="has-dropdown active">
                        <a href="#"><i class="fa-solid fa-chart-pie"></i> Báo cáo</a>
                        <ul class="dropdown-menu">
                            <li><a href="baocao_doanhthu.html"><i class="fa-solid fa-file-invoice"></i> Doanh thu ngày</a></li>
                            <li><a href="baocao_thongke.html" class="active"><i class="fa-solid fa-chart-bar"></i> Thống kê tuần</a></li>
                            <li><a href="baocao_loinhuan.html"><i class="fa-solid fa-file-contract"></i> Báo cáo nhân viên</a></li>
                             <li><a href="baocao_khachhang.html"><i class="fa-solid fa-user-tag"></i> Phân tích Khách hàng</a></li>
                        </ul>
                    </li>
                    <li><a href="cai_dat.html"><i class="fa-solid fa-gear"></i> Cài đặt</a></li>
                    <li><a href="tro_giup.html"><i class="fa-solid fa-circle-question"></i> Trợ giúp</a></li>
                    <li><a href="#" id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a></li>
                </ul>
            </nav>
        </header>

        <div class="content-wrapper">
            <div class="report-container">
                <div class="report-filters">
                    <label for="start-date">Từ ngày:</label>
                    <input type="date" id="start-date">
                    <label for="end-date">Đến ngày:</label>
                    <input type="date" id="end-date">
                    <div class="date-quick-filters">
                        <button class="quick-filter-btn" data-range="today">Hôm nay</button>
                        <button class="quick-filter-btn" data-range="yesterday">Hôm qua</button>
                        <button class="quick-filter-btn" data-range="last7days">7 ngày qua</button>
                        <button class="quick-filter-btn" data-range="lastmonth">Tháng qua</button>
                    </div>
                </div>

                <div class="report-main">
                    <nav class="tab-nav">
                        <button class="tab-btn active" data-tab="dashboard">
                            <i class="fa-solid fa-tachometer-alt"></i> Tổng quan
                        </button>
                        <button class="tab-btn" data-tab="revenue">
                            <i class="fa-solid fa-sack-dollar"></i> Doanh thu & Lợi nhuận
                        </button>
                        <button class="tab-btn" data-tab="products">
                            <i class="fa-solid fa-cubes"></i> Sản phẩm
                        </button>
                        <button class="tab-btn" data-tab="tables">
                            <i class="fa-solid fa-table-tennis-paddle-ball"></i> Bàn / Phòng
                        </button>
                        <button class="tab-btn" data-tab="expenses">
                            <i class="fa-solid fa-file-invoice-dollar"></i> Chi phí
                        </button>
                        <button class="tab-btn" data-tab="hourly">
                            <i class="fa-solid fa-clock"></i> Theo giờ
                        </button>
                    </nav>

                    <div id="dashboard" class="tab-content active">
                        <div class="kpi-grid">
                            <div class="kpi-card revenue">
                                <div class="value" id="kpi-revenue">0đ</div>
                                <div class="title">Tổng Doanh thu</div>
                            </div>
                            <div class="kpi-card cogs">
                                <div class="value" id="kpi-cogs">0đ</div>
                                <div class="title">Giá Vốn Hàng Bán</div>
                            </div>
                            <div class="kpi-card gross-profit">
                                <div class="value" id="kpi-gross-profit">0đ</div>
                                <div class="title">Lợi Nhuận Gộp</div>
                            </div>
                             <div class="kpi-card net-profit">
                                <div class="value" id="kpi-net-profit">0đ</div>
                                <div class="title">Lợi Nhuận Ròng</div>
                            </div>
                        </div>
                        <div class="chart-grid">
                            <div class="chart-container">
                                <h3>Top 5 Sản phẩm (Doanh thu)</h3>
                                <canvas id="top-products-revenue-chart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3>Top 5 Sản phẩm (Lợi nhuận)</h3>
                                <canvas id="top-products-profit-chart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3>Doanh thu theo giờ</h3>
                                <canvas id="hourly-revenue-chart"></canvas>
                            </div>
                             <div class="chart-container">
                                <h3>Cơ cấu chi phí</h3>
                                <canvas id="expense-structure-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div id="revenue" class="tab-content">
                        <div class="table-container">
                            <h3>Báo cáo Doanh thu - Lợi nhuận theo ngày</h3>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Ngày</th>
                                        <th class="text-right">Doanh thu</th>
                                        <th class="text-right">Giá vốn</th>
                                        <th class="text-right">Lợi nhuận gộp</th>
                                        <th class="text-right">Chi phí khác</th>
                                        <th class="text-right">Lợi nhuận ròng</th>
                                    </tr>
                                </thead>
                                <tbody id="revenue-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="products" class="tab-content">
                        <div class="table-container">
                             <h3>Báo cáo Hiệu suất Sản phẩm</h3>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Tên sản phẩm</th>
                                        <th class="text-right">SL Bán</th>
                                        <th class="text-right">Doanh thu</th>
                                        <th class="text-right">Giá vốn</th>
                                        <th class="text-right">Lợi nhuận gộp</th>
                                        <th class="text-right">Tồn kho</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="tables" class="tab-content">
                         <div class="table-container">
                             <h3>Báo cáo Hiệu suất Bàn / Phòng</h3>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Tên Bàn/Phòng</th>
                                        <th class="text-right">Tổng giờ chơi</th>
                                        <th class="text-right">Tổng doanh thu</th>
                                        <th class="text-right">Doanh thu TB/Giờ</th>
                                    </tr>
                                </thead>
                                <tbody id="tables-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="expenses" class="tab-content">
                        <div class="table-container">
                             <h3>Báo cáo Phân tích Chi phí</h3>
                             <p style="font-size: 13px; color: #666;">Lưu ý: Để phân loại chi phí, vui lòng thêm trường "Loại chi phí" khi tạo phiếu chi ở trang Quản lý Thu-Chi.</p>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Loại chi phí</th>
                                        <th class="text-right">Tổng tiền</th>
                                        <th class="text-right">Tỷ trọng</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="hourly" class="tab-content">
                        <div class="table-container">
                             <h3>Báo cáo Doanh thu theo Khung giờ</h3>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Khung giờ</th>
                                        <th class="text-right">Tổng doanh thu</th>
                                    </tr>
                                </thead>
                                <tbody id="hourly-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="main-footer">
            <div class="footer-info">
                <span class="copyright-info"><i class="fa-solid fa-copyright"></i> 2025 BI-A OXU. All rights reserved.</span>
                <span class="phone-info"><i class="fa-solid fa-phone"></i> Hotline: 0902.022.665</span>
            </div>
            <div class="user-info">
                <span id="footer-username"><i class="fa-solid fa-user"></i> Người dùng: </span>
                <span><i class="fa-solid fa-circle-check"></i> Trạng thái: OK</span>
            </div>
        </footer>
    </div>

    <script>
    (function() {
        const userRole = sessionStorage.getItem('userRole');
        if (userRole === 'user') {
            try {
                const permissions = JSON.parse(localStorage.getItem('biaOxuUserPermissions')) || {};
                if (!permissions['baocao_thongke'] || !permissions['baocao_thongke'].access) {
                    document.body.style.display = 'none'; 
                    alert('Bạn không có quyền truy cập chức năng này.');
                    window.location.href = 'index.html';
                }
            } catch (e) { 
                console.error("Lỗi phân tích cú pháp dữ liệu phân quyền:", e);
                window.location.href = 'index.html';
            }
        }
    })();

    document.addEventListener('DOMContentLoaded', () => {
        const STORAGE_KEYS = {
            transactions: 'biaOxuTransactions',
            savedBills: 'biaOxuSavedBills',
            stockInHistory: 'biaOxuStockInHistory',
            menuItems: 'biaOxuMenuItems'
        };

        const chartInstances = {};

        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        const formatHours = (ms) => {
            if (!ms || ms <= 0) return '00:00';
            const totalMinutes = Math.floor(ms / 60000);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        };

        function updateStoreInfo() {
            const defaultStoreName = 'BI-A OXU';
            const defaultPhone = '0902.022.665';
            let storeName = defaultStoreName;
            let phone = defaultPhone;
            
            try {
                const savedData = localStorage.getItem('general-form');
                if (savedData) {
                    const settings = JSON.parse(savedData);
                    storeName = settings['store-name'] || defaultStoreName;
                    phone = settings.phone || defaultPhone;
                }
            } catch (e) { 
                console.error("Không thể cập nhật thông tin quán", e);
            }
            
            document.querySelector('.main-header .app-name').innerHTML = `<i class="fa-solid fa-gem"></i> ${storeName}`;
            document.querySelector('.main-footer .phone-info').innerHTML = `<i class="fa-solid fa-phone"></i> Hotline: ${phone}`;
            document.querySelector('.main-footer .copyright-info').innerHTML = `<i class="fa-solid fa-copyright"></i> 2025 ${storeName}. All rights reserved.`;
        }

        function initializeUI() {
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const quickFilterBtns = document.querySelectorAll('.quick-filter-btn');

            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            startDateInput.valueAsDate = firstDayOfMonth;
            endDateInput.valueAsDate = today;

            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(button.dataset.tab).classList.add('active');
                });
            });

            // === LOGIC CHO CÁC NÚT LỌC NHANH ===
            quickFilterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    quickFilterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const range = btn.dataset.range;
                    const today = new Date();
                    let startDate = new Date();
                    let endDate = new Date();

                    switch (range) {
                        case 'today':
                            startDate = today;
                            endDate = today;
                            break;
                        case 'yesterday':
                            startDate = new Date();
                            startDate.setDate(today.getDate() - 1);
                            endDate = startDate;
                            break;
                        case 'last7days':
                            startDate = new Date();
                            startDate.setDate(today.getDate() - 6);
                            endDate = today;
                            break;
                        case 'lastmonth':
                            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                            break;
                    }

                    startDateInput.valueAsDate = startDate;
                    endDateInput.valueAsDate = endDate;
                    updateAllReports();
                });
            });
            // === KẾT THÚC LOGIC LỌC NHANH ===
            
            const clearActiveFilter = () => quickFilterBtns.forEach(b => b.classList.remove('active'));
            startDateInput.addEventListener('change', clearActiveFilter);
            endDateInput.addEventListener('change', clearActiveFilter);

            startDateInput.addEventListener('change', updateAllReports);
            endDateInput.addEventListener('change', updateAllReports);
            
            updateStoreInfo();
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            if (loggedInUser) {
                document.getElementById('footer-username').innerHTML = `<i class="fa-solid fa-user"></i> Người dùng: ${loggedInUser}`;
            }
        }
        
        function processData(startDate, endDate) {
            const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.transactions)) || [];
            const savedBills = JSON.parse(localStorage.getItem(STORAGE_KEYS.savedBills)) || [];
            const stockInHistory = JSON.parse(localStorage.getItem(STORAGE_KEYS.stockInHistory)) || [];
            const menuItems = JSON.parse(localStorage.getItem(STORAGE_KEYS.menuItems)) || [];

            const filteredBills = savedBills.filter(bill => {
                const billDate = new Date(bill.endTime);
                return billDate >= startDate && billDate <= endDate;
            });

          // === PHẦN SỬA LỖI QUAN TRỌNG BẮT ĐẦU TỪ ĐÂY ===
            const filteredTransactions = transactions.filter(tx => {
                const dateString = tx.date || '';
                const cleanedString = dateString.replace(',', ''); 
                const parts = cleanedString.split(' '); 
                if (parts.length < 2) return false;

                const time = parts[0];
                const dateStr = parts[1];
                
                const timeParts = time.split(':');
                const dateParts = dateStr.split('/');
                if (timeParts.length < 2 || dateParts.length < 3) return false;

                // Sử dụng phương pháp chuyển đổi ngày tháng đáng tin cậy hơn
                const day = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10) - 1; // Rất quan trọng: tháng trong Javascript tính từ 0 (0=Tháng 1)
                const year = parseInt(dateParts[2], 10);
                const hours = parseInt(timeParts[0], 10);
                const minutes = parseInt(timeParts[1], 10);
                const seconds = timeParts.length > 2 ? parseInt(timeParts[2], 10) : 0;
                
                if ([day, month, year, hours, minutes, seconds].some(isNaN)) return false;
                
                const txDate = new Date(year, month, day, hours, minutes, seconds);
                
                if (isNaN(txDate.getTime())) return false; 
                return txDate >= startDate && txDate <= endDate;
            });
            // === KẾT THÚC PHẦN SỬA LỖI ===
            
            const productReport = {};
            filteredBills.forEach(bill => {
                const allItems = [...bill.products];
                if(bill.playingCost > 0) {
                    allItems.push({ id: 'tien_gio', name: 'Tiền giờ chơi', price: bill.playingCost, quantity: 1 });
                }
                
                allItems.forEach(item => {
                    if (!productReport[item.id]) {
                        productReport[item.id] = { name: item.name, quantity: 0, revenue: 0, cogs: 0 };
                    }
                    productReport[item.id].quantity += item.quantity;
                    
                    const itemRevenue = item.id === 'tien_gio' ? item.price : item.price * item.quantity;
                    productReport[item.id].revenue += itemRevenue;

                    if(item.id !== 'tien_gio') {
                        const latestStockIn = stockInHistory
                            .filter(s => s.productId === item.id)
                            .sort((a, b) => new Date(b.rawTimestamp) - new Date(a.rawTimestamp))[0];
                        const cost = latestStockIn ? latestStockIn.cost : 0;
                        productReport[item.id].cogs += cost * item.quantity;
                    }
                });
            });

            const tableReport = {};
             filteredBills.forEach(bill => {
                if (!tableReport[bill.tableId]) {
                    tableReport[bill.tableId] = { name: bill.tableName, totalHours: 0, totalRevenue: 0 };
                }
                const durationMs = bill.endTime - bill.startTime;
                tableReport[bill.tableId].totalHours += durationMs;
                tableReport[bill.tableId].totalRevenue += bill.totalAmount;
            });

            const expenseReport = {};
             filteredTransactions.filter(tx => tx.type === 'expense').forEach(tx => {
                const category = tx.category || 'Chưa phân loại';
                if (!expenseReport[category]) {
                    expenseReport[category] = 0;
                }
                expenseReport[category] += tx.amount;
            });
            
            const hourlyReport = Array(24).fill(0).map(() => ({ revenue: 0 }));
             filteredBills.forEach(bill => {
                const hour = new Date(bill.endTime).getHours();
                hourlyReport[hour].revenue += bill.totalAmount;
            });

            const dailyRevenueReport = {};
            filteredBills.forEach(bill => {
                const date = new Date(bill.endTime).toISOString().split('T')[0];
                if (!dailyRevenueReport[date]) {
                    dailyRevenueReport[date] = { revenue: 0, cogs: 0, otherExpenses: 0 };
                }
                dailyRevenueReport[date].revenue += bill.totalAmount;
                dailyRevenueReport[date].cogs += bill.products.reduce((sum, p) => {
                     const latestStockIn = stockInHistory
                            .filter(s => s.productId === p.id)
                            .sort((a, b) => new Date(b.rawTimestamp) - new Date(a.rawTimestamp))[0];
                     const cost = latestStockIn ? latestStockIn.cost : 0;
                     return sum + (cost * p.quantity);
                }, 0);
            });
             filteredTransactions.filter(tx => tx.type === 'expense').forEach(tx => {
                const [time, dateStr] = tx.date.split(' ');
                if (!dateStr) return;
                const [day, month, year] = dateStr.split('/');
                const date = new Date(`${year}-${month}-${day}`).toISOString().split('T')[0];
                
                if (!dailyRevenueReport[date]) {
                    dailyRevenueReport[date] = { revenue: 0, cogs: 0, otherExpenses: 0 };
                }
                dailyRevenueReport[date].otherExpenses += tx.amount;
             });

            return { productReport, tableReport, expenseReport, hourlyReport, dailyRevenueReport, menuItems };
        }
        
        function renderAllReports(data) {
            renderDashboard(data);
            renderRevenueReport(data.dailyRevenueReport);
            renderProductReport(data.productReport, data.menuItems);
            renderTableReport(data.tableReport);
            renderExpenseReport(data.expenseReport);
            renderHourlyReport(data.hourlyReport);
        }

        function renderDashboard(data) {
            const productList = Object.values(data.productReport);
            const expenseList = Object.entries(data.expenseReport);

            const totalRevenue = productList.reduce((sum, p) => sum + p.revenue, 0);
            const totalCogs = productList.reduce((sum, p) => sum + p.cogs, 0);
            const grossProfit = totalRevenue - totalCogs;
            const otherExpenses = expenseList.reduce((sum, [, amount]) => sum + amount, 0);
            const netProfit = grossProfit - otherExpenses;

            document.getElementById('kpi-revenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('kpi-cogs').textContent = formatCurrency(totalCogs);
            document.getElementById('kpi-gross-profit').textContent = formatCurrency(grossProfit);
            document.getElementById('kpi-net-profit').textContent = formatCurrency(netProfit);
            
            const top5Revenue = productList.filter(p => p.name !== 'Tiền giờ chơi').sort((a, b) => b.revenue - a.revenue).slice(0, 5);
            const top5Profit = productList.filter(p => p.name !== 'Tiền giờ chơi').sort((a, b) => (b.revenue - b.cogs) - (a.revenue - a.cogs)).slice(0, 5);

            drawChart('top-products-revenue-chart', 'bar', {
                labels: top5Revenue.map(p => p.name),
                datasets: [{ label: 'Doanh thu', data: top5Revenue.map(p => p.revenue), backgroundColor: '#1976d2' }]
            });
            drawChart('top-products-profit-chart', 'bar', {
                labels: top5Profit.map(p => p.name),
                datasets: [{ label: 'Lợi nhuận gộp', data: top5Profit.map(p => p.revenue - p.cogs), backgroundColor: '#4caf50' }]
            });
            drawChart('hourly-revenue-chart', 'line', {
                labels: data.hourlyReport.map((_, i) => `${i}:00`),
                datasets: [{ label: 'Doanh thu', data: data.hourlyReport.map(h => h.revenue), borderColor: '#0d47a1', tension: 0.1 }]
            });
             drawChart('expense-structure-chart', 'pie', {
                labels: expenseList.map(([category]) => category),
                datasets: [{ data: expenseList.map(([, amount]) => amount) }]
            });
        }
        
        function renderRevenueReport(dailyData) {
            const tableBody = document.getElementById('revenue-table-body');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Không có dữ liệu.</td></tr>';
            if(Object.keys(dailyData).length === 0) return;

            tableBody.innerHTML = '';
            const sortedDates = Object.keys(dailyData).sort();
            sortedDates.forEach(date => {
                const data = dailyData[date];
                const grossProfit = data.revenue - data.cogs;
                const netProfit = grossProfit - data.otherExpenses;
                tableBody.innerHTML += `
                    <tr>
                        <td class="font-bold">${new Date(date).toLocaleDateString('vi-VN')}</td>
                        <td class="text-right">${formatCurrency(data.revenue)}</td>
                        <td class="text-right">${formatCurrency(data.cogs)}</td>
                        <td class="text-right font-bold">${formatCurrency(grossProfit)}</td>
                        <td class="text-right">${formatCurrency(data.otherExpenses)}</td>
                        <td class="text-right font-bold">${formatCurrency(netProfit)}</td>
                    </tr>`;
            });
        }

        function renderProductReport(productData, menuItems) {
            const tableBody = document.getElementById('products-table-body');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Không có dữ liệu.</td></tr>';
            const productList = Object.entries(productData);
            if(productList.length === 0) return;
            
            tableBody.innerHTML = '';
            productList.sort(([,a], [,b]) => b.revenue - a.revenue);
            productList.forEach(([id, data]) => {
                const stock = menuItems.find(item => item.id === id)?.quantity ?? 'N/A';
                tableBody.innerHTML += `
                    <tr>
                        <td class="font-bold">${data.name}</td>
                        <td class="text-right">${data.quantity}</td>
                        <td class="text-right">${formatCurrency(data.revenue)}</td>
                        <td class="text-right">${formatCurrency(data.cogs)}</td>
                        <td class="text-right font-bold">${formatCurrency(data.revenue - data.cogs)}</td>
                        <td class="text-right">${stock}</td>
                    </tr>`;
            });
        }
        
        function renderTableReport(tableData) {
            const tableBody = document.getElementById('tables-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Không có dữ liệu.</td></tr>';
            const tableList = Object.values(tableData);
            if(tableList.length === 0) return;

            tableBody.innerHTML = '';
            tableList.sort((a,b) => b.totalRevenue - a.totalRevenue);
            tableList.forEach(data => {
                const avgRevenue = data.totalHours > 0 ? data.totalRevenue / (data.totalHours / 3600000) : 0;
                tableBody.innerHTML += `
                    <tr>
                        <td class="font-bold">${data.name}</td>
                        <td class="text-right">${formatHours(data.totalHours)}</td>
                        <td class="text-right">${formatCurrency(data.totalRevenue)}</td>
                        <td class="text-right font-bold">${formatCurrency(avgRevenue)}/giờ</td>
                    </tr>`;
            });
        }

        function renderExpenseReport(expenseData) {
             const tableBody = document.getElementById('expenses-table-body');
            tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Không có dữ liệu.</td></tr>';
            const expenseList = Object.entries(expenseData);
            if(expenseList.length === 0) return;

            tableBody.innerHTML = '';
            const totalExpense = Object.values(expenseData).reduce((sum, amount) => sum + amount, 0);
            expenseList.sort(([,a], [,b]) => b-a);
             expenseList.forEach(([category, amount]) => {
                const percentage = totalExpense > 0 ? (amount / totalExpense * 100).toFixed(2) : 0;
                 tableBody.innerHTML += `
                    <tr>
                        <td class="font-bold">${category}</td>
                        <td class="text-right">${formatCurrency(amount)}</td>
                        <td class="text-right">${percentage}%</td>
                    </tr>`;
             });
        }
        
        function renderHourlyReport(hourlyData) {
            const tableBody = document.getElementById('hourly-table-body');
            tableBody.innerHTML = '<tr><td colspan="2" style="text-align:center;">Không có dữ liệu.</td></tr>';
            const hasData = hourlyData.some(h => h.revenue > 0);
            if(!hasData) return;

            tableBody.innerHTML = '';
            hourlyData.forEach((data, hour) => {
                if(data.revenue > 0) {
                     tableBody.innerHTML += `
                        <tr>
                            <td class="font-bold">${hour}:00 - ${hour+1}:00</td>
                            <td class="text-right">${formatCurrency(data.revenue)}</td>
                        </tr>`;
                }
            });
        }

        function drawChart(canvasId, type, data, options = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            chartInstances[canvasId] = new Chart(ctx, {
                type,
                data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { tooltip: { callbacks: { label: (context) => { let label = context.dataset.label || ''; if(label){ label += ': '}; label += formatCurrency(context.raw); return label; } } } }
                    , ...options
                }
            });
        }

        function updateAllReports() {
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            const startDate = new Date(startDateInput.value);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateInput.value);
            endDate.setHours(23, 59, 59, 999);

            if (endDate < startDate) {
                alert("Ngày kết thúc không thể nhỏ hơn ngày bắt đầu.");
                return;
            }

            const processedData = processData(startDate, endDate);
            renderAllReports(processedData);
        }

        initializeUI();
        updateAllReports();

        document.getElementById('logout-btn')?.addEventListener('click', (e) => {
            e.preventDefault();
            sessionStorage.clear();
            window.location.href = 'login.html';
        });
    });
    </script>
</body>
</html>