<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cài đặt | PHẦN MỀM QUẢN LÝ QUÁN BI-A</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        // Kiểm tra trạng thái đăng nhập
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    
    <style>
        /* ===================== FONT AND COLOR VARIABLES ===================== */
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #1976d2;
            --text-color: #333;
            --light-text-color: #f0f4f8;
            --background-color: #eef2f6;
            --card-background: #ffffff;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-dark: 0 2px 10px rgba(0, 0, 0, 0.15);
            --danger-color: #d32f2f;
            --success-color: #388e3c;
        }

        /* ===================== GLOBAL STYLES ===================== */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .content-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ===================== HEADER ===================== */
        .main-header {
            background-color: var(--card-background);
            box-shadow: var(--shadow-light);
            height: 70px;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
        }

        .main-header .app-name {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .main-header .app-name i {
            color: var(--secondary-color);
        }

        .main-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
        }

        .main-nav li {
            position: relative;
            margin: 0 5px;
        }

        .main-nav a {
            text-decoration: none;
            color: var(--text-color);
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .main-nav a i {
            font-size: 18px;
            color: var(--secondary-color);
        }

        .main-nav a:hover,
        .main-nav li.active a {
            background-color: var(--background-color);
            color: var(--primary-color);
        }

        .main-nav li.active a i {
            color: var(--primary-color);
        }

        /* Dropdown Menu */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: var(--shadow-dark);
            min-width: 220px;
            z-index: 99;
            list-style: none;
            padding: 10px 0;
            margin-top: 10px;
            transform: translateY(10px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .has-dropdown:hover .dropdown-menu {
            display: block;
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .dropdown-menu a {
            padding: 12px 20px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-color);
            border-radius: 0;
            font-size: 14px;
        }

        .dropdown-menu a:hover {
            background-color: var(--background-color);
            color: var(--primary-color);
        }

        .dropdown-menu a i {
            font-size: 16px;
            color: var(--secondary-color);
        }

        /* ===================== MAIN CONTENT ===================== */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-panel {
            background-color: var(--card-background);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
        }

        .content-panel h2 {
            color: var(--primary-color);
            margin-top: 0;
            font-size: 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .content-panel p {
            font-size: 16px;
            color: #666;
        }

        /* ===================== FOOTER ===================== */
        .main-footer {
            background-color: var(--primary-color);
            color: var(--light-text-color);
            padding: 20px 30px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        }

        .footer-info, .user-info {
            display: flex;
            gap: 25px;
        }

        .main-footer i {
            color: var(--light-text-color);
            margin-right: 5px;
        }

        /* Styles specific to settings page */
        .settings-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .settings-nav {
            width: 250px;
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 10px;
            box-shadow: var(--shadow-light);
            height: fit-content;
        }

        .settings-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .settings-nav li a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .settings-nav li a:hover,
        .settings-nav li a.active {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
        }
        
        .settings-nav li a:hover i,
        .settings-nav li a.active i {
            color: var(--light-text-color);
        }

        .settings-nav i {
            color: var(--secondary-color);
            font-size: 18px;
        }

        .settings-content {
            flex-grow: 1;
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            padding: 30px;
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-size: 15px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 15px;
            transition: all 0.3s ease;
            background-color: var(--background-color);
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1);
            background-color: var(--card-background);
        }

        .btn-save, .btn-primary {
            background-color: var(--primary-color);
            color: var(--light-text-color);
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .btn-save:hover, .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-add-section {
            background-color: #1e88e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-add-section:hover {
            background-color: #1565c0;
        }
        
        /* === PERMISSIONS & STAFF TABLE STYLES === */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 15px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .data-table th {
            background-color: var(--background-color);
            font-weight: 600;
        }
        .data-table .actions-cell {
             width: 120px;
             text-align: center;
        }
        .actions-cell button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            margin: 0 8px;
            transition: color 0.2s ease;
        }
        .actions-cell .btn-edit { color: var(--secondary-color); }
        .actions-cell .btn-edit:hover { color: var(--primary-color); }
        .actions-cell .btn-delete { color: var(--danger-color); }
        .actions-cell .btn-delete:hover { color: #b71c1c; }
        .actions-cell .btn-delete:disabled { color: #ccc; cursor: not-allowed; }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* === HELP EDITOR STYLES === */
        .help-editor-item {
            border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;
            background-color: #fdfdfd; overflow: hidden; transition: all 0.3s ease;
        }
        .help-editor-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; cursor: pointer; background-color: #f9fafb;
        }
        .help-editor-header h4 { margin: 0; font-weight: 600; color: var(--primary-color); }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .toggle-icon { font-size: 16px; transition: transform 0.3s ease; }
        .help-editor-item.collapsed .toggle-icon { transform: rotate(-90deg); }
        .help-editor-content {
            padding: 0 20px 20px 20px; border-top: 1px solid #eee;
            transition: max-height 0.3s ease-in-out; max-height: 1000px;
        }
        .help-editor-item.collapsed .help-editor-content {
            max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden;
        }
        .ck-editor__editable_inline { min-height: 150px; }
        .help-editor-controls {
            display: flex; justify-content: space-between;
            align-items: center; margin-top: 20px;
        }
        .btn-delete-section {
            background: none; border: none; color: #d32f2f;
            cursor: pointer; font-size: 20px;
        }
        
        /* === MODAL STYLES (FOR STAFF MANAGEMENT) === */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--card-background); padding: 30px;
            border-radius: 12px; box-shadow: var(--shadow-dark);
            width: 90%; max-width: 450px;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;
        }
        .modal-header h3 { margin: 0; color: var(--primary-color); }
        .close-modal-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
        .modal-footer { text-align: right; margin-top: 30px; }
        #modal-message {
            color: var(--danger-color); font-size: 14px; min-height: 20px; text-align: left;
        }
        
        /* === ADDED STYLES FOR SHIFT SETTINGS === */
        .work-days-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: var(--background-color);
        }
        .work-days-container label {
            font-weight: 500;
            color: var(--text-color);
            cursor: pointer;
        }
        .shift-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .shift-item input[type="time"] {
            padding: 10px;
            flex-grow: 1;
        }
        .btn-delete-shift {
            background: none;
            border: none;
            color: var(--danger-color);
            font-size: 22px;
            cursor: pointer;
            padding: 5px;
        }

    </style>
</head>
<body>

    <div class="app-container">
        <header class="main-header">
            <a href="index.html" style="text-decoration: none;">
                <h1 class="app-name"><i class="fa-solid fa-gem"></i></h1>
            </a>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class="fa-solid fa-chart-line"></i> Trang chủ</a></li>
                    <li class="has-dropdown">
                        <a href="#"><i class="fa-solid fa-boxes-stacked"></i> Quản lý</a>
                        <ul class="dropdown-menu">
    <li><a href="quanly_ban.html"><i class="fa-solid fa-table-tennis-paddle-ball"></i> Quản lý bàn</a></li>
    <li><a href="quanly_khachhang.html"><i class="fa-solid fa-address-book"></i> Quản lý Khách hàng</a></li>
    <li><a href="quanly_datban.html"><i class="fa-solid fa-calendar-check"></i> Quản lý Đặt bàn</a></li>
    <li><a href="quanly_thuchi.html"><i class="fa-solid fa-cash-register"></i> Quản lý thu chi</a></li>
    <li><a href="quanly_kho.html"><i class="fa-solid fa-box-open"></i> Quản lý kho</a></li>
    <li><a href="quanly_nhanvien.html"><i class="fa-solid fa-users"></i> Quản lý nhân viên</a></li>
</ul>
                    </li>
                    <li class="has-dropdown">
                        <a href="#"><i class="fa-solid fa-chart-pie"></i> Báo cáo</a>
                        <ul class="dropdown-menu">
                            <li><a href="baocao_doanhthu.html"><i class="fa-solid fa-file-invoice"></i> Doanh thu ngày</a></li>
                            <li><a href="baocao_thongke.html"><i class="fa-solid fa-chart-bar"></i> Thống kê tuần</a></li>
                            <li><a href="baocao_loinhuan.html"><i class="fa-solid fa-file-contract"></i> Báo cáo nhân viên</a></li>
                             <li><a href="baocao_khachhang.html"><i class="fa-solid fa-user-tag"></i> Phân tích Khách hàng</a></li>
                        </ul>
                    </li>
                    <li class="active"><a href="cai_dat.html"><i class="fa-solid fa-gear"></i> Cài đặt</a></li>
                    <li><a href="tro_giup.html"><i class="fa-solid fa-circle-question"></i> Trợ giúp</a></li>
                    <li><a href="#" id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a></li>
                </ul>
            </nav>
        </header>
        
        <div class="content-wrapper">
            <main class="main-content">
                <div class="content-panel">
                    <h2><i class="fa-solid fa-gear"></i> Cài đặt</h2>
                    <p>Tùy chỉnh các thông số hoạt động của phần mềm.</p>
                    
                    <div class="settings-container">
                        <aside class="settings-nav">
                            <ul>
                                <li><a href="#" class="active" data-tab="general"><i class="fa-solid fa-cogs"></i> Cài đặt chung</a></li>
                                <li><a href="#" data-tab="billing"><i class="fa-solid fa-coins"></i> Cài đặt tính tiền</a></li>
                                <li><a href="#" data-tab="membership"><i class="fa-solid fa-crown"></i> Hạng thành viên</a></li>
                                <li><a href="#" data-tab="invoice"><i class="fa-solid fa-receipt"></i> Cài đặt hóa đơn</a></li>
                                <li><a href="#" data-tab="expense-categories"><i class="fa-solid fa-tags"></i> Loại chi phí</a></li>
                                <li><a href="#" data-tab="shifts"><i class="fa-solid fa-clock"></i> Cài đặt Ca làm việc</a></li>
                                <li id="nav-staff-management" style="display: none;"><a href="#" data-tab="staff"><i class="fa-solid fa-users-cog"></i> Quản lý Nhân viên</a></li>
                                <li><a href="#" data-tab="permissions"><i class="fa-solid fa-user-shield"></i> Phân quyền Chức năng</a></li>
                                <li><a href="#" data-tab="help-editor"><i class="fa-solid fa-edit"></i> Chỉnh sửa Trợ giúp</a></li>
                            </ul>
                        </aside>
                        <section class="settings-content">
                            <div id="general" class="settings-section active">
                                <h3>Thông tin quán</h3>
                                <form id="general-form">
                                    <div class="form-group">
                                        <label for="store-name">Tên quán</label>
                                        <input type="text" id="store-name" name="store-name" placeholder="Tên quán của bạn">
                                    </div>
                                    <div class="form-group">
                                        <label for="address">Địa chỉ</label>
                                        <input type="text" id="address" name="address" placeholder="Địa chỉ quán">
                                    </div>
                                    <div class="form-group">
                                        <label for="phone">Số điện thoại</label>
                                        <input type="tel" id="phone" name="phone" placeholder="Số điện thoại liên hệ">
                                    </div>
                                    <div class="form-group">
                                        <label for="tax-code">Mã số thuế (nếu có)</label>
                                        <input type="text" id="tax-code" name="tax-code" placeholder="Mã số thuế của quán">
                                    </div>
                                    <button type="submit" class="btn-save">Lưu Cài đặt chung</button>
                                </form>
                            </div>
                            <div id="membership" class="settings-section">
    <h3><i class="fa-solid fa-crown"></i> Cài đặt Hạng thành viên</h3>
    <p>Định nghĩa các hạng thành viên và ngưỡng chi tiêu tối thiểu để đạt được hạng đó. Hệ thống sẽ tự động nâng hạng cho khách hàng dựa trên tổng chi tiêu của họ.</p>
    
    <div id="membership-tiers-container">
        </div>

    <div style="margin-top: 20px; display: flex; justify-content: space-between;">
        <button type="button" id="add-tier-btn" class="btn-add-section">
            <i class="fa-solid fa-plus"></i> Thêm Hạng
        </button>
        <button type="button" id="save-tiers-btn" class="btn-save">Lưu Cài đặt Hạng</button>
    </div>
</div>
                            
<div id="billing" class="settings-section">
    <h3>Quản lý Bảng giá và Ngày lễ</h3>
    
    <div class="section-container" style="margin-bottom: 40px;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4><i class="fa-solid fa-tags"></i> Danh sách Bảng giá</h4>
            <button id="add-price-list-btn" class="btn-primary"><i class="fa-solid fa-plus"></i> Thêm Bảng giá mới</button>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Tên Bảng giá</th>
                    <th>Giá cơ bản/giờ</th>
                    <th class="actions-cell">Thao tác</th>
                </tr>
            </thead>
            <tbody id="price-list-table-body">
                </tbody>
        </table>
    </div>

    <div class="section-container">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4><i class="fa-solid fa-calendar-alt"></i> Danh sách Ngày lễ (áp dụng hệ số nhân)</h4>
        </div>
        <form id="holiday-form" style="display: flex; gap: 10px; margin-bottom: 20px;">
            <input type="date" id="holiday-date-input" required style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; flex-grow: 1;">
            <button type="submit" class="btn-primary">Thêm ngày lễ</button>
        </form>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Ngày lễ (YYYY-MM-DD)</th>
                    <th class="actions-cell" style="width: 80px;">Thao tác</th>
                </tr>
            </thead>
            <tbody id="holiday-table-body">
                </tbody>
        </table>
    </div>
</div>
                            
                            <div id="invoice" class="settings-section">
    <h3>Tùy chọn in hóa đơn</h3>
    <p>Tùy chỉnh các thông tin sẽ xuất hiện trên hóa đơn thanh toán.</p>
    <form id="invoice-form">

        <h4>Phần đầu (Header)</h4>
        <div class="form-group">
            <label for="invoice-main-title">Tiêu đề chính của hóa đơn</label>
            <input type="text" id="invoice-main-title" name="invoice-main-title" value="HÓA ĐƠN THANH TOÁN" placeholder="Ví dụ: HÓA ĐƠN TÍNH TIỀN">
        </div>
        <div class="form-group">
            <label for="logo-upload">Tải lên Logo của quán</label>
            <input type="file" id="logo-upload" name="logo-upload" accept="image/*">
            <small style="font-size: 12px; color: #777;">Logo sẽ được hiển thị nếu tùy chọn bên dưới được bật.</small>
        </div>
        <div class="form-group">
            <label for="show-logo">Hiển thị logo trên hóa đơn</label>
            <select id="show-logo" name="show-logo">
                <option value="yes">Có</option>
                <option value="no" selected>Không</option>
            </select>
        </div>
        <div class="form-group">
            <label>Thông tin quán hiển thị trên hóa đơn</label>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <label style="font-weight: 500;"><input type="checkbox" name="show-store-name"> Hiển thị Tên quán</label>
                <label style="font-weight: 500;"><input type="checkbox" name="show-address"> Hiển thị Địa chỉ</label>
                <label style="font-weight: 500;"><input type="checkbox" name="show-phone"> Hiển thị Số điện thoại</label>
                <label style="font-weight: 500;"><input type="checkbox" name="show-tax-code"> Hiển thị Mã số thuế</label>
            </div>
             <small style="font-size: 12px; color: #777;">Thông tin được lấy từ mục "Cài đặt chung".</small>
        </div>

        <h4>Thông tin Hóa đơn & Dịch vụ</h4>
        <div class="form-group">
            <label for="show-cashier">Hiển thị tên Nhân viên thu ngân</label>
            <select id="show-cashier" name="show-cashier">
                <option value="yes" selected>Có</option>
                <option value="no">Không</option>
            </select>
        </div>
        <div class="form-group">
            <label for="show-play-time">Hiển thị Thời gian bắt đầu/kết thúc (dịch vụ tính giờ)</label>
            <select id="show-play-time" name="show-play-time">
                <option value="yes" selected>Có</option>
                <option value="no">Không</option>
            </select>
        </div>

        <h4>Phần tổng kết (Footer)</h4>
        <div class="form-group">
            <label for="invoice-footer-text">Lời cảm ơn / Ghi chú cuối hóa đơn</label>
            <textarea id="invoice-footer-text" name="invoice-footer-text" rows="4" placeholder="Ví dụ: Cảm ơn quý khách và hẹn gặp lại!&#10;Wifi: BiaOXU - Pass: 12345678"></textarea>
        </div>
        
        <button type="submit" class="btn-save">Lưu Cài đặt hóa đơn</button>
    </form>
</div>
<div id="expense-categories" class="settings-section">
    <h3><i class="fa-solid fa-tags"></i> Quản lý Loại chi phí</h3>
    <p>
        Tạo và quản lý các danh mục để phân loại các khoản chi của quán.
        Các loại chi phí này sẽ được sử dụng trong trang "Quản lý Thu-Chi".
    </p>
    <div style="text-align: right; margin-bottom: 20px;">
        <button id="add-expense-category-btn" class="btn-primary">
            <i class="fa-solid fa-plus"></i> Thêm Loại chi phí
        </button>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 60px;">STT</th>
                <th>Tên Loại chi phí</th>
                <th class="actions-cell">Thao tác</th>
            </tr>
        </thead>
        <tbody id="expense-category-table-body">
        </tbody>
    </table>
</div>
                            
                            <div id="shifts" class="settings-section">
                                <h3>Cài đặt Ca làm việc</h3>
                                <form id="shift-settings-form">
                                    <div class="form-group">
                                        <label>Ngày làm việc trong tuần</label>
                                        <div class="work-days-container">
                                            <label><input type="checkbox" name="workDay" value="1"> Thứ 2</label>
                                            <label><input type="checkbox" name="workDay" value="2"> Thứ 3</label>
                                            <label><input type="checkbox" name="workDay" value="3"> Thứ 4</label>
                                            <label><input type="checkbox" name="workDay" value="4"> Thứ 5</label>
                                            <label><input type="checkbox" name="workDay" value="5"> Thứ 6</label>
                                            <label><input type="checkbox" name="workDay" value="6"> Thứ 7</label>
                                            <label><input type="checkbox" name="workDay" value="0"> Chủ Nhật</label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Danh sách ca làm việc</label>
                                        <div id="shifts-list-container">
                                            </div>
                                        <button type="button" id="add-shift-btn" class="btn-add-section">
                                            <i class="fa-solid fa-plus"></i> Thêm ca
                                        </button>
                                    </div>
                                    <button type="submit" class="btn-save">Lưu Cài đặt Ca</button>
                                </form>
                            </div>

                            <div id="staff" class="settings-section">
                                <h3>Quản lý Tài khoản Nhân viên</h3>
                                <div style="text-align: right; margin-bottom: 20px;">
                                    <button id="add-staff-btn" class="btn-primary"><i class="fa-solid fa-plus"></i> Thêm nhân viên mới</button>
                                </div>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px;">STT</th>
                                            <th>Tên đăng nhập</th>
                                            <th style="width: 150px;">Vai trò</th>
                                            <th class="actions-cell">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-table-body">
                                        </tbody>
                                </table>
                            </div>

                            <div id="permissions" class="settings-section">
                                <h3>Phân quyền Chức năng cho tài khoản 'user'</h3>
                                <p>Tích để cấp quyền cho phép tài khoản cấp 'user' xem và sử dụng các chức năng tương ứng.</p>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Tên chức năng</th>
                                            <th>Quyền Truy cập (User)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="permissions-table-body">
                                        </tbody>
                                </table>
                                <div style="text-align: right; margin-top: 20px;">
                                    <button id="save-permissions-btn" class="btn-save">Lưu Phân quyền</button>
                                </div>
                            </div>
                            
                            <div id="help-editor" class="settings-section">
                                <h3>Chỉnh sửa nội dung trang Trợ giúp</h3>
                                <div id="help-editor-container">
                                    </div>
                                <div class="help-editor-controls">
                                    <button id="add-help-section-btn" class="btn-add-section"><i class="fa-solid fa-plus"></i> Thêm mục mới</button>
                                    <button id="save-help-content-btn" class="btn-save">Lưu thay đổi</button>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </main>
        </div>

        <footer class="main-footer">
            <div class="footer-info">
                <span class="copyright-info"></span>
                <span class="phone-info"></span>
            </div>
            <div class="user-info">
                <span id="footer-username"><i class="fa-solid fa-user"></i> Người dùng: </span>
                <span><i class="fa-solid fa-circle-check"></i> Trạng thái: OK</span>
            </div>
        </footer>
    </div>
    
    <div id="staff-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Thêm nhân viên mới</h3>
                <button id="close-staff-modal-btn" class="close-modal-btn">&times;</button>
            </div>
            <form id="staff-form">
                <input type="hidden" id="staff-id" />
                <div class="form-group">
                    <label for="staff-username">Tên đăng nhập</label>
                    <input type="text" id="staff-username" required>
                </div>
                <div class="form-group">
                    <label for="staff-password">Mật khẩu</label>
                    <input type="password" id="staff-password">
                    <small style="font-size: 12px; color: #777;">Để trống nếu không muốn thay đổi mật khẩu.</small>
                </div>
                <div class="form-group">
                    <label for="staff-role">Vai trò</label>
                    <select id="staff-role" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div id="modal-message"></div>
                <div class="modal-footer">
                    <button type="submit" id="save-staff-btn" class="btn-primary">Lưu lại</button>
                </div>
            </form>
        </div>
    </div>

    <div id="price-list-modal" class="modal-backdrop">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="price-list-modal-title">Thêm Bảng giá mới</h3>
            <button id="close-price-list-modal-btn" class="close-modal-btn">&times;</button>
        </div>
        <form id="price-list-form">
            <input type="hidden" id="price-list-id">
            <div class="form-group">
                <label for="price-list-name">Tên Bảng giá</label>
                <input type="text" id="price-list-name" required placeholder="VD: Bàn Thường, Bàn VIP">
            </div>
            <div class="form-group">
                <label for="base-price">Giá cơ bản / giờ (VNĐ)</label>
                <input type="number" id="base-price" required min="0" placeholder="Giá mặc định khi không trong khung giờ đặc biệt">
            </div>
            <hr style="margin: 20px 0;">
            <h4>Khung giờ đặc biệt (giá ngày/đêm)</h4>
            <div id="time-slots-container">
                </div>
            <button type="button" id="add-time-slot-btn" class="btn-add-section" style="margin-bottom: 20px;"><i class="fa-solid fa-plus"></i> Thêm khung giờ</button>
            <hr style="margin: 20px 0;">
            <h4>Hệ số nhân giá (Multipliers)</h4>
            <p style="font-size: 13px; color: #666;">Nhập 1 nếu không muốn thay đổi giá. VD: 1.2 = tăng 20%.</p>
            <div style="display: flex; gap: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label for="weekend-multiplier">Cuối tuần (Thứ 7, CN)</label>
                    <input type="number" id="weekend-multiplier" min="0" step="0.01" value="1.0">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="holiday-multiplier">Ngày lễ</label>
                    <input type="number" id="holiday-multiplier" min="0" step="0.01" value="1.0">
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn-primary">Lưu Bảng giá</button>
            </div>
        </form>
    </div>
</div>
<div id="expense-category-modal" class="modal-backdrop">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="expense-category-modal-title">Thêm Loại chi phí mới</h3>
            <button id="close-expense-category-modal-btn" class="close-modal-btn">&times;</button>
        </div>
        <form id="expense-category-form">
            <input type="hidden" id="expense-category-id" />
            <div class="form-group">
                <label for="expense-category-name">Tên Loại chi phí</label>
                <input type="text" id="expense-category-name" required placeholder="VD: Chi phí mặt bằng, Lương nhân viên...">
            </div>
            <div id="expense-category-modal-message" style="color: var(--danger-color); font-size: 14px; min-height: 20px; text-align: left;"></div>
            <div class="modal-footer">
                <button type="submit" class="btn-primary">Lưu lại</button>
            </div>
        </form>
    </div>
</div>
    
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>

    <script>
        // Các hàm quản lý modal chung
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Kiểm tra quyền truy cập trang
        (function() {
            const userRole = sessionStorage.getItem('userRole');
            if (userRole === 'user') {
                try {
                    const permissions = JSON.parse(localStorage.getItem('biaOxuUserPermissions')) || {};
                    if (!permissions['cai_dat'] || !permissions['cai_dat'].access) {
                        document.body.style.display = 'none'; 
                        alert('Bạn không có quyền truy cập chức năng này.');
                        window.location.href = 'index.html';
                    }
                } catch (e) { 
                    console.error("Lỗi phân tích cú pháp dữ liệu phân quyền:", e);
                    window.location.href = 'index.html';
                }
            }
        })();

        // Hàm kiểm tra quyền chung
        function checkUserPermission(featureId) {
            const userRole = sessionStorage.getItem('userRole');
            if (userRole === 'admin') return true;
            if (userRole === 'user') {
                try {
                    const permissions = JSON.parse(localStorage.getItem('biaOxuUserPermissions')) || {};
                    return permissions[featureId] && permissions[featureId].access === true;
                } catch (e) { 
                    console.error("Lỗi phân tích cú pháp dữ liệu phân quyền:", e); 
                    return false; 
                }
            }
            return false;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            const userRole = sessionStorage.getItem('userRole');
            document.getElementById('footer-username').innerHTML = `<i class="fa-solid fa-user"></i> Người dùng: ${loggedInUser}`;

            // === LOGIC CHO TAB CÀI ĐẶT ===
            const navLinks = document.querySelectorAll('.settings-nav a');
            const sections = document.querySelectorAll('.settings-section');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = link.getAttribute('data-tab');
                    if ((tabId === 'permissions' || tabId === 'staff') && userRole !== 'admin') {
                        alert('Bạn không có quyền truy cập chức năng này.');
                        return;
                    }
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    sections.forEach(sec => sec.classList.remove('active'));
                    link.classList.add('active');
                    document.getElementById(tabId).classList.add('active');

                    if (tabId === 'permissions') { loadPermissions(); renderPermissionsTable(); } 
                    else if (tabId === 'staff') { renderStaffTable(); } 
                    else if (tabId === 'help-editor') { loadHelpEditor(); } 
                    else if (tabId === 'billing') { renderPriceLists(); renderHolidays(); }
                    else if (tabId === 'shifts') { loadShiftSettings(); }
                    else if (tabId === 'expense-categories') { renderExpenseCategoryTable(); }
                     else if (tabId === 'membership') { loadMembershipTiers(); } 
                });
            });

            // === LOGIC LƯU VÀ TẢI DỮ LIỆU CÀI ĐẶT CHUNG ===
           // THAY THẾ TOÀN BỘ ĐOẠN MÃ NÀY TRONG FILE cai_dat.html
const forms = document.querySelectorAll('form:not(#staff-form):not(#shift-settings-form):not(#price-list-form):not(#holiday-form)');
forms.forEach(form => {
    form.addEventListener('submit', async (e) => { // <-- THÊM ASYNC Ở ĐÂY
        e.preventDefault();
        const settings = {};

        // === BẮT ĐẦU THAY ĐỔI LOGIC LƯU FORM HÓA ĐƠN ===
        if (form.id === 'invoice-form') {
            // Lấy tất cả input, textarea, select
            form.querySelectorAll('input:not([type="checkbox"]):not([type="file"]), textarea, select').forEach(input => {
                settings[input.name] = input.value;
            });
            // Lấy các checkbox
            form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                settings[checkbox.name] = checkbox.checked;
            });

            // Xử lý file logo
            const logoInput = form.querySelector('#logo-upload');
            if (logoInput.files && logoInput.files[0]) {
                try {
                    // Đọc file ảnh và chuyển thành Base64 Data URL
                    const file = logoInput.files[0];
                    const logoDataUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = error => reject(error);
                        reader.readAsDataURL(file);
                    });
                    // Lưu chuỗi Base64 vào settings
                    settings['logo-data-url'] = logoDataUrl;
                } catch (error) {
                    console.error("Lỗi khi đọc file logo:", error);
                    alert("Đã xảy ra lỗi khi tải lên logo. Vui lòng thử lại.");
                    return; // Dừng nếu có lỗi
                }
            } else {
                 // Nếu không chọn file mới, giữ lại logo cũ (nếu có)
                 const oldSettings = JSON.parse(localStorage.getItem(form.id) || '{}');
                 if(oldSettings['logo-data-url']) {
                    settings['logo-data-url'] = oldSettings['logo-data-url'];
                 }
            }
             localStorage.setItem(form.id, JSON.stringify(settings));

        } else { // Giữ nguyên logic cho các form khác
            const formData = new FormData(form);
            formData.forEach((value, key) => { settings[key] = value; });
            localStorage.setItem(form.id, JSON.stringify(settings));
        }
        // === KẾT THÚC THAY ĐỔI LOGIC LƯU FORM HÓA ĐƠN ===

        alert('Cài đặt đã được lưu thành công!');

        if (form.id === 'general-form') {
            updateStoreInfo();
        }
    });
});

            function loadSettings() {
                forms.forEach(form => {
                    const savedData = localStorage.getItem(form.id);
                    if (savedData) {
                        try {
                            const settings = JSON.parse(savedData);
                            for (const key in settings) {
                                const inputs = form.querySelectorAll(`[name="${key}"]`);
                                if (inputs.length > 0) {
                                    inputs.forEach(input => {
                                        const type = input.type;
                                        const value = settings[key];
                                        if (type === 'checkbox') {
                                            input.checked = value;
                                        } else if (type === 'radio') {
                                            if (input.value === value) input.checked = true;
                                        } else {
                                            input.value = value;
                                        }
                                    });
                                }
                            }
                        } catch (e) {
                            console.error(`Không thể tải cài đặt cho ${form.id}`, e);
                        }
                    }
                });
            }
            
            function updateStoreInfo() {
                const defaultStoreName = 'BI-A OXU';
                const defaultPhone = '0902.022.665';
                let storeName = defaultStoreName;
                let phone = defaultPhone;
                
                try {
                    const savedData = localStorage.getItem('general-form');
                    if (savedData) {
                        const settings = JSON.parse(savedData);
                        storeName = settings['store-name'] || defaultStoreName;
                        phone = settings.phone || defaultPhone;
                    }
                } catch (e) { 
                    console.error("Không thể cập nhật thông tin quán", e);
                }
                
                document.querySelector('.main-header .app-name').innerHTML = `<i class="fa-solid fa-gem"></i> ${storeName}`;
                document.querySelector('.main-footer .phone-info').innerHTML = `<i class="fa-solid fa-phone"></i> Hotline: ${phone}`;
                document.querySelector('.main-footer .copyright-info').innerHTML = `<i class="fa-solid fa-copyright"></i> 2025 ${storeName}. All rights reserved.`;
            }

            // === KHỞI TẠO VÀ TẢI DỮ LIỆU LẦN ĐẦU ===
            loadSettings();
            updateStoreInfo();
            configureUIAccess();
            
            // === START: SHIFT SETTINGS LOGIC ===
            const SHIFT_SETTINGS_KEY = 'biaOxuShiftSettings';
            const shiftsContainer = document.getElementById('shifts-list-container');
            const shiftSettingsForm = document.getElementById('shift-settings-form');

            function renderShiftItem(shift = { start: '', end: '' }) {
                const shiftDiv = document.createElement('div');
                shiftDiv.className = 'shift-item';
                shiftDiv.innerHTML = `
                    <input type="time" class="shift-start" value="${shift.start}" required>
                    <span>đến</span>
                    <input type="time" class="shift-end" value="${shift.end}" required>
                    <button type="button" class="btn-delete-shift" title="Xóa ca này">&times;</button>
                `;
                shiftDiv.querySelector('.btn-delete-shift').addEventListener('click', () => {
                    shiftDiv.remove();
                });
                shiftsContainer.appendChild(shiftDiv);
            }

            function loadShiftSettings() {
                const settings = JSON.parse(localStorage.getItem(SHIFT_SETTINGS_KEY)) || {
                    workDays: ['1', '2', '3', '4', '5'], // Default: Mon-Fri
                    shifts: [
                        { start: '09:00', end: '13:00' },
                        { start: '13:00', end: '17:00' },
                        { start: '17:00', end: '21:00' },
                        { start: '21:00', end: '01:00' },
                    ]
                };

                shiftSettingsForm.querySelectorAll('input[name="workDay"]').forEach(cb => {
                    cb.checked = settings.workDays.includes(cb.value);
                });

                shiftsContainer.innerHTML = ''; 
                settings.shifts.forEach(shift => {
                    renderShiftItem(shift);
                });
            }

            function saveShiftSettings(e) {
                e.preventDefault();
                const workDays = Array.from(shiftSettingsForm.querySelectorAll('input[name="workDay"]:checked'))
                                    .map(cb => cb.value);
                
                const shifts = [];
                shiftsContainer.querySelectorAll('.shift-item').forEach(item => {
                    const start = item.querySelector('.shift-start').value;
                    const end = item.querySelector('.shift-end').value;
                    if (start && end) {
                        shifts.push({ start, end });
                    }
                });

                const settings = { workDays, shifts };
                localStorage.setItem(SHIFT_SETTINGS_KEY, JSON.stringify(settings));
                alert('Đã lưu cài đặt ca làm việc thành công!');
            }

            document.getElementById('add-shift-btn').addEventListener('click', () => renderShiftItem());
            shiftSettingsForm.addEventListener('submit', saveShiftSettings);
            // === END: SHIFT SETTINGS LOGIC ===

            // === LOGIC ẨN/HIỆN MENU DỰA TRÊN QUYỀN ===
            function configureUIAccess() {
                const permissionMap = {
                    'quanly_ban.html': 'quanly_ban', 'quanly_thuchi.html': 'quanly_thuchi',
                    'quanly_kho.html': 'quanly_kho', 'quanly_nhanvien.html': 'quanly_nhanvien',
                    'baocao_doanhthu.html': 'baocao_doanhthu', 'baocao_thongke.html': 'baocao_thongke',
                    'baocao_loinhuan.html': 'baocao_loinhuan', 'cai_dat.html': 'cai_dat',
                };
                document.querySelectorAll('.main-nav a').forEach(link => {
                    const featureId = permissionMap[link.getAttribute('href')];
                    if (featureId && !checkUserPermission(featureId)) {
                        link.parentElement.style.display = 'none';
                    }
                });
                if (userRole === 'admin') {
                    document.getElementById('nav-staff-management').style.display = 'block';
                }
            }

            // === LOGIC ĐĂNG XUẤT ===
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                sessionStorage.clear();
                window.location.href = 'login.html';
            });
            
            // === START: STAFF MANAGEMENT LOGIC ===
            const ACCOUNTS_STORAGE_KEY = 'biaOxuAccounts';
            const staffForm = document.getElementById('staff-form');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');

            function getAccounts() {
                try {
                    const accountsJSON = localStorage.getItem(ACCOUNTS_STORAGE_KEY);
                    return accountsJSON ? JSON.parse(accountsJSON) : [];
                } catch (e) {
                    console.error("Lỗi phân tích cú pháp dữ liệu tài khoản:", e);
                    return [];
                }
            }
            
            function setupStaffModal(mode, user = null) {
                staffForm.reset();
                modalMessage.textContent = '';
                document.getElementById('staff-id').value = '';
                document.getElementById('staff-password').required = (mode === 'add');
                if (mode === 'edit' && user) {
                    modalTitle.textContent = 'Chỉnh sửa tài khoản';
                    document.getElementById('staff-id').value = user.username;
                    document.getElementById('staff-username').value = user.username;
                    document.getElementById('staff-role').value = user.role;
                } else {
                    modalTitle.textContent = 'Thêm nhân viên mới';
                }
                openModal('staff-modal');
            }

            function renderStaffTable() {
                const accounts = getAccounts();
                const tableBody = document.getElementById('staff-table-body');
                tableBody.innerHTML = '';
                accounts.forEach((acc, index) => {
                    const isCurrentUser = acc.username === loggedInUser;
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${acc.username}</td>
                            <td><span style="font-weight: 500; color: ${acc.role === 'admin' ? 'var(--danger-color)' : 'var(--text-color)'};">${acc.role.toUpperCase()}</span></td>
                            <td class="actions-cell">
                                <button class="btn-edit" data-username="${acc.username}" title="Sửa"><i class="fa-solid fa-pencil-alt"></i></button>
                                <button class="btn-delete" data-username="${acc.username}" title="Xóa" ${isCurrentUser ? 'disabled' : ''}><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            document.getElementById('add-staff-btn').addEventListener('click', () => setupStaffModal('add'));
            document.getElementById('close-staff-modal-btn').addEventListener('click', () => closeModal('staff-modal'));

            document.getElementById('staff-table-body').addEventListener('click', (e) => {
                const accounts = getAccounts();
                const btn = e.target.closest('button');
                if (!btn) return;

                const username = btn.dataset.username;
                if (btn.classList.contains('btn-edit')) {
                    const userToEdit = accounts.find(acc => acc.username === username);
                    if(userToEdit) setupStaffModal('edit', userToEdit);
                } else if (btn.classList.contains('btn-delete')) {
                    if (confirm(`Bạn có chắc chắn muốn xóa tài khoản '${username}'?`)) {
                        const updatedAccounts = accounts.filter(acc => acc.username !== username);
                        localStorage.setItem(ACCOUNTS_STORAGE_KEY, JSON.stringify(updatedAccounts));
                        renderStaffTable();
                    }
                }
            });
            
            staffForm.addEventListener('submit', (e) => {
                e.preventDefault();
                let accounts = getAccounts();
                const username = document.getElementById('staff-username').value.trim();
                const password = document.getElementById('staff-password').value;
                const role = document.getElementById('staff-role').value;
                const staffId = document.getElementById('staff-id').value;

                modalMessage.textContent = '';
                if (!username) {
                    modalMessage.textContent = 'Tên đăng nhập không được để trống.';
                    return;
                }
                const salt = bcrypt.genSaltSync(10);
                if (staffId) {
                    const userIndex = accounts.findIndex(acc => acc.username === staffId);
                    if (userIndex > -1) {
                        if (accounts.some(acc => acc.username === username && acc.username !== staffId)) {
                            modalMessage.textContent = 'Tên đăng nhập đã tồn tại.';
                            return;
                        }
                        accounts[userIndex].username = username;
                        accounts[userIndex].role = role;
                        if (password) {
                            accounts[userIndex].password = bcrypt.hashSync(password, salt);
                        }
                    }
                } else {
                    if (accounts.some(acc => acc.username === username)) {
                        modalMessage.textContent = 'Tên đăng nhập đã tồn tại.';
                        return;
                    }
                    const hashedPassword = bcrypt.hashSync(password, salt);
                    accounts.push({ username, password: hashedPassword, role });
                }
                localStorage.setItem(ACCOUNTS_STORAGE_KEY, JSON.stringify(accounts));
                renderStaffTable();
                closeModal('staff-modal');
            });
            // === END: STAFF MANAGEMENT LOGIC ===

            // === START: HELP PAGE EDITOR LOGIC ===
            const HELP_CONTENT_KEY = 'biaOxuHelpContent';
            const helpEditorContainer = document.getElementById('help-editor-container');
            const addSectionBtn = document.getElementById('add-help-section-btn');
            const saveHelpBtn = document.getElementById('save-help-content-btn');
            let editorInstances = [];

            async function createHelpEditorItem(item = { title: '', content: '' }, index, isExpanded = false) {
                const div = document.createElement('div');
                div.className = `help-editor-item ${isExpanded ? '' : 'collapsed'}`;
                div.setAttribute('data-index', index);
                const editorId = `editor-${Date.now()}-${index}`;
                div.innerHTML = `
                    <div class="help-editor-header">
                        <h4 class="header-title">${item.title || 'Mục mới'}</h4>
                        <div class="header-controls">
                            <i class="fa-solid fa-chevron-down toggle-icon"></i>
                            <button class="btn-delete-section" title="Xóa mục này">🗑️</button>
                        </div>
                    </div>
                    <div class="help-editor-content">
                        <div class="form-group">
                            <label>Tiêu đề mục</label>
                            <input type="text" class="help-item-title" value="${item.title}">
                        </div>
                        <div class="form-group">
                            <label>Nội dung</label>
                            <div id="${editorId}">${item.content}</div>
                        </div>
                    </div>
                `;
                div.querySelector('.btn-delete-section').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('Bạn có chắc muốn xóa mục này?')) {
                        const editor = editorInstances[index];
                        if (editor) { editor.destroy(); editorInstances[index] = null; }
                        div.remove();
                    }
                });
                div.querySelector('.help-editor-header').addEventListener('click', () => {
                    div.classList.toggle('collapsed');
                });
                const titleInput = div.querySelector('.help-item-title');
                titleInput.addEventListener('input', () => {
                    div.querySelector('.header-title').textContent = titleInput.value || 'Mục mới';
                });
                helpEditorContainer.appendChild(div);
                try {
                    const editor = await ClassicEditor.create(document.querySelector(`#${editorId}`));
                    editorInstances[index] = editor;
                } catch (error) { console.error(`Lỗi khởi tạo editor #${editorId}:`, error); }
            }

            function loadHelpEditor() {
                helpEditorContainer.innerHTML = '';
                editorInstances.forEach(editor => editor && editor.destroy());
                editorInstances = [];
                let content = [];
                try {
                    const storedContent = localStorage.getItem(HELP_CONTENT_KEY);
                    const defaultHelpContent = [
                        { title: 'Giới thiệu', content: '<p>Chào mừng bạn đến với phần mềm quản lý quán Bi-a OXU.</p>' },
                        { title: 'Quản lý bàn', content: '<ul><li>Để bắt đầu, hãy vào mục <strong>Quản lý bàn</strong>.</li><li>Nhấn vào bàn trống để bắt đầu tính giờ.</li></ul>' }
                    ];
                    content = storedContent ? JSON.parse(storedContent) : defaultHelpContent;
                } catch (e) { 
                    console.error("Không thể tải nội dung Trợ giúp", e);
                    content = [];
                }
                content.forEach((item, index) => createHelpEditorItem(item, index, false));
            }

            addSectionBtn.addEventListener('click', () => {
                const newIndex = editorInstances.length;
                createHelpEditorItem({ title: '', content: '' }, newIndex, true);
            });

            saveHelpBtn.addEventListener('click', () => {
                const items = [];
                helpEditorContainer.querySelectorAll('.help-editor-item').forEach(itemEl => {
                    const index = parseInt(itemEl.getAttribute('data-index'), 10);
                    const titleInput = itemEl.querySelector('.help-item-title');
                    const editor = editorInstances[index];
                    if (titleInput && titleInput.value && editor) {
                        items.push({ title: titleInput.value, content: editor.getData() });
                    }
                    itemEl.classList.add('collapsed');
                });
                localStorage.setItem(HELP_CONTENT_KEY, JSON.stringify(items));
                alert('Đã lưu nội dung trang Trợ giúp thành công!');
            });
            // === END: HELP PAGE EDITOR LOGIC ===

            // === START: PERMISSIONS LOGIC ===
            const PERMISSIONS_STORAGE_KEY = 'biaOxuUserPermissions';
            let userPermissions = {};

            const allFeatures = [
                { id: 'quanly_ban', name: 'Quản lý Bàn', subFeatures: [ { id: 'access', name: 'Truy cập trang' }, { id: 'can_add', name: 'Thêm bàn mới' }, { id: 'can_edit', name: 'Sửa thông tin bàn' }, { id: 'can_delete', name: 'Xóa bàn' }, { id: 'view_tab_menu', name: 'Xem tab Thực đơn' }, { id: 'view_tab_saved_bills', name: 'Xem tab Hóa đơn đã lưu' }, ], },
                { id: 'quanly_thuchi', name: 'Quản lý Thu Chi', subFeatures: [ { id: 'access', name: 'Truy cập trang' }, { id: 'can_add_income', name: 'Lập phiếu thu' }, { id: 'can_add_expense', name: 'Lập phiếu chi' }, { id: 'can_edit', name: 'Sửa phiếu thu/chi' }, { id: 'can_delete', name: 'Xóa phiếu thu/chi' }, ], },
                { id: 'quanly_kho', name: 'Quản lý Kho', subFeatures: [ { id: 'access', name: 'Truy cập trang' }, { id: 'view_tab_kho', name: 'Lịch sử nhập kho' }, { id: 'can_add', name: 'Thêm sản phẩm' }, { id: 'can_add_kho', name: 'Nhập kho' }, { id: 'can_edit', name: 'Sửa sản phẩm' }, { id: 'can_delete', name: 'Xóa sản phẩm' }, ], },
                { id: 'quanly_nhanvien', name: 'Quản lý Nhân viên', subFeatures: [ { id: 'access', name: 'Truy cập trang' }, { id: 'can_add', name: 'Thêm nhân viên' }, { id: 'can_edit', name: 'Sửa thông tin nhân viên' }, { id: 'can_delete', name: 'Xóa nhân viên' }, { id: 'view_tab_quanlynhanvien', name: 'Xem tab Quản lý nhân viên' }, { id: 'view_tab_chamcong', name: 'Xem tab Chấm công' }, { id: 'view_tab_dangkyca', name: 'Xem tab Đăng ký ca' }, ], },
                { id: 'baocao_doanhthu', name: 'Báo cáo Doanh thu Ngày', subFeatures: [{ id: 'access', name: 'Truy cập trang' }], },
                { id: 'baocao_thongke', name: 'Báo cáo Thống kê Tuần', subFeatures: [{ id: 'access', name: 'Truy cập trang' }], },
                { id: 'baocao_loinhuan', name: 'Báo cáo Nhân viên', subFeatures: [{ id: 'access', name: 'Truy cập trang' }], },
                 { id: 'baocao_khachhang', name: 'Phân tích khách hàng', subFeatures: [{ id: 'access', name: 'Truy cập trang' }], },
                { id: 'cai_dat', name: 'Cài đặt Hệ thống', subFeatures: [{ id: 'access', name: 'Truy cập trang' }], },
                {
    id: 'quanly_khachhang',
    name: 'Quản lý Khách hàng',
    subFeatures: [
        { id: 'access', name: 'Truy cập trang' },
        { id: 'can_add', name: 'Thêm khách hàng' },
        { id: 'can_edit', name: 'Sửa khách hàng' },
        { id: 'can_delete', name: 'Xóa khách hàng' },
    ],
},
{
    id: 'quanly_datban',
    name: 'Quản lý Đặt bàn',
    subFeatures: [
        { id: 'access', name: 'Truy cập trang' },
        { id: 'can_add', name: 'Tạo lịch đặt mới' },
        { id: 'can_cancel', name: 'Hủy lịch đặt' },
    ],
},
            ];

            function loadPermissions() {
                try {
                    const storedPermissions = localStorage.getItem(PERMISSIONS_STORAGE_KEY);
                    userPermissions = storedPermissions ? JSON.parse(storedPermissions) : {};
                } catch(e) {
                     console.error("Không thể tải dữ liệu phân quyền", e);
                     userPermissions = {};
                }
                
                let needsUpdate = false;
                allFeatures.forEach(feature => {
                    if (!userPermissions[feature.id]) {
                        userPermissions[feature.id] = {};
                        needsUpdate = true;
                    }
                    feature.subFeatures.forEach(sub => {
                        if (typeof userPermissions[feature.id][sub.id] === 'undefined') {
                             const defaultValue = (feature.id === 'quanly_ban' && (sub.id === 'access' || sub.id === 'view_tab_menu' || sub.id === 'view_tab_saved_bills'));
                            userPermissions[feature.id][sub.id] = defaultValue;
                            needsUpdate = true;
                        }
                    });
                });
                if (needsUpdate) {
                    localStorage.setItem(PERMISSIONS_STORAGE_KEY, JSON.stringify(userPermissions));
                }
            }

            function renderPermissionsTable() {
                const tableBody = document.getElementById('permissions-table-body');
                tableBody.innerHTML = '';
                allFeatures.forEach(feature => {
                    const mainRow = document.createElement('tr');
                    mainRow.style.backgroundColor = 'var(--background-color)';
                    mainRow.innerHTML = `<td colspan="2" style="font-weight: 600;">${feature.name}</td>`;
                    tableBody.appendChild(mainRow);
                    feature.subFeatures.forEach(subFeature => {
                        const hasAccess = userPermissions[feature.id] && userPermissions[feature.id][subFeature.id] === true;
                        const subRow = document.createElement('tr');
                        subRow.innerHTML = `
                            <td style="padding-left: 30px;">${subFeature.name}</td>
                            <td>
                                <label class="toggle-switch">
                                    <input type="checkbox" data-feature-id="${feature.id}" data-sub-feature-id="${subFeature.id}" ${hasAccess ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                            </td>
                        `;
                        tableBody.appendChild(subRow);
                    });
                });
            }
            
            document.getElementById('permissions-table-body').addEventListener('change', (event) => {
                if (event.target.type === 'checkbox') {
                    const featureId = event.target.dataset.featureId;
                    const subFeatureId = event.target.dataset.subFeatureId;
                    if (!userPermissions[featureId]) userPermissions[featureId] = {};
                    userPermissions[featureId][subFeatureId] = event.target.checked;
                }
            });

            document.getElementById('save-permissions-btn').addEventListener('click', () => {
                localStorage.setItem(PERMISSIONS_STORAGE_KEY, JSON.stringify(userPermissions));
                alert('Đã lưu cài đặt phân quyền thành công!');
            });
            // === END: PERMISSIONS LOGIC ===

             // ==========================================================
    // ===== BẮT ĐẦU CODE MỚI CHO HẠNG THÀNH VIÊN =====
    // ==========================================================
    const tiersContainer = document.getElementById('membership-tiers-container');
    const addTierBtn = document.getElementById('add-tier-btn');
    const saveTiersBtn = document.getElementById('save-tiers-btn');
    const MEMBERSHIP_TIERS_KEY = 'biaOxuMembershipTiers';
    let membershipTiers = [];

    function renderTierItem(tier = { id: `tier-${Date.now()}`, name: '', threshold: 0 }) {
        const tierDiv = document.createElement('div');
        tierDiv.className = 'tier-item';
        tierDiv.setAttribute('data-id', tier.id);
        tierDiv.style.cssText = 'display: flex; gap: 15px; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 8px;';
        
        tierDiv.innerHTML = `
            <div class="form-group" style="flex: 1; margin: 0;">
                <label>Tên Hạng</label>
                <input type="text" class="tier-name" value="${tier.name}" placeholder="VD: Bạc, Vàng...">
            </div>
            <div class="form-group" style="flex: 1; margin: 0;">
                <label>Ngưỡng chi tiêu tối thiểu (VNĐ)</label>
                <input type="number" class="tier-threshold" value="${tier.threshold}" min="0" placeholder="VD: 5000000">
            </div>
            <button type="button" class="btn-delete-shift" title="Xóa hạng này" style="align-self: flex-end; margin-bottom: 5px;">&times;</button>
        `;
        
        tierDiv.querySelector('.btn-delete-shift').addEventListener('click', (e) => {
            if (confirm('Bạn có chắc muốn xóa hạng này?')) {
                e.target.closest('.tier-item').remove();
            }
        });
        
        tiersContainer.appendChild(tierDiv);
    }

    function loadMembershipTiers() {
        const storedTiers = localStorage.getItem(MEMBERSHIP_TIERS_KEY);
        tiersContainer.innerHTML = '';
        
        const defaultTier = { id: 'default', name: 'Thường', threshold: 0 };
        const defaultTierDiv = document.createElement('div');
        defaultTierDiv.setAttribute('data-id', defaultTier.id);
        defaultTierDiv.style.cssText = 'display: flex; gap: 15px; align-items: center; margin-bottom: 10px; padding: 10px; background-color: #f0f4f8; border-radius: 8px;';
        defaultTierDiv.innerHTML = `
            <div style="flex: 1;"><strong>${defaultTier.name}</strong> (Mặc định)</div>
            <div style="flex: 1;">Ngưỡng chi tiêu: <strong>0đ</strong></div>
            <div style="width: 42px;"></div>
        `;
        tiersContainer.appendChild(defaultTierDiv);

        if (storedTiers) {
            membershipTiers = JSON.parse(storedTiers);
            membershipTiers.filter(t => t.id !== 'default').forEach(renderTierItem);
        } else {
            [{id: 'tier-1', name: 'Bạc', threshold: 5000000}, {id: 'tier-2', name: 'Vàng', threshold: 15000000}].forEach(renderTierItem);
        }
    }

    function saveMembershipTiers() {
        const tierItems = tiersContainer.querySelectorAll('.tier-item');
        let tiersToSave = [];
        let hasError = false;

        tierItems.forEach(item => {
            const id = item.dataset.id;
            const name = item.querySelector('.tier-name').value.trim();
            const threshold = parseInt(item.querySelector('.tier-threshold').value, 10);

            if (!name || isNaN(threshold)) {
                alert('Tên hạng không được để trống và ngưỡng chi tiêu phải là một con số.');
                hasError = true;
                return;
            }

            tiersToSave.push({ id, name, threshold });
        });

        if (hasError) return;

        tiersToSave.sort((a, b) => b.threshold - a.threshold);

        localStorage.setItem(MEMBERSHIP_TIERS_KEY, JSON.stringify(tiersToSave));
        alert('Đã lưu cài đặt hạng thành viên thành công!');

        loadMembershipTiers();
    }

    addTierBtn.addEventListener('click', () => renderTierItem());
    saveTiersBtn.addEventListener('click', saveMembershipTiers);
    // ==========================================================
    // ===== KẾT THÚC CODE MỚI CHO HẠNG THÀNH VIÊN =====
    // ==========================================================
        });

// === START: PRICE LIST & HOLIDAY MANAGEMENT LOGIC ===
const PRICE_LIST_STORAGE_KEY = 'biaOxuPriceLists';
const HOLIDAY_STORAGE_KEY = 'biaOxuHolidays';
const priceListForm = document.getElementById('price-list-form');
const timeSlotsContainer = document.getElementById('time-slots-container');
const holidayForm = document.getElementById('holiday-form');
let priceLists = JSON.parse(localStorage.getItem(PRICE_LIST_STORAGE_KEY)) || {};
let holidays = JSON.parse(localStorage.getItem(HOLIDAY_STORAGE_KEY)) || [];

function savePriceLists() { localStorage.setItem(PRICE_LIST_STORAGE_KEY, JSON.stringify(priceLists)); }
function saveHolidays() { localStorage.setItem(HOLIDAY_STORAGE_KEY, JSON.stringify(holidays)); }

function renderPriceLists() {
    const tableBody = document.getElementById('price-list-table-body');
    tableBody.innerHTML = '';
    if (Object.keys(priceLists).length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Chưa có bảng giá nào.</td></tr>';
        return;
    }
    for (const id in priceLists) {
        const list = priceLists[id];
        tableBody.insertAdjacentHTML('beforeend', `
            <tr>
                <td>${list.name}</td>
                <td>${new Intl.NumberFormat('vi-VN').format(list.basePrice)}đ</td>
                <td class="actions-cell">
                    <button class="btn-edit" onclick="setupPriceListModal('${id}')" title="Sửa"><i class="fa-solid fa-pencil-alt"></i></button>
                    <button class="btn-delete" onclick="deletePriceList('${id}')" title="Xóa"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>
        `);
    }
}

function renderHolidays() {
    const tableBody = document.getElementById('holiday-table-body');
    tableBody.innerHTML = '';
    if (holidays.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="2" style="text-align: center;">Chưa có ngày lễ nào được thêm.</td></tr>';
        return;
    }
    holidays.sort().forEach(date => {
        tableBody.insertAdjacentHTML('beforeend', `
            <tr>
                <td>${date}</td>
                <td class="actions-cell">
                    <button class="btn-delete" onclick="deleteHoliday('${date}', this)" title="Xóa"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>
        `);
    });
}

function setupPriceListModal(id = null) {
    priceListForm.reset();
    timeSlotsContainer.innerHTML = '';
    document.getElementById('price-list-id').value = '';
    if (id && priceLists[id]) {
        const list = priceLists[id];
        document.getElementById('price-list-modal-title').textContent = 'Chỉnh sửa Bảng giá';
        document.getElementById('price-list-id').value = id;
        document.getElementById('price-list-name').value = list.name;
        document.getElementById('base-price').value = list.basePrice;
        document.getElementById('weekend-multiplier').value = list.weekendMultiplier || 1.0;
        document.getElementById('holiday-multiplier').value = list.holidayMultiplier || 1.0;
        list.timeSlots.forEach(addTimeSlot);
    } else {
        document.getElementById('price-list-modal-title').textContent = 'Thêm Bảng giá mới';
    }
    openModal('price-list-modal');
}

function addTimeSlot(slot = { from: '', to: '', price: '' }) {
    const slotDiv = document.createElement('div');
    slotDiv.className = 'time-slot-item';
    slotDiv.style.cssText = 'display: flex; gap: 10px; align-items: center; margin-bottom: 10px;';
    slotDiv.innerHTML = `
        <input type="time" class="slot-from" value="${slot.from}" required style="flex: 1; padding: 8px;">
        <span>-</span>
        <input type="time" class="slot-to" value="${slot.to}" required style="flex: 1; padding: 8px;">
        <input type="number" class="slot-price" value="${slot.price}" placeholder="Giá/giờ" required style="flex: 1; padding: 8px;">
        <button type="button" class="btn-delete-section" style="font-size: 16px;">&times;</button>
    `;
    slotDiv.querySelector('.btn-delete-section').addEventListener('click', () => slotDiv.remove());
    timeSlotsContainer.appendChild(slotDiv);
}

document.getElementById('add-price-list-btn').addEventListener('click', () => setupPriceListModal());
document.getElementById('close-price-list-modal-btn').addEventListener('click', () => closeModal('price-list-modal'));
document.getElementById('add-time-slot-btn').addEventListener('click', () => addTimeSlot());

priceListForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const basePrice = parseFloat(document.getElementById('base-price').value);
    if (isNaN(basePrice) || basePrice < 0) {
        alert("Giá cơ bản không hợp lệ. Vui lòng nhập một số không âm.");
        return;
    }
    const timeSlots = [];
    let validationPassed = true;
    document.querySelectorAll('.time-slot-item').forEach(item => {
        if (!validationPassed) return;
        const from = item.querySelector('.slot-from').value;
        const to = item.querySelector('.slot-to').value;
        const price = parseFloat(item.querySelector('.slot-price').value);
        if (from >= to) {
            alert(`Lỗi khung giờ: Thời gian kết thúc (${to}) phải sau thời gian bắt đầu (${from}).`);
            validationPassed = false;
        }
        if (isNaN(price) || price < 0) {
            alert("Giá trong khung giờ đặc biệt không hợp lệ. Vui lòng nhập một số không âm.");
            validationPassed = false;
        }
        timeSlots.push({ from, to, price });
    });
    if (!validationPassed) return;

    const id = document.getElementById('price-list-id').value || `pl-${Date.now()}`;
    const name = document.getElementById('price-list-name').value;
    priceLists[id] = {
        name: name, basePrice: basePrice, timeSlots: timeSlots,
        weekendMultiplier: parseFloat(document.getElementById('weekend-multiplier').value) || 1.0,
        holidayMultiplier: parseFloat(document.getElementById('holiday-multiplier').value) || 1.0
    };
    savePriceLists();
    renderPriceLists();
    closeModal('price-list-modal');
});

window.deletePriceList = function(id) {
    if (confirm(`Bạn có chắc chắn muốn xóa bảng giá "${priceLists[id].name}"?`)) {
        delete priceLists[id];
        savePriceLists();
        renderPriceLists();
    }
}

holidayForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const dateInput = document.getElementById('holiday-date-input');
    const date = dateInput.value;
    if (date && !holidays.includes(date)) {
        holidays.push(date);
        saveHolidays();
        renderHolidays();
        dateInput.value = '';
    } else {
        alert('Ngày này đã tồn tại hoặc không hợp lệ.');
    }
});

window.deleteHoliday = function(date, buttonElement) {
    if (confirm(`Bạn có chắc muốn xóa ngày lễ ${date}?`)) {
        holidays = holidays.filter(h => h !== date);
        saveHolidays();
        buttonElement.closest('tr').remove();
    }
}
  // Dán toàn bộ đoạn mã này vào trong sự kiện DOMContentLoaded,
// ngay trước dòng }); cuối cùng

// =================================================================
// ===== BẮT ĐẦU: LOGIC QUẢN LÝ LOẠI CHI PHÍ (EXPENSE CATEGORIES) =====
// =================================================================
const EXPENSE_CATEGORIES_KEY = 'biaOxuExpenseCategories';

// Hàm lấy danh sách loại chi phí từ localStorage
function getExpenseCategories() {
    try {
        const categoriesJSON = localStorage.getItem(EXPENSE_CATEGORIES_KEY);
        // Thêm dữ liệu mẫu nếu chưa có
        if (!categoriesJSON) {
            const defaultCategories = [
                { id: `ec-${Date.now()}-1`, name: 'Chi phí mặt bằng' },
                { id: `ec-${Date.now()}-2`, name: 'Lương nhân viên' },
                { id: `ec-${Date.now()}-3`, name: 'Chi nhập kho (Đồ ăn/Nước uống)' },
                { id: `ec-${Date.now()}-4`, name: 'Chi phí Marketing' },
                { id: `ec-${Date.now()}-5`, name: 'Chi phí vận hành khác' }
            ];
            localStorage.setItem(EXPENSE_CATEGORIES_KEY, JSON.stringify(defaultCategories));
            return defaultCategories;
        }
        return JSON.parse(categoriesJSON);
    } catch (e) {
        console.error("Lỗi phân tích cú pháp dữ liệu loại chi phí:", e);
        return [];
    }
}

// Hàm lưu danh sách loại chi phí vào localStorage
function saveExpenseCategories(categories) {
    localStorage.setItem(EXPENSE_CATEGORIES_KEY, JSON.stringify(categories));
}

// Hàm hiển thị bảng loại chi phí
function renderExpenseCategoryTable() {
    const categories = getExpenseCategories();
    const tableBody = document.getElementById('expense-category-table-body');
    tableBody.innerHTML = '';
    if (categories.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Chưa có loại chi phí nào.</td></tr>';
        return;
    }
    categories.forEach((cat, index) => {
        const row = `
            <tr>
                <td>${index + 1}</td>
                <td>${cat.name}</td>
                <td class="actions-cell">
                    <button class="btn-edit" data-id="${cat.id}" title="Sửa"><i class="fa-solid fa-pencil-alt"></i></button>
                    <button class="btn-delete" data-id="${cat.id}" title="Xóa"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', row);
    });
}

// Hàm chuẩn bị và mở modal
function setupExpenseCategoryModal(mode, category = null) {
    const form = document.getElementById('expense-category-form');
    const modalTitle = document.getElementById('expense-category-modal-title');
    const messageEl = document.getElementById('expense-category-modal-message');
    form.reset();
    messageEl.textContent = '';
    document.getElementById('expense-category-id').value = '';

    if (mode === 'edit' && category) {
        modalTitle.textContent = 'Chỉnh sửa Loại chi phí';
        document.getElementById('expense-category-id').value = category.id;
        document.getElementById('expense-category-name').value = category.name;
    } else {
        modalTitle.textContent = 'Thêm Loại chi phí mới';
    }
    openModal('expense-category-modal');
}

// Lắng nghe sự kiện click trên các nút thêm/sửa/xóa
document.getElementById('add-expense-category-btn').addEventListener('click', () => {
    setupExpenseCategoryModal('add');
});

document.getElementById('close-expense-category-modal-btn').addEventListener('click', () => {
    closeModal('expense-category-modal');
});

document.getElementById('expense-category-table-body').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const categoryId = btn.dataset.id;
    const categories = getExpenseCategories();

    if (btn.classList.contains('btn-edit')) {
        const categoryToEdit = categories.find(cat => cat.id === categoryId);
        if (categoryToEdit) {
            setupExpenseCategoryModal('edit', categoryToEdit);
        }
    } else if (btn.classList.contains('btn-delete')) {
        if (confirm('Bạn có chắc chắn muốn xóa loại chi phí này?')) {
            const updatedCategories = categories.filter(cat => cat.id !== categoryId);
            saveExpenseCategories(updatedCategories);
            renderExpenseCategoryTable();
        }
    }
});

// Lắng nghe sự kiện submit form
document.getElementById('expense-category-form').addEventListener('submit', (e) => {
    e.preventDefault();
    let categories = getExpenseCategories();
    const id = document.getElementById('expense-category-id').value;
    const name = document.getElementById('expense-category-name').value.trim();
    const messageEl = document.getElementById('expense-category-modal-message');

    if (!name) {
        messageEl.textContent = 'Tên loại chi phí không được để trống.';
        return;
    }

    // Kiểm tra tên trùng lặp
    const isDuplicate = categories.some(cat => cat.name.toLowerCase() === name.toLowerCase() && cat.id !== id);
    if (isDuplicate) {
        messageEl.textContent = 'Tên loại chi phí này đã tồn tại.';
        return;
    }

    if (id) { // Chế độ sửa
        const categoryIndex = categories.findIndex(cat => cat.id === id);
        if (categoryIndex > -1) {
            categories[categoryIndex].name = name;
        }
    } else { // Chế độ thêm mới
        const newCategory = {
            id: `ec-${Date.now()}`,
            name: name
        };
        categories.push(newCategory);
    }

    saveExpenseCategories(categories);
    renderExpenseCategoryTable();
    closeModal('expense-category-modal');
});

// ===============================================================
// ===== KẾT THÚC: LOGIC QUẢN LÝ LOẠI CHI PHÍ (EXPENSE CATEGORIES) =====
// ===============================================================
    </script>
</body>
</html>