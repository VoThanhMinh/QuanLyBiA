<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo Khách hàng - BI-A OXU</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <style>
        :root {
            --primary-color: #0d47a1; --secondary-color: #1976d2; --text-color: #333;
            --light-text-color: #f0f4f8; --background-color: #eef2f6; --card-background: #ffffff;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08); --shadow-dark: 0 2px 10px rgba(0, 0, 0, 0.15);
            --success-color: #2e7d32; --warning-color: #ed6c02; --danger-color: #d32f2f;
            --border-color: #e0e0e0;
        }
        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        
        /* HEADER, NAV, FOOTER (Đồng bộ) */
        .main-header { background-color: var(--card-background); box-shadow: var(--shadow-light); height: 70px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; z-index: 100; }
        .main-header .app-name { font-size: 24px; font-weight: 600; color: var(--primary-color); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .main-header .app-name i { color: var(--secondary-color); }
        .main-nav ul { list-style: none; margin: 0; padding: 0; display: flex; align-items: center; }
        .main-nav li { position: relative; margin: 0 5px; }
        .main-nav a { text-decoration: none; color: var(--text-color); padding: 12px 18px; display: flex; align-items: center; gap: 10px; font-size: 15px; font-weight: 500; border-radius: 8px; transition: all 0.3s ease; }
        .main-nav a i { font-size: 18px; color: var(--secondary-color); }
        .main-nav a:hover, .main-nav li.active > a { background-color: var(--background-color); color: var(--primary-color); }
        .main-nav li.active > a i { color: var(--primary-color); }
        .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; background-color: var(--card-background); border-radius: 8px; box-shadow: var(--shadow-dark); min-width: 240px; z-index: 99; list-style: none; padding: 10px 0; margin-top: 10px; transform: translateY(10px); opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .has-dropdown:hover .dropdown-menu { display: block; transform: translateY(0); opacity: 1; visibility: visible; }
        .dropdown-menu a { padding: 12px 20px; border-radius: 0; }
        .dropdown-menu a.active { background-color: var(--background-color); color: var(--primary-color); }
        .dropdown-menu a i { font-size: 16px; }
        .main-footer { background-color: var(--primary-color); color: var(--light-text-color); padding: 20px 30px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1); }
        .footer-info, .user-info { display: flex; gap: 25px; }
        .main-footer i { margin-right: 5px; }
        
        /* MAIN CONTENT AREA (Đồng bộ) */
        .content-wrapper { flex: 1; padding: 20px; }
        .report-container { width: 100%; display: flex; flex-direction: column; gap: 20px; }
        
        /* BỘ LỌC NGÀY THÁNG (Đồng bộ) */
        .report-filters { background: var(--card-background); padding: 15px 20px; border-radius: 12px; box-shadow: var(--shadow-light); display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
        .report-filters label { font-weight: 500; color: #555; }
        .report-filters input[type="date"] { padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); font-family: 'Poppins', sans-serif; font-size: 15px; min-width: 150px; }
        .report-filters .date-quick-filters { display: flex; gap: 10px; margin-left: 10px; border-left: 1px solid var(--border-color); padding-left: 20px; }
        .report-filters .quick-filter-btn { padding: 6px 14px; font-size: 14px; border: 1px solid var(--border-color); background-color: #fff; color: var(--text-color); border-radius: 20px; cursor: pointer; transition: all 0.2s ease; font-family: 'Poppins', sans-serif; }
        .report-filters .quick-filter-btn:hover { background-color: var(--background-color); border-color: var(--secondary-color); }
        .report-filters .quick-filter-btn.active { background-color: var(--primary-color); color: var(--light-text-color); border-color: var(--primary-color); font-weight: 500; }
        
        .report-main { background: var(--card-background); padding: 30px; border-radius: 12px; box-shadow: var(--shadow-light); flex-grow: 1; }
        .report-main h2 { color: var(--primary-color); margin-top: 0; font-size: 24px; }

        /* KPI & WIDGETS (Đồng bộ) */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background-color: var(--background-color); padding: 25px; border-radius: 12px; display: flex; align-items: center; gap: 20px; }
        .kpi-card .icon { font-size: 32px; padding: 15px; border-radius: 50%; color: white; }
        .kpi-card .icon.total { background-color: var(--primary-color); }
        .kpi-card .icon.new { background-color: var(--success-color); }
        .kpi-card .icon.hibernating { background-color: var(--warning-color); }
        .kpi-card .info .value { font-size: 28px; font-weight: 700; color: var(--text-color); }
        .kpi-card .info .title { font-size: 15px; color: #666; }
        
        .report-grid { display: grid; grid-template-columns: 1fr 1.2fr; gap: 30px; }
        .report-widget { background-color: #fdfdfd; padding: 20px; border-radius: 12px; border: 1px solid #eee; }
        .report-widget h3 { margin-top: 0; color: var(--secondary-color); font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table th, .data-table td { padding: 10px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .data-table th { font-weight: 600; }
        .data-table td.rank { font-weight: 700; color: var(--primary-color); }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="main-header">
            <a href="index.html" class="app-name"><i class="fa-solid fa-gem"></i> BI-A </a>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class="fa-solid fa-chart-line"></i> Trang chủ</a></li>
                    <li class="has-dropdown">
                        <a href="#"><i class="fa-solid fa-boxes-stacked"></i> Quản lý</a>
                        <ul class="dropdown-menu">
                            <li><a href="quanly_ban.html"><i class="fa-solid fa-table-tennis-paddle-ball"></i> Quản lý bàn</a></li>
                            <li><a href="quanly_khachhang.html"><i class="fa-solid fa-address-book"></i> Quản lý Khách hàng</a></li>
                            <li><a href="quanly_datban.html"><i class="fa-solid fa-calendar-check"></i> Quản lý Đặt bàn</a></li>
                            <li><a href="quanly_thuchi.html"><i class="fa-solid fa-cash-register"></i> Quản lý thu chi</a></li>
                            <li><a href="quanly_kho.html"><i class="fa-solid fa-box-open"></i> Quản lý kho</a></li>
                            <li><a href="quanly_nhanvien.html"><i class="fa-solid fa-users"></i> Quản lý nhân viên</a></li>
                        </ul>
                    </li>
                    <li class="has-dropdown active">
                        <a href="#"><i class="fa-solid fa-chart-pie"></i> Báo cáo</a>
                        <ul class="dropdown-menu">
                            <li><a href="baocao_doanhthu.html"><i class="fa-solid fa-file-invoice"></i> Doanh thu ngày</a></li>
                            <li><a href="baocao_thongke.html"><i class="fa-solid fa-chart-bar"></i> Thống kê tuần</a></li>
                            <li><a href="baocao_loinhuan.html"><i class="fa-solid fa-file-contract"></i> Báo cáo nhân viên</a></li>
                            <li><a href="baocao_khachhang.html" class="active"><i class="fa-solid fa-user-tag"></i> Phân tích Khách hàng</a></li>
                        </ul>
                    </li>
                    <li><a href="cai_dat.html"><i class="fa-solid fa-gear"></i> Cài đặt</a></li>
                    <li><a href="tro_giup.html"><i class="fa-solid fa-circle-question"></i> Trợ giúp</a></li>
                    <li><a href="#" id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a></li>
                </ul>
            </nav>
        </header>

        <div class="content-wrapper">
            <div class="report-container">
                <div class="report-filters">
                    <label for="start-date">Từ ngày:</label>
                    <input type="date" id="start-date">
                    <label for="end-date">Đến ngày:</label>
                    <input type="date" id="end-date">
                    <div class="date-quick-filters">
                        <button class="quick-filter-btn" data-range="today">Hôm nay</button>
                        <button class="quick-filter-btn" data-range="yesterday">Hôm qua</button>
                        <button class="quick-filter-btn" data-range="last7days">7 ngày qua</button>
                        <button class="quick-filter-btn active" data-range="this_month">Tháng này</button>
                        <button class="quick-filter-btn" data-range="last_3_months">3 tháng qua</button>
                        <button class="quick-filter-btn" data-range="all">Toàn bộ</button>
                    </div>
                </div>

                <div class="report-main">
                    <h2><i class="fa-solid fa-user-tag"></i> Báo cáo & Phân tích Khách hàng</h2>
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="icon total"><i class="fa-solid fa-users"></i></div>
                            <div class="info">
                                <div id="total-customers" class="value">0</div>
                                <div class="title">Tổng số khách hàng</div>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="icon new"><i class="fa-solid fa-user-plus"></i></div>
                            <div class="info">
                                <div id="new-customers" class="value">0</div>
                                <div class="title">Khách hàng mới</div>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="icon hibernating"><i class="fa-solid fa-bed"></i></div>
                            <div class="info">
                                <div id="hibernating-customers" class="value">0</div>
                                <div class="title">Khách hàng "ngủ đông"</div>
                            </div>
                        </div>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--background-color);">

                    <div class="report-grid">
                        <div class="report-widget">
                            <h3>Phân loại Hạng thành viên</h3>
                            <canvas id="tierChart" style="max-height: 300px;"></canvas>
                        </div>
                        <div class="report-widget">
                            <h3>Top 10 Khách hàng Chi tiêu Cao nhất</h3>
                            <table class="data-table">
                                <thead><tr><th>#</th><th>Tên</th><th>Tổng chi tiêu</th></tr></thead>
                                <tbody id="top-spending-table"></tbody>
                            </table>
                            <h3 style="margin-top: 20px;">Top 10 Khách hàng Thường xuyên nhất</h3>
                            <table class="data-table">
                                <thead><tr><th>#</th><th>Tên</th><th>Số lượt đến</th></tr></thead>
                                <tbody id="top-visits-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="main-footer">
            <div class="footer-info">
               <span class="copyright-info"><i class="fa-solid fa-copyright"></i> 2025 BI-A OXU. All rights reserved.</span>
               <span class="phone-info"><i class="fa-solid fa-phone"></i> Hotline: </span>
           </div>
           <div class="user-info">
               <span id="footer-username"><i class="fa-solid fa-user"></i> Người dùng: </span>
               <span><i class="fa-solid fa-circle-check"></i> Trạng thái: OK</span>
           </div>
       </footer>
    </div>

     <script>
    // *** BẢO VỆ TRANG: KIỂM TRA QUYỀN TRUY CẬP ***
    (function() {
        // ID định danh cho chức năng của trang này
        const PAGE_FEATURE_ID = 'baocao_khachhang'; 

        const userRole = sessionStorage.getItem('userRole');
        if (userRole === 'user') {
            try {
                const permissions = JSON.parse(localStorage.getItem('biaOxuUserPermissions')) || {};
                // Kiểm tra xem người dùng có quyền 'access' (truy cập) vào chức năng này không
                const hasAccess = permissions[PAGE_FEATURE_ID] && permissions[PAGE_FEATURE_ID].access === true;
                
                if (!hasAccess) {
                    document.body.style.display = 'none'; 
                    alert('Bạn không có quyền truy cập chức năng này.');
                    window.location.href = 'index.html';
                }
            } catch (e) { 
                console.error("Lỗi phân tích cú pháp dữ liệu phân quyền:", e);
                window.location.href = 'index.html';
            }
        }
    })();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- LOGIC CHUNG CHO HEADER/FOOTER ---
    const loggedInUser = sessionStorage.getItem('loggedInUser');
    if (loggedInUser) {
        document.getElementById('footer-username').innerHTML = `<i class="fa-solid fa-user"></i> Người dùng: ${loggedInUser}`;
    }
    function updateStoreInfo() {
        const savedData = localStorage.getItem('general-form');
        if (savedData) {
            const settings = JSON.parse(savedData);
            const storeName = settings['store-name'] || 'BI-A OXU';
            const phone = settings.phone || '';
            document.querySelector('.main-header .app-name').innerHTML = `<i class="fa-solid fa-gem"></i> ${storeName}`;
            document.querySelector('.main-footer .phone-info').innerHTML = `<i class="fa-solid fa-phone"></i> Hotline: ${phone}`;
            document.querySelector('.main-footer .copyright-info').innerHTML = `<i class="fa-solid fa-copyright"></i> 2025 ${storeName}. All rights reserved.`;
        }
    }
    updateStoreInfo();
    document.getElementById('logout-btn').addEventListener('click', (e) => {
        e.preventDefault(); sessionStorage.clear(); window.location.href = 'login.html';
    });

    // --- CÁC HẰNG SỐ VÀ BIẾN TOÀN CỤC ---
    const CUSTOMERS_KEY = 'biaOxuCustomers';
    const BILLS_KEY = 'biaOxuSavedBills';
    const TIERS_KEY = 'biaOxuMembershipTiers';

    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const quickFilterBtns = document.querySelectorAll('.quick-filter-btn');
    let tierChartInstance = null;

    // --- CÁC HÀM LẤY VÀ XỬ LÝ DỮ LIỆU ---
    function loadData(key) {
        try { return JSON.parse(localStorage.getItem(key)) || []; } 
        catch (e) { console.error(`Lỗi tải dữ liệu từ key: ${key}`, e); return []; }
    }
    
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount || 0) + 'đ';
    }
    
    function analyzeCustomerData() {
        const customers = loadData(CUSTOMERS_KEY);
        const bills = loadData(BILLS_KEY);
        const tiers = loadData(TIERS_KEY);
        
        const startDate = new Date(startDateInput.value);
        startDate.setHours(0,0,0,0);
        const endDate = new Date(endDateInput.value);
        endDate.setHours(23,59,59,999);
        
        const inactiveDate = new Date();
        inactiveDate.setMonth(new Date().getMonth() - 3);

        let customerStats = {};
        customers.forEach(c => {
            customerStats[c.id] = { ...c, bills: [], firstVisit: null, lastVisit: null };
        });

        bills.forEach(bill => {
            if (bill.customerId && customerStats[bill.customerId]) {
                const billDate = new Date(bill.endTime);
                customerStats[bill.customerId].bills.push(bill);
                if (!customerStats[bill.customerId].lastVisit || billDate > customerStats[bill.customerId].lastVisit) {
                    customerStats[bill.customerId].lastVisit = billDate;
                }
            }
        });
        
        const newCustomers = Object.values(customerStats).filter(c => {
             const firstBill = c.bills.sort((a,b) => a.endTime - b.endTime)[0];
             return firstBill && new Date(firstBill.endTime) >= startDate && new Date(firstBill.endTime) <= endDate;
        }).length;
        
        const hibernatingCustomers = Object.values(customerStats).filter(
            c => c.bills.length > 0 && c.lastVisit && c.lastVisit < inactiveDate
        ).length;

        const defaultTier = { id: 'default', name: 'Thường' };
        const allTiers = [defaultTier, ...tiers];
        const tierMap = allTiers.reduce((map, tier) => { map[tier.id] = { name: tier.name, count: 0 }; return map; }, {});
        customers.forEach(c => {
            const tierId = c.membershipTierId || 'default';
            if (tierMap[tierId]) tierMap[tierId].count++;
        });
        
        const topSpending = [...customers].sort((a,b) => (b.totalSpent || 0) - (a.totalSpent || 0)).slice(0, 10);
        const topVisits = [...customers].sort((a,b) => (b.visitCount || 0) - (a.visitCount || 0)).slice(0, 10);

        updateKpiCards(customers.length, newCustomers, hibernatingCustomers);
        renderTierChart(tierMap);
        renderTopCustomerTable('top-spending-table', topSpending, 'totalSpent');
        renderTopCustomerTable('top-visits-table', topVisits, 'visitCount');
    }

    function updateKpiCards(total, newly, hibernating) {
        document.getElementById('total-customers').textContent = total;
        document.getElementById('new-customers').textContent = newly;
        document.getElementById('hibernating-customers').textContent = hibernating;
    }

    function renderTierChart(tierMap) {
        const ctx = document.getElementById('tierChart').getContext('2d');
        const labels = Object.values(tierMap).map(t => t.name);
        const data = Object.values(tierMap).map(t => t.count);
        if (tierChartInstance) tierChartInstance.destroy();
        tierChartInstance = new Chart(ctx, { type: 'pie', data: { labels: labels, datasets: [{ label: 'Số lượng khách hàng', data: data, backgroundColor: ['#1976d2', '#42a5f5', '#90caf9', '#e3f2fd', '#ffca28', '#ffa726'], borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (context) => `${context.label}: ${context.raw} khách hàng` } } } } });
    }

    function renderTopCustomerTable(tableId, data, metricKey) {
        const tableBody = document.getElementById(tableId);
        tableBody.innerHTML = '';
        if (data.length === 0) { tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Không có dữ liệu.</td></tr>'; return; }
        data.forEach((customer, index) => {
            const metricValue = metricKey === 'totalSpent' ? formatCurrency(customer[metricKey]) : `${(customer[metricKey] || 0)} <i class="fa-solid fa-user-check" style="color: #888;"></i>`;
            tableBody.insertAdjacentHTML('beforeend', `<tr><td class="rank">${index + 1}</td><td>${customer.name}</td><td><strong>${metricValue}</strong></td></tr>`);
        });
    }

    function setDateRange(range) {
        const today = new Date();
        let start = new Date();
        let end = new Date();

        switch (range) {
            case 'today': break;
            case 'yesterday': start.setDate(today.getDate() - 1); end.setDate(today.getDate() - 1); break;
            case 'last7days': start.setDate(today.getDate() - 6); break;
            case 'this_month': start = new Date(today.getFullYear(), today.getMonth(), 1); break;
            case 'last_3_months': start = new Date(); start.setMonth(today.getMonth() - 3); break;
            case 'all': start = new Date('2020-01-01'); break; // Set a very early date for "all time"
        }
        startDateInput.valueAsDate = start;
        endDateInput.valueAsDate = end;
    }

    quickFilterBtns.forEach(button => {
        button.addEventListener('click', () => {
            quickFilterBtns.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            setDateRange(button.dataset.range);
            analyzeCustomerData();
        });
    });
    
    const deactivateQuickFilters = () => quickFilterBtns.forEach(btn => btn.classList.remove('active'));
    startDateInput.addEventListener('input', () => { deactivateQuickFilters(); analyzeCustomerData(); });
    endDateInput.addEventListener('input', () => { deactivateQuickFilters(); analyzeCustomerData(); });

    // Khởi tạo trang, tự động click vào nút "Tháng này"
    document.querySelector('.quick-filter-btn[data-range="this_month"]').click();
});
</script>
</body>
</html>